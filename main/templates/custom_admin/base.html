{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
        background: #fff;
        color: #222;
        max-height: 100vh;
        overflow: hidden;
    }
    .navbar {
        background: #222;
        padding: 1rem;
        margin-bottom: 0;
        border-radius: 0;
        position: relative;
        z-index: 1;
    }
    .back-btn {
        color: #fff;
        font-size: 1.3rem;
        margin-right: 1.2rem;
        cursor: pointer;
        transition: color 0.2s;
        border: none;
        background: none;
        outline: none;
    }
    .back-btn:hover {
        color: #AD974F;
    }
    .container-fluid {
        padding-left: 0;
        padding-right: 0;
    }
    .row {
        margin-left: 0;
        margin-right: 0;
    }
    .sidebar {
        min-height: 100vh;
        background: #222;
        color: #fff;
        position: relative;
        z-index: 1;
        padding-top: 0;
    }
    .sidebar h3 {
        margin-top: 1.5rem;
    }
    .sidebar a {
        color: #fff;
        text-decoration: none;
        transition: all 0.3s;
    }
    .sidebar a:hover {
        color: #AD974F;
    }
    .content {
        padding: 20px;
        position: relative;
        z-index: 1;
    }
    .navbar-brand {
        color: #fff !important;
        font-size: 1.5rem;
    }
    .nav-link {
        color: #fff !important;
    }
    .nav-link:hover {
        color: #AD974F !important;
    }
    .logout-btn {
        color: #fff !important;
        border: 1px solid #fff;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.3s;
        margin-left: 1rem;
    }
    .logout-btn:hover {
        background-color: #fff;
        color: #222 !important;
    }
    .notification-btn {
        color: #fff !important;
        padding: 0.5rem;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.3s;
        position: relative;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
    }
    .notification-btn:hover {
        color: #AD974F !important;
        border-color: #AD974F;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #AD974F;
        color: #fff;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .notification-modal .modal-content {
        background: #fff;
        border-radius: 10px;
        border: none;
    }
    .notification-modal .modal-header {
        background: #AD974F;
        color: #fff;
        border-radius: 10px 10px 0 0;
    }
    .notification-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    .notification-item:hover {
        background: #f8f9fa;
    }
    .notification-item:last-child {
        border-bottom: none;
    }
    .notification-icon {
        width: 40px;
        height: 40px;
        background: #AD974F;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .notification-content {
        flex-grow: 1;
        min-width: 0; /* Allows flexbox item to shrink */
        overflow: hidden;
    }
    .notification-title {
        font-weight: 600;
        color: #222;
        margin-bottom: 5px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    .notification-text {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
    }
    .notification-time {
        color: #999;
        font-size: 12px;
    }
    .alert {
        position: relative;
        z-index: 1;
    }
    .card {
        background: #f8f9fa;
        border: 1px solid #eee;
        box-shadow: 0 8px 32px rgba(0,0,0,0.05);
        color: #222;
    }
    .card-header {
        background: #f8f9fa;
        color: #222;
        border-bottom: 1px solid #eee;
    }
    .table {
        color: #222;
    }
    .table th {
        color: #222;
        border-bottom: 1px solid #eee;
    }
    .table td {
        border-bottom: 1px solid #eee;
    }
    .btn-primary {
        background-color: #AD974F;
        border-color: #AD974F;
        color: #fff;
    }
    .btn-primary:hover {
        background-color: #8c7a3e;
        border-color: #8c7a3e;
        color: #fff;
    }
    #chat-sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100%;
        background-color: #222;
        color: #fff;
        transition: right 0.3s ease-in-out;
        z-index: 1050;
        display: flex;
        flex-direction: column;
    }
    #chat-sidebar.open {
        right: 0;
    }
    .chat-header {
        padding: 10px;
        background-color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-header h4 {
        margin: 0;
        color: #fff;
    }
    .chat-body {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
    }
    .chat-footer {
        padding: 10px;
        background-color: #333;
        display: flex;
        align-items: center;
    }
    .chat-footer input[type="text"] {
        flex-grow: 1;
        margin-right: 10px;
        padding: 5px;
        border: none;
        border-radius: 3px;
    }
    #chat-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    .content-scroll {
      height: calc(100vh - 60px);
      overflow-y: auto;
      padding: 20px;
    }

  </style>
</head>
<body>
<nav class="navbar">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      {% if request.resolver_match.url_name != 'admin_dashboard' %}
      <a class="back-btn" href="{% url 'admin_dashboard' %}" title="Back to Dashboard">
        <i class="fas fa-arrow-left"></i>
      </a>
      {% endif %}
      <a class="navbar-brand" href="{% url 'admin_dashboard' %}">
        <i class="fas fa-user-shield"></i> Admin Dashboard
      </a>
    </div>
    <div class="d-flex align-items-center">
      <!-- Notification Button -->
      <button class="notification-btn" data-bs-toggle="modal" data-bs-target="#notificationModal">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
      </button>
      
      <a href="{% url 'logout' %}" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-auto sidebar p-3">
      <h3 class="mb-4">Admin Panel</h3>
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a href="{% url 'admin_dashboard' %}"><i class="fas fa-home"></i> Dashboard</a></li>
        {% comment %} <li class="nav-item mb-2"><a href="{% url 'create_event' %}"><i class="fas fa-plus"></i> Create Event</a></li>
        <li class="nav-item mb-2"><a href="{% url 'view_all_moderators' %}"><i class="fas fa-user-tie"></i> View Moderators</a></li> {% endcomment %}
        <li class="nav-item mb-2"><a href="{% url 'view_all_users' %}"><i class="fas fa-users"></i> View All Users</a></li>
        <li class="nav-item mb-2"><a href="{% url 'event_history' %}"><i class="fas fa-history"></i> View Event History</a></li>
        <li class="nav-item mb-2"><a href="{% url 'admin_edit' %}"><i class="fas fa-user-cog"></i> Edit Admin Profile</a></li>
        <li class="nav-item mb-2"><a href="{% url 'review_list' %}"><i class="fas fa-star"></i> Review Management</a></li>
        <li class="nav-item mb-2"><a href="{% url 'mobile_post_list' %}"><i class="fas fa-newspaper"></i> Posts</a></li>
        <li class="nav-item mb-2"><a href="{% url 'request_bookings' %}"><i class="fas fa-book"></i> Booking Requests</a></li>
        <li class="nav-item mb-2"><a href="{% url 'send_notification_to_user' %}"><i class="fas fa-bell"></i> Send User Notification</a></li>
        <li class="nav-item mb-2"><a href="{% url 'send_notification_to_all_users' %}"><i class="fas fa-broadcast-tower"></i> Broadcast to All Users</a></li>
      </ul>
    </div>
    <div class="col content-scroll">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% block content %}{% endblock %}
    </div>

  </div>
</div>
{% comment %} 
<div id="chat-sidebar">
  <div class="chat-header">
    <h4>Chat Log</h4>
    <button id="close-chat" class="btn btn-link text-white"><i class="fas fa-times"></i></button>
  </div>
  <div class="chat-body"><p>Loading…</p></div>
  <div class="chat-footer">
    <input type="text" placeholder="Type a message..." disabled>
    <button class="btn btn-primary" disabled><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<button id="chat-toggle" class="btn btn-primary"><i class="fas fa-comments"></i> Chat</button> {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const chatToggle  = document.getElementById('chat-toggle');
const chatSidebar = document.getElementById('chat-sidebar');
const closeChat   = document.getElementById('close-chat');

if (chatToggle && chatSidebar) {
  chatToggle.addEventListener('click', () => chatSidebar.classList.add('open'));
}
if (closeChat && chatSidebar) {
  closeChat.addEventListener('click', () => chatSidebar.classList.remove('open'));
}
</script>
{% comment %} <script>
(async () => {
  const sidebar = document.getElementById("chat-sidebar");
  const logBox  = sidebar.querySelector(".chat-body");

  function addLine(obj){
    const div = document.createElement("div");
    div.innerHTML = `
      <strong>${obj.client_name}</strong><br>
      <em>${obj.event_type} – ${obj.event_date}</em><br>
      <hr>`;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }

  try {
    const res = await fetch("/admin/load-chats", {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    });
    const history = await res.json();
    logBox.innerHTML = ""; // clear "Loading…" message
    history.reverse().forEach(addLine);
  } catch(e) {
    console.error("History load failed:", e);
    logBox.innerHTML = "<p class='text-danger'>Could not load chat list.</p>";
  }

  // Optional SSE listener for real-time messages (keep if applicable)
  const es = new EventSource("/admin/bookings/stream/");
  es.onmessage = e => {
    try { 
      const payload = JSON.parse(e.data);
      if (payload.sender && payload.message) {
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${payload.sender}</strong><br>
          <em>${payload.booking}</em><br>
          ${payload.message}
          <hr>`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
      }
    } catch(err){
      console.warn("Bad SSE payload", err);
    }
  };
  es.onerror = () => console.warn("SSE disconnected…");
})();
</script> {% endcomment %}

<!-- Notification Modal -->
<div class="modal fade notification-modal" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">
          <i class="fas fa-bell"></i> Notifications
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="notificationList" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
          <div class="text-center p-4 text-muted">
            <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
            <p>No new notifications</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn" style="background: #AD974F; color: white;" onclick="markAllAsRead()">
          Mark All as Read
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Notification JavaScript -->
<script>
let notificationCount = 0;
let notifications = [];

// Initialize notification system
document.addEventListener('DOMContentLoaded', function() {
  loadNotifications();
  setupRealtimeNotifications();
});

function loadNotifications() {
  fetch('/admin/notifications/')
    .then(response => response.json())
    .then(data => {
      notifications = data.notifications;
      updateNotificationUI();
    })
    .catch(err => console.error('Error loading notifications:', err));
}

function updateNotificationUI() {
  const badge = document.getElementById('notificationBadge');
  const list = document.getElementById('notificationList');
  
  const unreadCount = notifications.filter(n => !n.is_read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
  
  if (notifications.length === 0) {
    list.innerHTML = `
      <div class="text-center p-4 text-muted">
        <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
        <p>No new notifications</p>
      </div>
    `;
  } else {
    list.innerHTML = notifications.map(notification => {
      // Determine icon based on notification type
      let icon = 'fas fa-user-plus'; // default for booking
      if (notification.notification_type === 'message_received') {
        icon = 'fas fa-comment';
      } else if (notification.notification_type === 'payment_received') {
        icon = 'fas fa-credit-card';
      }
      
      return `
        <div class="notification-item d-flex ${notification.is_read ? '' : 'bg-light'}" 
             data-id="${notification.id}" 
             data-booking-id="${notification.booking_id || ''}"
             data-user-id="${notification.user_id || ''}"
             data-notification-type="${notification.notification_type || 'new_booking'}"
             onclick="handleNotificationClick(this)"
             style="cursor: pointer; transition: all 0.2s ease;">
          <div class="notification-icon">
            <i class="${icon}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-text">${notification.message}</div>
            <div class="notification-time">${notification.created_at}</div>
          </div>
          ${!notification.is_read ? '<div class="text-primary"><i class="fas fa-circle" style="font-size: 8px;"></i></div>' : ''}
        </div>
      `;
    }).join('');
  }
}

function addNotification(data) {
  notifications.unshift({
    id: data.id,
    title: data.title,
    message: data.message,
    created_at: data.created_at,
    booking_id: data.booking_id,
    user_id: data.user_id,
    notification_type: data.type === 'new_message' ? 'message_received' : (data.type === 'payment_received' ? 'payment_received' : 'new_booking'),
    is_read: false
  });
  updateNotificationUI();
  
  // Show toast notification
  showToast(data.title, data.message);
}

function showToast(title, message) {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: #AD974F;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    max-width: 350px;
    animation: slideIn 0.3s ease-out;
  `;
  
  toast.innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${title}</div>
    <div style="font-size: 14px; opacity: 0.9;">${message}</div>
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 5 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 5000);
}

function markAllAsRead() {
  fetch('/admin/notifications/mark-all-read/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      notifications.forEach(n => n.is_read = true);
      updateNotificationUI();
    }
  })
  .catch(err => console.error('Error marking notifications as read:', err));
}

function setupRealtimeNotifications() {
  // Use Server-Sent Events for real-time notifications
  const eventSource = new EventSource('/admin/notifications/stream/');
  
  eventSource.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'new_booking' || data.type === 'new_message' || data.type === 'payment_received') {
        addNotification(data);
      }
    } catch (err) {
      console.error('Error parsing notification data:', err);
    }
  };
  
  eventSource.onerror = function(event) {
    console.warn('Notification stream error:', event);
  };
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  .notification-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
  }
`;
document.head.appendChild(style);

// Handle notification click to navigate to booking or chat
function handleNotificationClick(element) {
  const bookingId = element.getAttribute('data-booking-id');
  const notificationId = element.getAttribute('data-id');
  const notificationType = element.getAttribute('data-notification-type');
  
  // Mark notification as read immediately
  markNotificationAsReadOnServer(notificationId);
  markNotificationAsRead(notificationId);
  
  // Close the modal first
  const modal = bootstrap.Modal.getInstance(document.getElementById('notificationModal'));
  if (modal) {
    modal.hide();
  }
  
  // Handle different notification types
  if (notificationType === 'message_received') {
    // For message notifications, navigate to chat
    if (bookingId && bookingId !== 'null' && bookingId !== '') {
      // Navigate to booking chat
      window.location.href = `/admin/request-bookings/?booking=${bookingId}`;
    } else {
      // For general chat messages, you might want to navigate to a general chat page
      // For now, we'll just close the modal or navigate to a chat list
      console.log('Message notification without booking context');
    }
  } else if (bookingId && bookingId !== 'null' && bookingId !== '') {
    // For booking notifications, navigate to booking requests page
    window.location.href = `/admin/request-bookings/?booking=${bookingId}`;
  }
}

function markNotificationAsRead(notificationId) {
  // Update the notification visually
  const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
  if (notificationElement) {
    notificationElement.classList.remove('bg-light');
    const unreadIndicator = notificationElement.querySelector('.text-primary');
    if (unreadIndicator) {
      unreadIndicator.remove();
    }
  }
  
  // Update the notifications array
  const notification = notifications.find(n => n.id == notificationId);
  if (notification) {
    notification.is_read = true;
  }
  
  // Update badge count
  updateNotificationUI();
}

function markNotificationAsReadOnServer(notificationId) {
  fetch(`/admin/notifications/${notificationId}/mark-read/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Notification marked as read on server');
    }
  })
  .catch(err => console.error('Error marking notification as read:', err));
}

function getCsrfToken() {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    return csrfToken.value;
  }
  // Fallback: get from cookie
  const name = 'csrftoken';
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

</body>
</html>
