{% extends 'custom_admin/base.html' %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Admin Dashboard</h2>
        </div>
        {% comment %} <div class="col text-end">
            <a href="{% url 'create_event' %}" class="btn btn-primary" style="background-color: #AD974F; border-color: #AD974F;">
                <i class="fas fa-plus"></i> Create Event
            </a>
        </div> {% endcomment %}
    </div>


    <div class="row mb-4">
        <div class="col-md-3 d-flex align-items-stretch">
            <div class="card bg-primary text-white w-100 mb-3">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title">Total Events</h5>
                    <h2 class="card-text">{{ events.count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 d-flex align-items-stretch">
            <div class="card bg-success text-white w-100 mb-3">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title">Total Booking Requests</h5>
                    <h2 class="card-text">{{ total_bookings }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 d-flex align-items-stretch">
            <div class="card bg-warning text-dark w-100 mb-3">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title">Pending Booking Requests</h5>
                    <h2 class="card-text">{{ pending_bookings }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 d-flex align-items-stretch">
            <div class="card bg-info text-white w-100 mb-3">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title">Total Users</h5>
                    <h2 class="card-text">{{ total_users }}</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-calendar"></i> Events</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Actions</th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                                {% for event in events %}
                                                <tr>
                                                        <td>{{ event.title }}</td>
                                                        <td>{{ event.date }}</td>
                                                        <td>{{ event.description }}</td>
                                                        <td>
                                                                <button type="button" class="btn btn-info btn-sm me-2" onclick="showBookingSummary({{ event.booking.id }})">
                                                                        <i class="fas fa-eye"></i> View
                                                                </button>
                                                                <a href="{% url 'event_edit' event.id %}" class="btn btn-primary btn-sm me-2">
                                                                        <i class="fas fa-edit"></i> Edit
                                                                </a>
                                                                <form method="post" action="{% url 'delete_event' event.id %}" style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to remove this event?');">
                                                                                <i class="fas fa-trash"></i> Remove
                                                                        </button>
                                                                </form>

                                                        </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                        <td colspan="4" class="text-center py-4">
                                                                <i class="fas fa-info-circle"></i> No events found
                                                        </td>
                                                </tr>
                                                {% endfor %}
                                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal - Popup Modal with bookhere.html content -->
<div class="modal fade" id="bookingSummaryModal" tabindex="-1" aria-labelledby="bookingSummaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookingSummaryModalLabel">Booking Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Booking Summary Section - Modal Version -->
        <div class="summary-container" style="display: flex; gap: 2rem; margin: 0;">
          <!-- Left column: Event Details -->
          <div class="event-details" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0;">
            <div id="booking-summary-content">
              <!-- Summary content will be generated by JavaScript -->
            </div>
          </div>

          <!-- Right column: Receipt -->
          <div class="booking-receipt" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0; height: fit-content;">
            <div id="booking-receipt">
              <!-- Export PDF Button -->
              <button type="button" id="export-pdf-btn" class="export-btn">
                ðŸ“„ Export PDF
              </button>
              
              <!-- Receipt content will be generated by JavaScript -->
              <div id="receipt-content">
                <!-- Receipt will be generated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add export button styling -->
<style>
.export-btn {
  background: linear-gradient(135deg, #AD974F 0%, #8B7B3A 100%);
  color: white !important;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(173, 151, 79, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
  width: 100%;
}

.export-btn:hover {
  background: linear-gradient(135deg, #8B7B3A 0%, #AD974F 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(173, 151, 79, 0.4);
}

.export-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(173, 151, 79, 0.3);
}
</style>

<!-- Add jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Global variables
let currentBooking = null;

// View Request button functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add event listener for PDF export button when modal is shown
  const modal = document.getElementById('bookingSummaryModal');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      const exportBtn = document.getElementById('export-pdf-btn');
      if (exportBtn && currentBooking) {
        exportBtn.onclick = function() {
          console.log('Export PDF button clicked!');
          exportReceiptToPDF(currentBooking);
        };
      }
    });
  }
});

function showBookingSummary(bookingId) {
  try {
    // Get CSRF token from meta tag or form
    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenForm = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : 
                     (csrfTokenForm ? csrfTokenForm.value : '');
    
    // Fetch booking details from the API (using admin endpoint)
    fetch(`/admin/api/booking/${bookingId}/details/`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('API Response:', data);
      
      // Check if this is a wrapped response or direct booking data
      if (data.success !== undefined) {
        // Wrapped response format
        if (data.success) {
          const booking = data.booking;
          console.log('Using wrapped booking data format');
          
          // Store current booking for PDF export
          currentBooking = booking;
          
          // Generate the booking summary exactly like bookhere.html
          showBookingSummaryContent(booking);
          
          // Show the modal
          const modal = new bootstrap.Modal(document.getElementById('bookingSummaryModal'));
          modal.show();
        } else {
          console.error('API returned error:', data.message);
          alert('Failed to load booking details: ' + (data.message || 'Unknown error'));
        }
      } else {
        // Direct booking data format (current API response)
        const booking = data;
        console.log('Using direct booking data format');
        
        // Store current booking for PDF export
        currentBooking = booking;
        
        // Generate the booking summary exactly like bookhere.html
        showBookingSummaryContent(booking);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('bookingSummaryModal'));
        modal.show();
      }
    })
    .catch(error => {
      console.error('Error fetching booking details:', error);
      alert('Error loading booking details: ' + error.message);
    });
  } catch (error) {
    console.error('Error in showBookingSummary:', error);
    alert('Error loading booking details');
  }
}

// Show booking summary function - copied and adapted from bookhere.html
function showBookingSummaryContent(booking) {
  const summaryContainer = document.getElementById('booking-summary-content');
  const receiptContainer = document.getElementById('receipt-content');
  if (!summaryContainer || !receiptContainer) return;

  // Clear previous content
  summaryContainer.innerHTML = '';
  receiptContainer.innerHTML = '';

  // Create summary sections exactly like bookhere.html
  const sections = [
    {
      title: 'Event Details',
      items: [
        { label: 'Celebrant Name', value: booking.celebrant_name },
        { label: 'Event Date', value: booking.event_date },
        { label: 'Event Type', value: booking.event_type },
        { label: 'Number of Guests', value: `${booking.pax} Pax` },
        { label: 'Color Motif', value: booking.color_motif, showColorPreview: true, colors: booking.color_motif_with_images }
      ]
    },
    {
      title: 'Theme & Venue',
      items: [
        { label: 'Theme', value: booking.theme_name },
        { label: 'Venue', value: booking.venue },
        { label: 'Floor Plan', value: booking.floorplan_name || 'Not Selected' },
        { label: 'Package', value: booking.package }
      ]
    },
    {
      title: 'Food Menu',
      items: [],
      showFoodImages: true,
      dishes: booking.dishes_with_images || [],
      pasta: { name: booking.pasta, image: booking.pasta_image },
      drink: { name: booking.drink, image: booking.drink_image }
    }
  ];

  sections.forEach(section => {
    const sectionDiv = document.createElement('div');
    sectionDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
    
    const titleDiv = document.createElement('h3');
    titleDiv.textContent = section.title;
    titleDiv.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    sectionDiv.appendChild(titleDiv);

    if (section.showFoodImages) {
      // Show selected food items with images
      const foodGrid = document.createElement('div');
      foodGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;';
      
      // Add dishes
      if (section.dishes && section.dishes.length > 0) {
        section.dishes.forEach(dish => {
          const foodItem = document.createElement('div');
          foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
          
          if (dish.image_url) {
            const img = document.createElement('img');
            img.src = dish.image_url;
            img.alt = dish.name;
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
            img.onerror = function() {
              this.style.display = 'none';
            };
            foodItem.appendChild(img);
          }
          
          const label = document.createElement('div');
          label.textContent = dish.name;
          label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
          foodItem.appendChild(label);
          
          foodGrid.appendChild(foodItem);
        });
      }
      
      // Add pasta if exists
      if (section.pasta && section.pasta.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.pasta.image) {
          const img = document.createElement('img');
          img.src = section.pasta.image;
          img.alt = section.pasta.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.pasta.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      // Add drink if exists
      if (section.drink && section.drink.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.drink.image) {
          const img = document.createElement('img');
          img.src = section.drink.image;
          img.alt = section.drink.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.drink.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      sectionDiv.appendChild(foodGrid);
    } else {
      // Regular items
      section.items.forEach(item => {
        if (item.value) {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'margin: 8px 0; display: flex; justify-content: space-between; align-items: center;';
          
          const labelSpan = document.createElement('span');
          labelSpan.textContent = item.label + ':';
          labelSpan.style.cssText = 'font-weight: 600; color: #555;';
          
          if (item.showColorPreview && item.colors && item.colors.length > 0) {
            // Create color preview container
            const colorContainer = document.createElement('div');
            colorContainer.style.cssText = 'display: flex; align-items: center; gap: 10px;';
            
            // Add text value
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; font-size: 0.9rem;';
            colorContainer.appendChild(valueSpan);
            
            // Add color swatches with actual images
            const swatchContainer = document.createElement('div');
            swatchContainer.style.cssText = 'display: flex; gap: 3px;';
            
            item.colors.forEach((colorItem, index) => {
              const colorPreview = document.createElement('div');
              
              // Set up the color preview container with proper styling
              colorPreview.style.cssText = `
                width: 32px; 
                height: 32px; 
                border-radius: 6px; 
                border: 2px solid #B8860B;
                position: relative;
                display: inline-block;
                overflow: hidden;
                background-color: #f0f0f0;
              `;
              
              // Apply the background image if available
              if (colorItem.image_url && colorItem.image_url.trim() !== '') {
                // Create an image element to preload and test the image
                const img = new Image();
                img.onload = function() {
                  // Image loaded successfully, apply it as background
                  colorPreview.style.backgroundImage = `url('${colorItem.image_url}')`;
                  colorPreview.style.backgroundSize = 'cover';
                  colorPreview.style.backgroundPosition = 'center';
                  colorPreview.style.backgroundRepeat = 'no-repeat';
                  colorPreview.style.backgroundColor = 'transparent';
                };
                img.onerror = function() {
                  // Image failed to load, keep the gray background
                  console.warn(`Failed to load color image for ${colorItem.name}: ${colorItem.image_url}`);
                };
                // Start loading the image
                img.src = colorItem.image_url;
              }
              
              // Add order number
              const orderNum = document.createElement('div');
              orderNum.textContent = index + 1;
              orderNum.style.cssText = `
                position: absolute;
                bottom: -2px;
                right: -2px;
                background: #B8860B;
                color: white;
                width: 14px;
                height: 14px;
                border-radius: 50%;
                font-size: 9px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
              `;
              colorPreview.appendChild(orderNum);
              swatchContainer.appendChild(colorPreview);
            });
            
            colorContainer.appendChild(swatchContainer);
            itemDiv.appendChild(colorContainer);
          } else {
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; text-align: right; max-width: 60%; word-break: break-word;';
            itemDiv.appendChild(valueSpan);
          }
          
          itemDiv.insertBefore(labelSpan, itemDiv.firstChild);
          sectionDiv.appendChild(itemDiv);
        }
      });
    }

    summaryContainer.appendChild(sectionDiv);
  });

  // Add theme images if available (same as bookhere.html)
  if (booking.theme_urls && booking.theme_urls.length > 0) {
    const themeImagesDiv = document.createElement('div');
    themeImagesDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: 100%;';
    
    const themeTitle = document.createElement('h3');
    themeTitle.textContent = 'Theme Images';
    themeTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    themeImagesDiv.appendChild(themeTitle);

    const imagesContainer = document.createElement('div');
    imagesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;';
    
    booking.theme_urls.slice(0, 3).forEach(imageUrl => {
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
      img.alt = booking.theme_name;
      imagesContainer.appendChild(img);
    });

    themeImagesDiv.appendChild(imagesContainer);
    summaryContainer.appendChild(themeImagesDiv);
  }
  
  // Generate the receipt
  generateReceipt(receiptContainer, booking);
}

// Generate receipt function - adapted from bookhere.html
function generateReceipt(container, booking) {
  // Receipt header
  const header = document.createElement('div');
  header.style.cssText = 'text-align: center; margin-bottom: 20px; border-bottom: 2px solid rgb(51, 51, 51); padding-bottom: 15px; display: flex; flex-direction: column';
  
  const companyName = document.createElement('h2');
  companyName.textContent = 'NIKE\'S CATERING SERVICES';
  companyName.style.cssText = 'margin: 0; color: #B8860B; font-size: 1.4rem; font-weight: bold;';
  
  const tagline = document.createElement('p');
  tagline.textContent = 'Celebrate with Nikes!';
  tagline.style.cssText = 'margin: 5px 0 0 0; color: #666; font-size: 0.9rem;';
  
  const receiptTitle = document.createElement('h3');
  receiptTitle.textContent = 'BOOKING RECEIPT';
  receiptTitle.style.cssText = 'margin: 15px 0 0 0; color: #333; font-size: 1.1rem;';
  
  header.appendChild(companyName);
  header.appendChild(tagline);
  header.appendChild(receiptTitle);
  container.appendChild(header);

  // Receipt details
  const details = document.createElement('div');
  details.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; justify-items: flex-start; margin-bottom: 20px;';
  
  const receiptItems = [
      { label: 'Booking Date', value: new Date().toLocaleDateString() },
      { label: 'Event Date', value: booking.event_date },
      { label: 'Celebrant', value: booking.celebrant_name },
      { label: 'Event Type', value: booking.event_type },
      { label: 'Guests', value: `${booking.pax} Pax` },
      { label: 'Theme', value: booking.theme_name },
      { label: 'Venue', value: booking.venue },
      { label: 'Package', value: booking.package },
      { label: 'Color Motif', value: booking.color_motif }
  ];

  receiptItems.forEach(item => {
      if (item.value) {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'margin: 5px 0; display: flex; justify-content: space-between; width: 100%;';
          
          const label = document.createElement('span');
          label.textContent = item.label + ':';
          label.style.cssText = 'font-weight: 600; color: #555;';
          
          const value = document.createElement('span');
          value.textContent = item.value;
          value.style.cssText = 'color: #333;';
          
          itemDiv.appendChild(label);
          itemDiv.appendChild(value);
          details.appendChild(itemDiv);
      }
  });

  container.appendChild(details);

  // Contact info footer
  const footer = document.createElement('div');
  footer.style.cssText = 'margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 0.85rem; color: #666;';
  footer.innerHTML = '<p style="margin: 0;">Contact: nikes.catering@gmail.com | (02) 123-4567</p><p style="margin: 5px 0 0 0;">Thank you for choosing Nike\'s Catering!</p>';
  container.appendChild(footer);
}

// Helper function to format colors for display
function formatColorsForDisplay(colors, separator = ' â†’ ') {
  if (!colors || colors.length === 0) return 'Not specified';
  
  if (typeof colors === 'string') {
    return colors;
  }
  
  return colors.map(color => {
    if (color.startsWith('custom_')) {
      return color.replace('custom_', '');
    }
    return color;
  }).join(separator);
}

// PDF Export functionality - adapted from bookhere.html
// Package pricing configuration - Based on actual package images analysis
const packagePricing = {
    'Wedding': {
        'Package A': { 
            50: 40000, 60: 45000, 70: 50000, 80: 55000, 100: 60000, 
            120: 65000, 130: 70000, 150: 75000, 160: 80000, 170: 85000, 
            180: 95000, 200: 100000, 250: 125000 
        },
        'Package B': { 
            50: 45000, 60: 50000, 70: 55000, 80: 60000, 100: 65000, 
            120: 70000, 130: 75000, 150: 85000, 160: 90000, 170: 95000, 
            180: 105000, 200: 110000, 250: 145000 
        },
        'Package C': { 
            50: 50000, 60: 55000, 70: 60000, 80: 65000, 100: 70000, 
            120: 75000, 130: 80000, 150: 95000, 160: 100000, 170: 105000, 
            180: 115000, 200: 120000, 250: 165000 
        }
    },
    'Birthday Party': {
        'Package A': { 
            50: 35000, 70: 40000, 80: 45000, 100: 50000, 
            120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
            180: 85000, 200: 90000 
        },
        'Package B': { 
            50: 40000, 70: 45000, 80: 50000, 100: 55000, 
            120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
            180: 95000, 200: 100000 
        },
        'Package C': { 
            50: 45000, 70: 50000, 80: 55000, 100: 60000, 
            120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
            180: 105000, 200: 110000 
        }
    },
    'Kiddie Party': {
        'Package A': { 50: 30000, 70: 35000, 80: 40000, 100: 45000 },
        'Package B': { 50: 35000, 70: 40000, 80: 45000, 100: 50000 },
        'Package C': { 50: 40000, 70: 45000, 80: 50000, 100: 55000 }
    },
    'Baptismal': {
        'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
        'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
        'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
    },
    'Christening': {
        'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
        'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
        'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
    }
};

// Custom event per-head pricing
const customEventPricing = {
    'Below 100 pax': { 'Package A': 500, 'Package B': 600, 'Package C': 700 },
    '100+ pax': { 'Package A': 450, 'Package B': 550, 'Package C': 650 }
};

// Add-ons pricing
const addonPricing = {
    'Photo Booth': 8000,
    'LED Wall': 15000,
    'Ceremony Styling': 10000,
    'Photo and Video Coverage': 5000,
    'Face Painting and Bubble Show': 5000,
    'Digital Invitations': 3000
};

// Calculate package price based on exact pax pricing
function calculatePackagePrice(packageName, eventType, pax) {
    // Handle custom events with per-head pricing
    if (eventType && !packagePricing[eventType]) {
        // This is a custom event, use per-head pricing
        const pricingTier = pax >= 100 ? '100+ pax' : 'Below 100 pax';
        const perHeadPrice = customEventPricing[pricingTier][packageName];
        if (perHeadPrice) {
            return perHeadPrice * pax;
        }
        return 0;
    }

    const eventPricing = packagePricing[eventType];
    if (!eventPricing || !eventPricing[packageName]) {
        return 0;
    }

    const packagePrices = eventPricing[packageName];
    
    // Check if exact pax count exists
    if (packagePrices[pax]) {
        return packagePrices[pax];
    }
    
    // Find the closest lower and higher pax counts for interpolation
    const availablePax = Object.keys(packagePrices).map(Number).sort((a, b) => a - b);
    let lowerPax = null;
    let higherPax = null;
    
    for (let i = 0; i < availablePax.length; i++) {
        if (availablePax[i] <= pax) {
            lowerPax = availablePax[i];
        }
        if (availablePax[i] >= pax && !higherPax) {
            higherPax = availablePax[i];
            break;
        }
    }
    
    // If pax is lower than minimum, use minimum price
    if (!lowerPax) {
        return packagePrices[availablePax[0]];
    }
    
    // If pax is higher than maximum, use maximum price
    if (!higherPax) {
        return packagePrices[lowerPax];
    }
    
    // If exact match found, return it
    if (lowerPax === pax) {
        return packagePrices[lowerPax];
    }
    
    // Interpolate between lower and higher pax
    const lowerPrice = packagePrices[lowerPax];
    const higherPrice = packagePrices[higherPax];
    const ratio = (pax - lowerPax) / (higherPax - lowerPax);
    return Math.round(lowerPrice + (higherPrice - lowerPrice) * ratio);
}

function exportReceiptToPDF(booking) {
  try {
    console.log('Exporting PDF...');
    console.log('jsPDF available:', typeof window.jspdf);
    console.log('booking data:', booking);
    
    // Check if jsPDF is available
    if (typeof window.jspdf === 'undefined') {
      console.error('jsPDF library not loaded');
      alert('PDF library not loaded. Please refresh the page and try again.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    console.log('jsPDF constructor:', jsPDF);
    const doc = new jsPDF();
    console.log('PDF document created:', doc);
    
    // Set up the PDF document
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('NIKE\'S CATERING SERVICES', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Celebrate with Nikes!', 105, 30, { align: 'center' });
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('BOOKING RECEIPT', 105, 45, { align: 'center' });
    
    // Add a line
    doc.setLineWidth(0.5);
    doc.line(20, 50, 190, 50);
    
    // Receipt details
    let yPosition = 65;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const receiptData = [
        { label: 'Booking Date:', value: new Date().toLocaleDateString() },
        { label: 'Event Date:', value: booking.event_date || 'Not specified' },
        { label: 'Celebrant:', value: booking.celebrant_name || 'Not specified' },
        { label: 'Event Type:', value: booking.event_type || 'Not specified' },
        { label: 'Number of Guests:', value: booking.pax ? `${booking.pax} Pax` : 'Not specified' },
        { label: 'Theme:', value: booking.theme_name || 'Not specified' },
        { label: 'Venue:', value: booking.venue || 'Not specified' },
        { label: 'Package:', value: booking.package || 'Not specified' },
        { label: 'Color Motif:', value: formatColorsForDisplay(booking.color_motif, ', ') }
    ];
    
    receiptData.forEach(item => {
        doc.text(item.label, 20, yPosition);
        doc.text(item.value, 80, yPosition);
        yPosition += 7;
    });
    
    // Add food menu if available - combined format like bookhere
    const menuItems = [];
    if (booking.dishes_with_images && booking.dishes_with_images.length > 0) {
        booking.dishes_with_images.forEach(dish => {
            menuItems.push(dish.name);
        });
    }
    if (booking.pasta) {
        menuItems.push(booking.pasta);
    }
    if (booking.drink) {
        menuItems.push(booking.drink);
    }
    
    if (menuItems.length > 0) {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Selected Menu:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        
        menuItems.forEach((item, index) => {
            doc.text(`${index + 1}. ${item}`, 25, yPosition);
            yPosition += 6;
        });
    } else {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Selected Menu:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        doc.text('No menu selected', 25, yPosition);
        yPosition += 6;
    }
    
    // Add floor plan if available
    if (booking.floorplan_display_name || booking.floorplan_name) {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Floor Plan:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        doc.text(booking.floorplan_display_name || booking.floorplan_name, 25, yPosition);
        yPosition += 6;
    }
    
    // Add pricing section
    yPosition += 15;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text('PRICE ESTIMATION', 105, yPosition, { align: 'center' });
    yPosition += 10;
    
    // Add a line
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 8;
    
    // Calculate package price
    const packagePrice = calculatePackagePrice(booking.package, booking.event_type, booking.pax);
    
    // Package price
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`${booking.package}:`, 20, yPosition);
    doc.text(`PHP ${packagePrice.toLocaleString()}`, 150, yPosition);
    yPosition += 7;
    
    // Add-ons (placeholder - could be enhanced if add-on data is available)
    // For now, we'll skip add-ons since booking data doesn't include them
    
    // Total price (same as package price for now)
    const totalPrice = packagePrice;
    yPosition += 8;
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('TOTAL:', 20, yPosition);
    doc.text(`PHP ${totalPrice.toLocaleString()}`, 150, yPosition);
    yPosition += 10;
    
    // Add footer
    yPosition += 15;
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 10;
    
    doc.setFontSize(9);
    doc.text('Thank you for choosing Nike\'s Catering Services!', 105, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('Contact: nikescateringofficial@gmail.com', 105, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('Phone: +63 123 456 7890', 105, yPosition, { align: 'center' });
    
    // Save the PDF
    const celebrantName = booking.celebrant_name ? booking.celebrant_name.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown';
    const eventDate = booking.event_date ? booking.event_date.replace(/\//g, '-') : 'Unknown_Date';
    const fileName = `Nike_Catering_Receipt_${celebrantName}_${eventDate}.pdf`;
    
    console.log('Saving PDF as:', fileName);
    doc.save(fileName);
    
    // Show success message
    alert('Receipt downloaded successfully!');
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF. Please try again.');
  }
}
</script>
{% endblock %} 