{% extends 'custom_admin/base.html' %}
{% load static %}

{% block content %}
<style>
.chat-wrap {
  display: flex;
  height: calc(100vh - 60px);
  overflow: hidden;
  position: relative;
}

/* Prevent page scrolling when auto-selecting items */
html, body {
  overflow-x: hidden;
}

/* Ensure the main container stays in place */
.container-fluid, .row {
  position: relative;
  overflow: hidden;
}

/* Sidebar */
.chat-sidebar {
  width: 260px;
  background: #1e1e1e;
  color: white;
  overflow-y: auto;
  flex-shrink: 0;
  transition: transform 0.3s ease-in-out;
  z-index: 1050; /* Raised z-index to go above header buttons */
  position: relative;
}

.chat-sidebar.hidden {
  transform: translateX(-100%);
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
}

/* Chat */
.chat-pane {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  background: #f9f9f9;
  overflow: hidden;
  position: relative;
  z-index: 1;
}

/* Chat header */
#chat-header {
  padding: 12px 20px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  font-weight: 500;
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

#chat-messages {
  flex-grow: 1;
  padding: 20px;
  overflow-y: auto;
}

.msg {
  width:  fit-content;
  max-width: 50%;
  margin: 8px 0;
  padding: 10px 16px;
  border-radius: 16px;
  line-height: 1.4;
  word-wrap: break-word;
}

.sender {
  background: #AD974F;
  color: white;
  margin-left: auto;
  text-align: left;
}

.receiver {
  background: #e2e2e2;
  color: #333;
  margin-right: auto;
  text-align: left;
}

/* Composer */
.composer {
  display: flex;
  gap: 10px;
  padding: 12px 20px;
  background: white;
  border-top: 1px solid #ddd;
  flex-shrink: 0;
}

#composer-input {
  flex-grow: 1;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  resize: none;
  height: 44px;
}

.composer .btn {
  background: #AD974F;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0 18px;
}

.composer .btn:hover {
  background: #8c7a3e;
}

/* Sidebar toggle button */
.toggle-sidebar-btn {
  background: none;
  border: none;
  font-size: 1.4rem;
  color: #333;
  display: none;
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1100; /* above sidebar */
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .toggle-sidebar-btn {
    display: inline-block;
  }

  .chat-sidebar {
    transform: translateX(-100%);
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
  }

  .chat-sidebar.show {
    transform: translateX(0);
  }

  .chat-pane {
    flex-grow: 1;
    width: 100%;
  }

 .booking-item {
  padding: 0.75rem 1rem;
  margin: 0.5rem 0.75rem;
  border-radius: 8px;
  background: #2a2a2a; /* Slightly lighter than sidebar for card feel */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  transition: background 0.2s ease, box-shadow 0.2s ease;
  color: white;
}

.booking-item:hover {
  background: #383838;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
}

.booking-item.active {
  border-left: 4px solid #AD974F;
  background: linear-gradient(135deg, #AD974F, #8c7a3e);
  color: white;
  box-shadow: 0 4px 16px rgba(173, 151, 79, 0.4);
  transform: translateX(3px);
}

.booking-item.active .fw-semibold {
  color: white;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.booking-item.active small {
  color: rgba(255, 255, 255, 0.9);
}
}
</style>

<div class="chat-wrap">
    <!-- Sidebar -->
 <aside class="chat-sidebar d-flex flex-column" id="chatSidebar">
  <div class="d-flex justify-content-between align-items-center text-white px-3 py-2 border-bottom">
    <span class="fw-semibold">Client Chats</span>
    <button class="btn btn-sm p-0 text-white border-0 bg-transparent d-md-none d-block" id="closeSidebarBtn" title="Close Sidebar">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <ul class="list-unstyled sidebar-list m-0 overflow-auto">
    {% for booking in bookings %}
      <li class="booking-item{% if forloop.first %} active{% endif %}"
          data-id="{{ booking.chat.id }}"
          data-booking-id="{{ booking.id }}"
          data-meta="{{ booking.client.get_full_name }} – {{ booking.event_type }} • {{ booking.event_date|date:'M j, Y' }}"
          style="padding: 0.75rem 1rem; margin: 0.5rem; border-radius: 0.5rem; background: #2E2E2EFF; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); cursor: pointer; transition: box-shadow 0.2s ease;">
        <div class="fw-semibold text-truncate">{{ booking.client.get_full_name }}</div>
        <small>{{ booking.event_type }} • {{ booking.event_date|date:"M j, Y" }}</small>
      </li>
    {% empty %}
      <li class="text-small p-4">No active chats.</li>
    {% endfor %}
  </ul>
</aside>

  <!-- Chat -->
  <section class="chat-pane">
    <header id="chat-header" class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
      <div class="d-flex align-items-center gap-2">
        <button class="toggle-sidebar-btn btn btn-sm btn-light" id="openSidebarBtn" title="Open Sidebar">
          <i class="fas fa-bars"></i>
        </button>
        <span id="chat-meta" class="fw-bold">{{ first_chat_meta }}</span>
      </div>
      <div class="d-flex gap-2">
        <button id="viewDetailsBtn" class="btn btn-sm btn-outline-info d-none" data-booking-id="" title="View Details">
          <i class="fas fa-eye me-1"></i> View Details
        </button>
        <button id="viewStatusBtn" class="btn btn-sm btn-outline-dark d-none" data-id="" title="View Request Status">
          <i class="fas fa-clipboard-list me-1"></i> View Status
        </button>
      </div>
  </header>

    <div id="chat-messages">
      {% for m in first_messages %}
        <div class="msg {% if m.sender.is_staff %}sender{% else %}receiver{% endif %}">
          {{ m.content|safe }}
        </div>
      {% empty %}
        <div class="small text-muted text-center mt-5">No messages…</div>
      {% endfor %}
    </div>

    <div id="composer-wrap" class="{% if not first_chat.id %}d-none{% endif %}">
      <form id="composer" class="composer" method="post">
        {% csrf_token %}
        <input type="hidden" name="chat_id" id="chat-id" value="{{ first_chat.id }}">
        <textarea id="composer-input" name="message" placeholder="Type message…"></textarea>
        <button class="btn" type="submit"><i class="fa fa-paper-plane"></i></button>
      </form>
    </div>
  </section>
</div>

<!-- Add export button styling -->
<style>
.export-btn {
  background: linear-gradient(135deg, #AD974F 0%, #8B7B3A 100%);
  color: white !important;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(173, 151, 79, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
  width: 100%;
}

.export-btn:hover {
  background: linear-gradient(135deg, #8B7B3A 0%, #AD974F 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(173, 151, 79, 0.4);
}

.export-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(173, 151, 79, 0.3);
}
</style>

<!-- Add jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script>
const clientId = {{ request.user.id }};
const chatBox = document.getElementById('chat-messages');
const composerForm = document.getElementById('composer');
const chatInput = document.getElementById('composer-input');
const chatIdField = document.getElementById('chat-id');
const sidebar = document.getElementById('chatSidebar');
const openBtn = document.getElementById('openSidebarBtn');
const closeBtn = document.getElementById('closeSidebarBtn');
let sock;

function connectSSE(chatId) {
    if (sock) {
        sock.close();
    }
    if (!chatId || chatId === "general") return;

    // Replace SSE with SockJS
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    sock = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/${chatId}/`);

    sock.onopen = () => console.log("WebSocket (SockJS) connection opened");
    sock.onclose = () => console.log("WebSocket (SockJS) connection closed");
    sock.onerror = (e) => console.error("WebSocket error", e);

    sock.onmessage = (e) => {
      try {
          const data = JSON.parse(e.data);

          // Check if data has sender and content before accessing them
          if (!data.sender || !data.message) {
              console.warn("Received message without sender or content:", data);
              return;  // ignore or handle differently
          }

          const mine = data.sender.id === clientId;
          const bubble = makeBubble(data.message, mine);
          chatBox.appendChild(bubble);
          scrollBottom();

      } catch (err) {
          console.error("Invalid SockJS data", err);
      }
  };
}

function scrollBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}
scrollBottom();

function makeBubble(html, mine) {
  const div = document.createElement('div');
  div.className = 'msg ' + (mine ? 'sender' : 'receiver');
  div.innerHTML = html;
  return div;
}

async function submitMessage(e) {
    e.preventDefault();
    const txt = chatInput.value.trim();
    if (!txt) return;

    const csrfInput = document.querySelector('[name="csrfmiddlewaretoken"]').value.trim();
    if (!csrfInput || !chatIdField.value) {
        console.error("Missing CSRF token or chatId");
        return;
    }

    const bubble = makeBubble(txt, true);
    chatBox.appendChild(bubble);
    scrollBottom();
    chatInput.value = "";

    try {
        await fetch(`/event-booking-send/${chatIdField.value}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfInput
            },
            body: JSON.stringify({ message: txt })
        });
    } catch (err) {
        console.error("Send failed", err);
    }
}

document.querySelectorAll('.booking-item').forEach(li => {
  li.addEventListener('click', async () => {
    document.querySelectorAll('.booking-item').forEach(x => x.classList.remove('active'));
    li.classList.add('active');
    document.getElementById('composer-wrap')?.classList.remove('d-none');

    const chatId = li.dataset.id;
    const bookingId = li.dataset.bookingId;
    const chatMeta = li.dataset.meta;
    document.getElementById('chat-meta').textContent = chatMeta;
    chatIdField.value = chatId;

    const viewBtn = document.getElementById('viewStatusBtn');
    viewBtn.classList.remove('d-none');
    viewBtn.dataset.id = chatId;
    
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    viewDetailsBtn.classList.remove('d-none');
    viewDetailsBtn.dataset.bookingId = bookingId;
    connectSSE(chatId);
    chatBox.innerHTML = `<div class="text-muted text-center mt-5 small">Loading…</div>`;

    try {
      const r = await fetch(`/chat/${chatId}/messages-json/`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });
      const data = await r.json();
      chatBox.innerHTML = "";
      if (!data.length) {
        chatBox.innerHTML = `<div class="text-muted text-center mt-5 small">No messages…</div>`;
      } else {
        data.forEach(m => {
          const msgEl = makeBubble(m.html, m.mine);
          chatBox.appendChild(msgEl);
        });
      }
      scrollBottom();
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('show');
      }
    } catch (err) {
      console.error(err);
      chatBox.innerHTML = `<div class="text-danger text-center mt-5 small">Error loading messages</div>`;
    }
  });
});

// Global variables
let currentBooking = null;

// View Request button functionality - Fixed with DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
  // Setup form and button event listeners
  if (composerForm) {
    composerForm.addEventListener('submit', submitMessage);
  }

  if (openBtn) {
    openBtn.addEventListener('click', () => {
      sidebar.classList.add('show');
    });
  }
  
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      sidebar.classList.remove('show');
    });
  }
  // View Status Button
  const viewStatusBtn = document.getElementById('viewStatusBtn');
  if (viewStatusBtn) {
    viewStatusBtn.addEventListener('click', function () {
      const id = this.dataset.id;
      if (id) {
        window.location.href = `/admin/request-bookings/status/${id}`;
      }
    });
  }
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  
  if (viewDetailsBtn) {
    viewDetailsBtn.addEventListener('click', async function () {
      const bookingId = this.dataset.bookingId;
      console.log('View Details button clicked, bookingId:', bookingId);
      
      if (bookingId) {
        try {
          // Get CSRF token from meta tag or form
          const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
          const csrfTokenForm = document.querySelector('[name=csrfmiddlewaretoken]');
          const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : 
                           (csrfTokenForm ? csrfTokenForm.value : '');
          
          console.log('CSRF Token found:', !!csrfToken);
          
          // Fetch booking details from the API (using admin endpoint)
          const apiUrl = `/admin/api/booking/${bookingId}/details/`;
          console.log('Fetching from URL:', apiUrl);
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
          });
          
          console.log('Response status:', response.status);
          console.log('Response ok:', response.ok);
          
          if (response.ok) {
            const data = await response.json();
            console.log('Response data:', data);
            
            // Check if this is a wrapped response or direct booking data
            if (data.success !== undefined) {
              // Wrapped response format
              if (data.success) {
                const booking = data.booking;
                
                // Store current booking for PDF export
                currentBooking = booking;
                
                // Generate the booking summary exactly like bookhere.html
                showBookingSummaryContent(booking);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
                modal.show();
              } else {
                console.error('API returned error:', data.message);
                alert('Failed to load booking details: ' + (data.message || 'Unknown error'));
              }
            } else {
              // Direct booking data format (current API response)
              const booking = data;
              console.log('Using direct booking data format');
              
              // Store current booking for PDF export
              currentBooking = booking;
              
              // Generate the booking summary exactly like bookhere.html
              showBookingSummaryContent(booking);
              
              // Show the modal
              const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
              modal.show();
            }
          } else {
            console.error('HTTP Error:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error response body:', errorText);
            alert(`Failed to load booking details (${response.status}): ${response.statusText}`);
          }
        } catch (error) {
          console.error('Error fetching booking details:', error);
          alert('Error loading booking details: ' + error.message);
        }
      } else {
        console.error('No booking ID found in dataset');
        alert('No booking ID found');
      }
    });
  }
  
  // Add event listener for PDF export button when modal is shown
  const modal = document.getElementById('bookingDetailsModal');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      const exportBtn = document.getElementById('export-pdf-btn');
      if (exportBtn && currentBooking) {
        exportBtn.onclick = function() {
          console.log('Export PDF button clicked!');
          exportReceiptToPDF(currentBooking);
        };
      }
    });
  }
});

// Show booking summary function - EXACT COPY from my_bookings.html
function showBookingSummaryContent(booking) {
  const summaryContainer = document.getElementById('booking-summary-content');
  const receiptContainer = document.getElementById('receipt-content');
  if (!summaryContainer || !receiptContainer) return;

  // Clear previous content
  summaryContainer.innerHTML = '';
  receiptContainer.innerHTML = '';

  // Create summary sections exactly like bookhere.html
  const sections = [
    {
      title: 'Event Details',
      items: [
        { label: 'Celebrant Name', value: booking.celebrant_name },
        { label: 'Event Date', value: booking.event_date },
        { label: 'Event Type', value: booking.event_type },
        { label: 'Number of Guests', value: `${booking.pax} Pax` },
        { label: 'Color Motif', value: booking.color_motif, showColorPreview: true, colors: booking.color_motif_with_images }
      ]
    },
    {
      title: 'Theme & Venue',
      items: [
        { label: 'Theme', value: booking.theme_name },
        { label: 'Venue', value: booking.venue },
        { label: 'Floor Plan', value: booking.floorplan_name || 'Not Selected' },
        { label: 'Package', value: booking.package }
      ]
    },
    {
      title: 'Food Menu',
      items: [],
      showFoodImages: true,
      dishes: booking.dishes_with_images || [],
      pasta: { name: booking.pasta, image: booking.pasta_image },
      drink: { name: booking.drink, image: booking.drink_image }
    }
  ];

  sections.forEach(section => {
    const sectionDiv = document.createElement('div');
    sectionDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px;';
    
    const titleDiv = document.createElement('h3');
    titleDiv.textContent = section.title;
    titleDiv.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    sectionDiv.appendChild(titleDiv);

    if (section.showFoodImages) {
      // Show selected food items with images
      const foodGrid = document.createElement('div');
      foodGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;';
      
      // Add dishes
      if (section.dishes && section.dishes.length > 0) {
        section.dishes.forEach(dish => {
          const foodItem = document.createElement('div');
          foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
          
          if (dish.image_url) {
            const img = document.createElement('img');
            img.src = dish.image_url;
            img.alt = dish.name;
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
            img.onerror = function() {
              this.style.display = 'none';
            };
            foodItem.appendChild(img);
          }
          
          const label = document.createElement('div');
          label.textContent = dish.name;
          label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
          foodItem.appendChild(label);
          
          foodGrid.appendChild(foodItem);
        });
      }
      
      // Add pasta if exists
      if (section.pasta && section.pasta.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.pasta.image) {
          const img = document.createElement('img');
          img.src = section.pasta.image;
          img.alt = section.pasta.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.pasta.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      // Add drink if exists
      if (section.drink && section.drink.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.drink.image) {
          const img = document.createElement('img');
          img.src = section.drink.image;
          img.alt = section.drink.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.drink.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      sectionDiv.appendChild(foodGrid);
    } else {
      // Regular items
      section.items.forEach(item => {
        if (item.value) {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'margin: 8px 0; display: flex; justify-content: space-between; align-items: center;';
          
          const labelSpan = document.createElement('span');
          labelSpan.textContent = item.label + ':';
          labelSpan.style.cssText = 'font-weight: 600; color: #555;';
          
          if (item.showColorPreview && item.colors && item.colors.length > 0) {
            // Create color preview container
            const colorContainer = document.createElement('div');
            colorContainer.style.cssText = 'display: flex; align-items: center; gap: 10px;';
            
            // Add text value
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; font-size: 0.9rem;';
            colorContainer.appendChild(valueSpan);
            
            // Add color swatches with actual images
            const swatchContainer = document.createElement('div');
            swatchContainer.style.cssText = 'display: flex; gap: 3px;';
            
            item.colors.forEach((colorItem, index) => {
              
              const colorPreview = document.createElement('div');
              
              // Always ensure the basic styling is applied first
              colorPreview.style.cssText = `
                width: 25px; 
                height: 25px; 
                border-radius: 4px; 
                border: 2px solid #B8860B;
                position: relative;
                display: inline-block;
              `;
              
              // Then apply the background image if available
              if (colorItem.image_url) {
                colorPreview.style.backgroundImage = `url('${colorItem.image_url}')`;
                colorPreview.style.backgroundSize = 'cover';
                colorPreview.style.backgroundPosition = 'center';
              } else {
                colorPreview.style.backgroundColor = '#f0f0f0';
              }
              
              // Add order number
              const orderNum = document.createElement('div');
              orderNum.textContent = index + 1;
              orderNum.style.cssText = `
                position: absolute;
                bottom: -2px;
                right: -2px;
                background: #B8860B;
                color: white;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                font-size: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
              `;
              colorPreview.appendChild(orderNum);
              swatchContainer.appendChild(colorPreview);
            });
            
            colorContainer.appendChild(swatchContainer);
            itemDiv.appendChild(colorContainer);
          } else {
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; text-align: right; max-width: 60%; word-break: break-word;';
            itemDiv.appendChild(valueSpan);
          }
          
          itemDiv.insertBefore(labelSpan, itemDiv.firstChild);
          sectionDiv.appendChild(itemDiv);
        }
      });
    }

    summaryContainer.appendChild(sectionDiv);
  });

  // Add theme images if available (same as bookhere.html)
  if (booking.theme_urls && booking.theme_urls.length > 0) {
    const themeImagesDiv = document.createElement('div');
    themeImagesDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: 100%;';
    
    const themeTitle = document.createElement('h3');
    themeTitle.textContent = 'Theme Images';
    themeTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    themeImagesDiv.appendChild(themeTitle);

    const imagesContainer = document.createElement('div');
    imagesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;';
    
    booking.theme_urls.slice(0, 3).forEach(imageUrl => {
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
      img.alt = booking.theme_name;
      imagesContainer.appendChild(img);
    });

    themeImagesDiv.appendChild(imagesContainer);
    summaryContainer.appendChild(themeImagesDiv);
  }
  
  // Generate the receipt
  generateReceipt(receiptContainer, booking);
}

// Legacy function for compatibility  
function showBookingSummary(booking) {
  const summaryContainer = document.getElementById('booking-summary-content');
  if (!summaryContainer) return;

  // Clear previous content
  summaryContainer.innerHTML = '';

  // Create summary sections exactly like my_bookings.html
  const sections = [
    {
      title: 'Event Details',
      items: [
        { label: 'Celebrant Name', value: booking.celebrant_name },
        { label: 'Event Date', value: booking.event_date },
        { label: 'Event Type', value: booking.event_type },
        { label: 'Number of Guests', value: `${booking.pax} Pax` },
        { label: 'Color Motif', value: booking.color_motif, showColorPreview: true, colors: booking.color_motif_with_images }
      ]
    },
    {
      title: 'Theme & Venue',
      items: [
        { label: 'Theme', value: booking.theme_name },
        { label: 'Venue', value: booking.venue },
        { label: 'Floor Plan', value: booking.floorplan_name || 'Not Selected' },
        { label: 'Package', value: booking.package }
      ]
    },
    {
      title: 'Food Menu',
      items: [],
      showFoodImages: true,
      dishes: booking.dishes_with_images || [],
      pasta: { name: booking.pasta, image: booking.pasta_image },
      drink: { name: booking.drink, image: booking.drink_image }
    }
  ];

  sections.forEach(section => {
    const sectionDiv = document.createElement('div');
    sectionDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
    
    const titleDiv = document.createElement('h3');
    titleDiv.textContent = section.title;
    titleDiv.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    sectionDiv.appendChild(titleDiv);

    if (section.showFoodImages) {
      // Show selected food items with images
      const foodGrid = document.createElement('div');
      foodGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;';
      
      // Add dishes
      if (section.dishes && section.dishes.length > 0) {
        section.dishes.forEach(dish => {
          const foodItem = document.createElement('div');
          foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
          
          if (dish.image_url) {
            const img = document.createElement('img');
            img.src = dish.image_url;
            img.alt = dish.name;
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
            img.onerror = function() {
              this.style.display = 'none';
            };
            foodItem.appendChild(img);
          }
          
          const label = document.createElement('div');
          label.textContent = dish.name;
          label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
          foodItem.appendChild(label);
          
          foodGrid.appendChild(foodItem);
        });
      }
      
      // Add pasta if exists
      if (section.pasta && section.pasta.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.pasta.image) {
          const img = document.createElement('img');
          img.src = section.pasta.image;
          img.alt = section.pasta.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.pasta.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      // Add drink if exists
      if (section.drink && section.drink.name) {
        const foodItem = document.createElement('div');
        foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        if (section.drink.image) {
          const img = document.createElement('img');
          img.src = section.drink.image;
          img.alt = section.drink.name;
          img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = function() {
            this.style.display = 'none';
          };
          foodItem.appendChild(img);
        }
        
        const label = document.createElement('div');
        label.textContent = section.drink.name;
        label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
        foodItem.appendChild(label);
        
        foodGrid.appendChild(foodItem);
      }
      
      sectionDiv.appendChild(foodGrid);
    } else {
      // Regular items
      section.items.forEach(item => {
        if (item.value) {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'margin: 8px 0; display: flex; justify-content: space-between; align-items: center;';
          
          const labelSpan = document.createElement('span');
          labelSpan.textContent = item.label + ':';
          labelSpan.style.cssText = 'font-weight: 600; color: #555;';
          
          if (item.showColorPreview && item.colors && item.colors.length > 0) {
            // Create color preview container
            const colorContainer = document.createElement('div');
            colorContainer.style.cssText = 'display: flex; align-items: center; gap: 10px;';
            
            // Add text value
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; font-size: 0.9rem;';
            colorContainer.appendChild(valueSpan);
            
            // Add color swatches with actual images
            const swatchContainer = document.createElement('div');
            swatchContainer.style.cssText = 'display: flex; gap: 3px;';
            
            item.colors.forEach((colorItem, index) => {
              const colorPreview = document.createElement('div');
              
              // Set up the color preview container with proper styling
              colorPreview.style.cssText = `
                width: 32px; 
                height: 32px; 
                border-radius: 6px; 
                border: 2px solid #B8860B;
                position: relative;
                display: inline-block;
                overflow: hidden;
                background-color: #f0f0f0;
              `;
              
              // Apply the background image if available
              if (colorItem.image_url && colorItem.image_url.trim() !== '') {
                // Create an image element to preload and test the image
                const img = new Image();
                img.onload = function() {
                  // Image loaded successfully, apply it as background
                  colorPreview.style.backgroundImage = `url('${colorItem.image_url}')`;
                  colorPreview.style.backgroundSize = 'cover';
                  colorPreview.style.backgroundPosition = 'center';
                  colorPreview.style.backgroundRepeat = 'no-repeat';
                  colorPreview.style.backgroundColor = 'transparent';
                };
                img.onerror = function() {
                  // Image failed to load, keep the gray background
                  console.warn(`Failed to load color image for ${colorItem.name}: ${colorItem.image_url}`);
                };
                // Start loading the image
                img.src = colorItem.image_url;
              }
              
              // Add order number
              const orderNum = document.createElement('div');
              orderNum.textContent = index + 1;
              orderNum.style.cssText = `
                position: absolute;
                bottom: -2px;
                right: -2px;
                background: #B8860B;
                color: white;
                width: 14px;
                height: 14px;
                border-radius: 50%;
                font-size: 9px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
              `;
              colorPreview.appendChild(orderNum);
              swatchContainer.appendChild(colorPreview);
            });
            
            colorContainer.appendChild(swatchContainer);
            itemDiv.appendChild(colorContainer);
          } else {
            const valueSpan = document.createElement('span');
            valueSpan.textContent = item.value;
            valueSpan.style.cssText = 'color: #333; text-align: right; max-width: 60%; word-break: break-word;';
            itemDiv.appendChild(valueSpan);
          }
          
          itemDiv.insertBefore(labelSpan, itemDiv.firstChild);
          sectionDiv.appendChild(itemDiv);
        }
      });
    }

    summaryContainer.appendChild(sectionDiv);
  });

  // Add theme images if available (same as my_bookings.html)
  if (booking.theme_urls && booking.theme_urls.length > 0) {
    const themeImagesDiv = document.createElement('div');
    themeImagesDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
    
    const themeTitle = document.createElement('h3');
    themeTitle.textContent = 'Theme Images';
    themeTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
    themeImagesDiv.appendChild(themeTitle);

    const imagesContainer = document.createElement('div');
    imagesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;';
    
    booking.theme_urls.slice(0, 3).forEach(imageUrl => {
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
      img.alt = booking.theme_name;
      imagesContainer.appendChild(img);
    });

    themeImagesDiv.appendChild(imagesContainer);
    summaryContainer.appendChild(themeImagesDiv);
  }
}

// Generate receipt function - adapted from bookhere.html
function generateReceipt(container, booking) {
  // Receipt header
  const header = document.createElement('div');
  header.style.cssText = 'text-align: center; margin-bottom: 20px; border-bottom: 2px solid rgb(51, 51, 51); padding-bottom: 15px; display: flex; flex-direction: column';
  
  const companyName = document.createElement('h2');
  companyName.textContent = 'NIKE\'S CATERING SERVICES';
  companyName.style.cssText = 'margin: 0; color: #B8860B; font-size: 1.4rem; font-weight: bold;';
  
  const tagline = document.createElement('p');
  tagline.textContent = 'Celebrate with Nikes!';
  tagline.style.cssText = 'margin: 5px 0 0 0; color: #666; font-size: 0.9rem;';
  
  const receiptTitle = document.createElement('h3');
  receiptTitle.textContent = 'BOOKING RECEIPT';
  receiptTitle.style.cssText = 'margin: 15px 0 0 0; color: #333; font-size: 1.1rem;';
  
  header.appendChild(companyName);
  header.appendChild(tagline);
  header.appendChild(receiptTitle);
  container.appendChild(header);

  // Receipt details
  const details = document.createElement('div');
  details.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; justify-items: flex-start; margin-bottom: 20px;';
  
  const receiptItems = [
      { label: 'Booking Date', value: new Date().toLocaleDateString() },
      { label: 'Event Date', value: booking.event_date },
      { label: 'Celebrant', value: booking.celebrant_name },
      { label: 'Event Type', value: booking.event_type },
      { label: 'Guests', value: `${booking.pax} Pax` },
      { label: 'Theme', value: booking.theme_name },
      { label: 'Venue', value: booking.venue },
      { label: 'Package', value: booking.package },
      { label: 'Color Motif', value: booking.color_motif }
  ];

  receiptItems.forEach(item => {
      if (item.value) {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'margin: 5px 0; display: flex; justify-content: space-between; width: 100%;';
          
          const label = document.createElement('span');
          label.textContent = item.label + ':';
          label.style.cssText = 'font-weight: 600; color: #555;';
          
          const value = document.createElement('span');
          value.textContent = item.value;
          value.style.cssText = 'color: #333;';
          
          itemDiv.appendChild(label);
          itemDiv.appendChild(value);
          details.appendChild(itemDiv);
      }
  });

  container.appendChild(details);

  // Contact info footer
  const footer = document.createElement('div');
  footer.style.cssText = 'margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 0.85rem; color: #666;';
  footer.innerHTML = '<p style="margin: 0;">Contact: nikes.catering@gmail.com | (02) 123-4567</p><p style="margin: 5px 0 0 0;">Thank you for choosing Nike\'s Catering!</p>';
  container.appendChild(footer);
}

// Helper function to format colors for display
function formatColorsForDisplay(colors, separator = ' → ') {
  if (!colors || colors.length === 0) return 'Not specified';
  
  if (typeof colors === 'string') {
    return colors;
  }
  
  return colors.map(color => {
    if (color.startsWith('custom_')) {
      return color.replace('custom_', '');
    }
    return color;
  }).join(separator);
}

// PDF Export functionality - adapted from bookhere.html
// Package pricing configuration - Based on actual package images analysis
const packagePricing = {
    'Wedding': {
        'Package A': { 
            50: 40000, 60: 45000, 70: 50000, 80: 55000, 100: 60000, 
            120: 65000, 130: 70000, 150: 75000, 160: 80000, 170: 85000, 
            180: 95000, 200: 100000, 250: 125000 
        },
        'Package B': { 
            50: 45000, 60: 50000, 70: 55000, 80: 60000, 100: 65000, 
            120: 70000, 130: 75000, 150: 85000, 160: 90000, 170: 95000, 
            180: 105000, 200: 110000, 250: 145000 
        },
        'Package C': { 
            50: 50000, 60: 55000, 70: 60000, 80: 65000, 100: 70000, 
            120: 75000, 130: 80000, 150: 95000, 160: 100000, 170: 105000, 
            180: 115000, 200: 120000, 250: 165000 
        }
    },
    'Birthday Party': {
        'Package A': { 
            50: 35000, 70: 40000, 80: 45000, 100: 50000, 
            120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
            180: 85000, 200: 90000 
        },
        'Package B': { 
            50: 40000, 70: 45000, 80: 50000, 100: 55000, 
            120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
            180: 95000, 200: 100000 
        },
        'Package C': { 
            50: 45000, 70: 50000, 80: 55000, 100: 60000, 
            120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
            180: 105000, 200: 110000 
        }
    },
    'Kiddie Party': {
        'Package A': { 50: 30000, 70: 35000, 80: 40000, 100: 45000 },
        'Package B': { 50: 35000, 70: 40000, 80: 45000, 100: 50000 },
        'Package C': { 50: 40000, 70: 45000, 80: 50000, 100: 55000 }
    },
    'Baptismal': {
        'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
        'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
        'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
    },
    'Christening': {
        'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
        'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
        'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
    }
};

// Custom event per-head pricing
const customEventPricing = {
    'Below 100 pax': { 'Package A': 500, 'Package B': 600, 'Package C': 700 },
    '100+ pax': { 'Package A': 450, 'Package B': 550, 'Package C': 650 }
};

// Add-ons pricing
const addonPricing = {
    'Photo Booth': 8000,
    'LED Wall': 15000,
    'Ceremony Styling': 10000,
    'Photo and Video Coverage': 5000,
    'Face Painting and Bubble Show': 5000,
    'Digital Invitations': 3000
};

// Calculate package price based on exact pax pricing
function calculatePackagePrice(packageName, eventType, pax) {
    // Handle custom events with per-head pricing
    if (eventType && !packagePricing[eventType]) {
        // This is a custom event, use per-head pricing
        const pricingTier = pax >= 100 ? '100+ pax' : 'Below 100 pax';
        const perHeadPrice = customEventPricing[pricingTier][packageName];
        if (perHeadPrice) {
            return perHeadPrice * pax;
        }
        return 0;
    }

    const eventPricing = packagePricing[eventType];
    if (!eventPricing || !eventPricing[packageName]) {
        return 0;
    }

    const packagePrices = eventPricing[packageName];
    
    // Check if exact pax count exists
    if (packagePrices[pax]) {
        return packagePrices[pax];
    }
    
    // Find the closest lower and higher pax counts for interpolation
    const availablePax = Object.keys(packagePrices).map(Number).sort((a, b) => a - b);
    let lowerPax = null;
    let higherPax = null;
    
    for (let i = 0; i < availablePax.length; i++) {
        if (availablePax[i] <= pax) {
            lowerPax = availablePax[i];
        }
        if (availablePax[i] >= pax && !higherPax) {
            higherPax = availablePax[i];
            break;
        }
    }
    
    // If pax is lower than minimum, use minimum price
    if (!lowerPax) {
        return packagePrices[availablePax[0]];
    }
    
    // If pax is higher than maximum, use maximum price
    if (!higherPax) {
        return packagePrices[lowerPax];
    }
    
    // If exact match found, return it
    if (lowerPax === pax) {
        return packagePrices[lowerPax];
    }
    
    // Interpolate between lower and higher pax
    const lowerPrice = packagePrices[lowerPax];
    const higherPrice = packagePrices[higherPax];
    const ratio = (pax - lowerPax) / (higherPax - lowerPax);
    return Math.round(lowerPrice + (higherPrice - lowerPrice) * ratio);
}

function exportReceiptToPDF(booking) {
  try {
    console.log('Exporting PDF...');
    console.log('jsPDF available:', typeof window.jspdf);
    console.log('booking data:', booking);
    
    // Check if jsPDF is available
    if (typeof window.jspdf === 'undefined') {
      console.error('jsPDF library not loaded');
      alert('PDF library not loaded. Please refresh the page and try again.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    console.log('jsPDF constructor:', jsPDF);
    const doc = new jsPDF();
    console.log('PDF document created:', doc);
    
    // Set up the PDF document
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('NIKE\'S CATERING SERVICES', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Celebrate with Nikes!', 105, 30, { align: 'center' });
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('BOOKING RECEIPT', 105, 45, { align: 'center' });
    
    // Add a line
    doc.setLineWidth(0.5);
    doc.line(20, 50, 190, 50);
    
    // Receipt details
    let yPosition = 65;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const receiptData = [
        { label: 'Booking Date:', value: new Date().toLocaleDateString() },
        { label: 'Event Date:', value: booking.event_date || 'Not specified' },
        { label: 'Celebrant:', value: booking.celebrant_name || 'Not specified' },
        { label: 'Event Type:', value: booking.event_type || 'Not specified' },
        { label: 'Number of Guests:', value: booking.pax ? `${booking.pax} Pax` : 'Not specified' },
        { label: 'Theme:', value: booking.theme_name || 'Not specified' },
        { label: 'Venue:', value: booking.venue || 'Not specified' },
        { label: 'Package:', value: booking.package || 'Not specified' },
        { label: 'Color Motif:', value: formatColorsForDisplay(booking.color_motif, ', ') }
    ];
    
    receiptData.forEach(item => {
        doc.text(item.label, 20, yPosition);
        doc.text(item.value, 80, yPosition);
        yPosition += 7;
    });
    
    // Add food menu if available - combined format like bookhere
    const menuItems = [];
    if (booking.dishes_with_images && booking.dishes_with_images.length > 0) {
        booking.dishes_with_images.forEach(dish => {
            menuItems.push(dish.name);
        });
    }
    if (booking.pasta) {
        menuItems.push(booking.pasta);
    }
    if (booking.drink) {
        menuItems.push(booking.drink);
    }
    
    if (menuItems.length > 0) {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Selected Menu:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        
        menuItems.forEach((item, index) => {
            doc.text(`${index + 1}. ${item}`, 25, yPosition);
            yPosition += 6;
        });
    } else {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Selected Menu:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        doc.text('No menu selected', 25, yPosition);
        yPosition += 6;
    }
    
    // Add floor plan if available
    if (booking.floorplan_display_name || booking.floorplan_name) {
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('Floor Plan:', 20, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        doc.text(booking.floorplan_display_name || booking.floorplan_name, 25, yPosition);
        yPosition += 6;
    }
    
    // Add pricing section
    yPosition += 15;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text('PRICE ESTIMATION', 105, yPosition, { align: 'center' });
    yPosition += 10;
    
    // Add a line
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 8;
    
    // Calculate package price
    const packagePrice = calculatePackagePrice(booking.package, booking.event_type, booking.pax);
    
    // Package price
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`${booking.package}:`, 20, yPosition);
    doc.text(`PHP ${packagePrice.toLocaleString()}`, 150, yPosition);
    yPosition += 7;
    
    // Add-ons (placeholder - could be enhanced if add-on data is available)
    // For now, we'll skip add-ons since booking data doesn't include them
    
    // Total price (same as package price for now)
    const totalPrice = packagePrice;
    yPosition += 8;
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('TOTAL:', 20, yPosition);
    doc.text(`PHP ${totalPrice.toLocaleString()}`, 150, yPosition);
    yPosition += 10;
    
    // Add footer
    yPosition += 15;
    doc.setLineWidth(0.3);
    doc.line(20, yPosition, 190, yPosition);
    yPosition += 10;
    
    doc.setFontSize(9);
    doc.text('Thank you for choosing Nike\'s Catering Services!', 105, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('Contact: nikescateringofficial@gmail.com', 105, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('Phone: +63 123 456 7890', 105, yPosition, { align: 'center' });
    
    // Save the PDF
    const celebrantName = booking.celebrant_name ? booking.celebrant_name.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown';
    const eventDate = booking.event_date ? booking.event_date.replace(/\//g, '-') : 'Unknown_Date';
    const fileName = `Nike_Catering_Receipt_${celebrantName}_${eventDate}.pdf`;
    
    console.log('Saving PDF as:', fileName);
    doc.save(fileName);
    
    // Show success message
    alert('Receipt downloaded successfully!');
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF. Please try again.');
  }
}

// Auto-select booking if booking ID is provided in URL
{% if selected_booking_id %}
document.addEventListener('DOMContentLoaded', function() {
  const targetBookingId = '{{ selected_booking_id }}';
  
  // Find the booking item that matches the selected booking ID
  const bookingItems = document.querySelectorAll('.booking-item');
  
  bookingItems.forEach(item => {
    const bookingId = item.getAttribute('data-booking-id');
    
    if (bookingId === targetBookingId) {
      // Remove active class from all items
      bookingItems.forEach(x => x.classList.remove('active'));
      
      // Add active class to the target item
      item.classList.add('active');
      
      // Simulate click to load the chat
      setTimeout(() => {
        item.click();
        
        // Prevent any page scrolling during auto-selection
        const originalOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        
        // Only scroll within the sidebar container, not the whole page
        const sidebar = document.querySelector('.chat-sidebar');
        if (sidebar) {
          const itemTop = item.offsetTop;
          const sidebarHeight = sidebar.clientHeight;
          const sidebarScrollTop = sidebar.scrollTop;
          
          // Only scroll if item is not visible within sidebar
          if (itemTop < sidebarScrollTop || itemTop > sidebarScrollTop + sidebarHeight - item.offsetHeight) {
            sidebar.scrollTo({
              top: itemTop - sidebarHeight / 2 + item.offsetHeight / 2,
              behavior: 'smooth'
            });
          }
        }
        
        // Restore original overflow
        setTimeout(() => {
          document.body.style.overflow = originalOverflow;
        }, 100);
        
        // Mark notifications as read for this booking
        markBookingNotificationsAsRead(targetBookingId);
      }, 100);
    }
  });
});

function markBookingNotificationsAsRead(bookingId) {
  fetch('/admin/notifications/mark-booking-read/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify({ booking_id: bookingId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Booking notifications marked as read');
    }
  })
  .catch(err => console.error('Error marking booking notifications as read:', err));
}

function getCsrfToken() {
  const name = 'csrftoken';
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
{% endif %}
</script>

<!-- Booking Details Modal - Popup Modal with bookhere.html content -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookingDetailsModalLabel">Booking Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Booking Summary Section - Modal Version -->
        <div class="summary-container" style="display: flex; gap: 2rem; margin: 0;">
          <!-- Left column: Event Details -->
          <div class="event-details" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0;">
            <div id="booking-summary-content">
              <!-- Summary content will be generated by JavaScript -->
            </div>
          </div>

          <!-- Right column: Receipt -->
          <div class="booking-receipt" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0; height: fit-content;">
            <div id="booking-receipt">
              <!-- Export PDF Button -->
              <button type="button" id="export-pdf-btn" class="export-btn">
                📄 Export PDF
              </button>
              
              <!-- Receipt content will be generated by JavaScript -->
              <div id="receipt-content">
                <!-- Receipt will be generated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
