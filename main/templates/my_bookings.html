{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bookings · Nike’s Catering</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/my_bookings.css' %}">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <link rel="stylesheet" href="{% static 'css/bookhere.css' %}">
  
  <!-- Add CSRF token for API calls -->
  <meta name="csrf-token" content="{{ csrf_token }}">
  
  <!-- Modal-specific styles -->
  <style>
    .modal-xl {
      max-width: 1200px;
    }
    
    #bookingDetailsModal .summary-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    
    #bookingDetailsModal .event-details,
    #bookingDetailsModal .booking-receipt {
      min-height: 400px;
    }
    
    @media (max-width: 768px) {
      #bookingDetailsModal .summary-container {
        flex-direction: column;
      }
      
      #bookingDetailsModal .event-details,
      #bookingDetailsModal .booking-receipt {
        flex: 1 1 100% !important;
      }
    }
  </style>
  
</head>
<body>
{% include 'navbar.html' %}

<div class="chat-wrap">

  <!-- ────────── SIDEBAR ────────── -->
  <aside class="sidebar">
    <div class="d-flex align-items-center justify-content-between border-bottom px-3 py-2">
      <span class="fw-semibold">Bookings</span>
      <a href="{% url 'bookhere' %}"
         class="btn btn-sm d-flex align-items-center gap-1"
         style="background:var(--green-dark);color:#fff;border:none;border-radius:6px;">
        <i class="fas fa-plus small"></i><span class="d-none d-md-inline">Add</span>
      </a>
    </div>

    <!-- All Bookings -->
    <ul class="list-unstyled sidebar-list m-0">
      {% for bk in all_bookings %}
        <li class="booking-item{% if forloop.first %} active{% endif %}"
          data-id="{{ bk.chat.id }}"
          data-booking="{{ bk.id }}"
          data-meta="{{ bk.event_type }} • {{ bk.event_date|date:'M j Y' }}">
          <div class="fw-semibold text-truncate">
              {{ bk.event_date|date:"M j Y" }} · {{ bk.event_type }}
          </div>
          <small class="text-muted">{{ bk.get_status_display }}</small>
        </li>
      {% empty %}
        <li class="text-muted small p-4">No bookings yet.</li>
      {% endfor %}
    </ul>

    <!-- General chat -->
    <div class="border-top">
      <li class="booking-item general-chat"
        data-id="general"
        data-meta="General chat"></li>
    </div>
  </aside>

  <!-- ────────── CHAT PANE ────────── -->
  <section class="chat-pane">
  <header id="chat-header" class="d-flex align-items-center gap-2">
    <span id="chat-meta" class="flex-grow-1">
      {% if first_chat and first_booking %}
        {{ booking_meta }}
      {% else %}
        <span class="small text-muted">Select a booking to start chatting</span>
      {% endif %}
    </span>

      <!-- View Request btn -->
      {% if first_booking %}
      <button id="viewRequestBtn" class="btn btn-outline-light btn-sm" 
              data-booking-id="{{ first_booking.id }}" 
              title="View Request Details"
              style="border-color: white; color: white;">
        <i class="fas fa-eye me-1" style="color: white;"></i> View Request
      </button>
      {% endif %}

    <!-- status btn -->
    <a id="status-link" class="btn btn-back"
       href="{% if first_booking %}{% url 'event-status' first_booking.id %}{% endif %}"
       style="{% if not first_booking %}display: none;{% endif %}">
      Status <i class="fas fa-arrow-right small"></i>
    </a>
  </header>
      <div id="chat-messages">
        {% for m in first_messages %}
          <div class="msg {% if m.sender_id == user.id %}sender{% else %}receiver{% endif %}">
            {{ m.content|safe }}
          </div>
        {% empty %}
          <div class="small text-muted text-center mt-5">No messages…</div>
        {% endfor %}
      </div>

    <form id="composer" class="composer">
      {%csrf_token%}
      {% comment %} <input type="hidden" id="csrf" value="{%csrf_token%}"> {% endcomment %}
      <textarea id="composer-input" placeholder="Type message…"></textarea>
      <button class="btn" type="submit"  id="send-message"><i class="fas fa-paper-plane"></i></button>
    </form>
  </section>

</div><!-- /.chat-wrap -->

<!-- ────────── JS ────────── -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script>
  const box = document.querySelector("#chat-messages"); 
  const form = document.querySelector("#composer");     
  const input = document.querySelector("#composer-input"); 
  const sendBtn = document.querySelector("#send-message");
  const clientId = {{ request.user.id }};
  let sock;
  let currentChatId = '{{ first_chat.id|default:"" }}';

  // Disable send button initially
  sendBtn.disabled = true;

  // Enable/disable send button based on textarea content
  input.addEventListener('input', function() {
    sendBtn.disabled = this.value.trim() === '';
  });

  function makeBubble(text, mine = false) {
      const bubble = document.createElement("div");
      bubble.className = mine ? "msg sender" : "msg receiver";
      bubble.innerHTML = text;
      return bubble;
  }

  function scrollBottom() {
      box.scrollTop = box.scrollHeight;
  }

  function connectSockJS(chatId) {
      try {
        if (sock) sock.close();
        if (!chatId || chatId === "general") return;

      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      sock = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/${chatId}/`);


      sock.onopen = () => console.log("SockJS connection opened");
      sock.onclose = () => console.warn("SockJS connection closed");
      sock.onerror = (error) => console.error("WebSocket error:", error);
      sock.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            console.log(data.sender);
          
            // Check if data has sender and content before accessing them
            if (!data.sender || !data.message) {
                console.warn("Received message without sender or content:", data);
                return;  // ignore or handle differently
            }

            const mine = data.sender.id === clientId;
            const bubble = makeBubble(data.message, mine);
            box.appendChild(bubble);
            scrollBottom();

        } catch (err) {
            console.error("Invalid SockJS data", err);
        }
    };
      } catch (err) {
        console.error("Error connecting WebSocket:", err);
      }
  }

  form.addEventListener("submit", submitMessage);

async function submitMessage(e) {
      e.preventDefault();
      const txt = document.querySelector("#composer-input").value.trim();
      //const txt = input.value.trim();
      if (!txt) return;

      const csrfInput = document.querySelector('[name="csrfmiddlewaretoken"]').value.trim();
      if (!csrfInput || !currentChatId) {
          console.error("Missing CSRF token or currentChatId");
          return;
      }

      // Optimistic UI
      //const bubble = makeBubble(txt, true);
      //box.appendChild(bubble);
      //scrollBottom();
      input.value = "";

      // Send to backend API
      try {
          await fetch(`/event-booking-send/${currentChatId}`, { 
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrfInput
              },
              body: JSON.stringify({ message: txt })
          });
      } catch (err) {
          console.error("Send failed", err);
      }
  }

  // Chat list click handler
  document.querySelectorAll(".booking-item").forEach(li => {
      li.addEventListener('click', async () => {
          const chatId = li.dataset.id;
          const bookingId = li.dataset.booking;
          const meta = li.dataset.meta;
          currentChatId = chatId;

          // Highlight selected chat
          document.querySelectorAll(".booking-item").forEach(li => li.classList.remove("active"));
          li.classList.add("active");

          // Update header metadata and status button
          const chatMetaElement = document.getElementById('chat-meta');
          const statusLinkElement = document.getElementById('status-link');
          
          if (chatMetaElement) {
              if (meta) {
                  chatMetaElement.innerHTML = `<span>${meta}</span>`;
              } else {
                  chatMetaElement.innerHTML = '<span class="small text-muted">Select a booking to start chatting</span>';
              }
          }
          
          if (statusLinkElement) {
              if (bookingId) {
                  statusLinkElement.href = `/event-status/${bookingId}/`;
                  statusLinkElement.style.display = 'block';
              } else {
                  // Hide status button for general chat
                  statusLinkElement.style.display = 'none';
              }
          }
          
          // Update View Request button's booking ID
          const viewRequestBtn = document.getElementById('viewRequestBtn');
          if (viewRequestBtn) {
              if (bookingId) {
                  viewRequestBtn.setAttribute('data-booking-id', bookingId);
                  viewRequestBtn.style.display = 'block';
              } else {
                  // Hide View Request button for general chat
                  viewRequestBtn.style.display = 'none';
              }
          }

          // Fetch messages
          const res = await fetch(`/chat/${chatId}/messages-json/`);
          const json = await res.json();
          box.innerHTML = "";
          json.forEach((msg) => {
              const mine = msg.mine;
              const bubble = makeBubble(msg.html, mine);
              box.appendChild(bubble);
          });
          scrollBottom();

          // Reconnect SockJS
          connectSockJS(chatId);
      });
  });

  // Initial SockJS connection
  {% if first_chat %}
    connectSockJS('{{ first_chat.id }}');
  {% endif %}
</script>

<!-- User Notification Modal -->
{% if user.is_authenticated %}
<div class="modal fade user-notification-modal" id="userNotificationModal" tabindex="-1" aria-labelledby="userNotificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userNotificationModalLabel">
          <i class="fas fa-bell"></i> Notifications
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="userNotificationList" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
          <div class="text-center p-4 text-muted">
            <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
            <p>No new notifications</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn" style="background: #AD974F; color: white;" onclick="markAllUserNotificationsAsRead()">
          Mark All as Read
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Notification Styles -->
<style>
.notification-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  color: inherit;
}

.notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #AD974F;
  color: #fff;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 10px;
  min-width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.user-notification-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  border: none;
}

.user-notification-modal .modal-header {
  background: #AD974F;
  color: #fff;
  border-radius: 10px 10px 0 0;
}

.user-notification-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  transition: background 0.2s;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.user-notification-item:hover {
  background: #f8f9fa;
}

.user-notification-item:last-child {
  border-bottom: none;
}

.user-notification-icon {
  width: 40px;
  height: 40px;
  background: #AD974F;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  flex-shrink: 0;
}

.user-notification-content {
  flex-grow: 1;
  min-width: 0;
  overflow: hidden;
}

.user-notification-title {
  font-weight: 600;
  color: #222;
  margin-bottom: 5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.user-notification-text {
  color: #666;
  font-size: 14px;
  margin-bottom: 5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
}

.user-notification-time {
  color: #999;
  font-size: 12px;
}

.user-notification-sender {
  color: #AD974F;
  font-size: 12px;
  font-weight: 500;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.user-notification-item:hover {
  background-color: #f8f9fa !important;
  transform: translateX(2px);
}

.toast-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: #AD974F;
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
  max-width: 350px;
  animation: slideIn 0.3s ease-out;
}
</style>

<!-- User Notification JavaScript -->
<script>
let userNotificationCount = 0;
let userNotifications = [];

// Initialize user notification system
document.addEventListener('DOMContentLoaded', function() {
  loadUserNotifications();
  setupRealtimeUserNotifications();
});

function loadUserNotifications() {
  fetch('/notifications/')
    .then(response => response.json())
    .then(data => {
      userNotifications = data.notifications;
      updateUserNotificationUI();
    })
    .catch(err => console.error('Error loading user notifications:', err));
}

function updateUserNotificationUI() {
  const badge = document.getElementById('userNotificationBadge');
  const list = document.getElementById('userNotificationList');
  
  const unreadCount = userNotifications.filter(n => !n.is_read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
  
  if (userNotifications.length === 0) {
    list.innerHTML = `
      <div class="text-center p-4 text-muted">
        <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
        <p>No new notifications</p>
      </div>
    `;
  } else {
    list.innerHTML = userNotifications.map(notification => {
      // Determine icon based on notification type
      let icon = 'fas fa-envelope'; // default for admin message
      if (notification.notification_type === 'booking_update') {
        icon = 'fas fa-calendar-check';
      } else if (notification.notification_type === 'event_reminder') {
        icon = 'fas fa-clock';
      } else if (notification.notification_type === 'payment_update') {
        icon = 'fas fa-credit-card';
      }
      
      return `
        <div class="user-notification-item d-flex ${notification.is_read ? '' : 'bg-light'}" 
             data-id="${notification.id}" 
             data-booking-id="${notification.booking_id || ''}"
             data-notification-type="${notification.notification_type || 'admin_message'}"
             onclick="handleUserNotificationClick(this)"
             style="cursor: pointer; transition: all 0.2s ease;">
          <div class="user-notification-icon">
            <i class="${icon}"></i>
          </div>
          <div class="user-notification-content">
            <div class="user-notification-title">${notification.title}</div>
            <div class="user-notification-text">${notification.message}</div>
            <div class="user-notification-sender">From: ${notification.sender_name}</div>
            <div class="user-notification-time">${notification.created_at}</div>
          </div>
          ${!notification.is_read ? '<div class="text-primary"><i class="fas fa-circle" style="font-size: 8px;"></i></div>' : ''}
        </div>
      `;
    }).join('');
  }
}

function addUserNotification(data) {
  userNotifications.unshift({
    id: data.id,
    title: data.title,
    message: data.message,
    created_at: data.created_at,
    booking_id: data.booking_id,
    sender_name: data.sender_name,
    notification_type: data.type === 'booking_update' ? 'booking_update' : (data.type === 'event_reminder' ? 'event_reminder' : (data.type === 'payment_update' ? 'payment_update' : 'admin_message')),
    is_read: false
  });
  updateUserNotificationUI();
  
  // Show toast notification
  showUserToast(data.title, data.message);
}

function showUserToast(title, message) {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${title}</div>
    <div style="font-size: 14px; opacity: 0.9;">${message}</div>
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 5 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 5000);
}

function markAllUserNotificationsAsRead() {
  fetch('/notifications/mark-all-read/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      userNotifications.forEach(n => n.is_read = true);
      updateUserNotificationUI();
    }
  })
  .catch(err => console.error('Error marking user notifications as read:', err));
}

function setupRealtimeUserNotifications() {
  try {
    // Use Server-Sent Events for real-time notifications
    const eventSource = new EventSource('/notifications/stream/');
    
    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'admin_message' || data.type === 'booking_update' || data.type === 'event_reminder' || data.type === 'payment_update') {
          addUserNotification(data);
        }
      } catch (err) {
        console.error('Error parsing user notification data:', err);
      }
    };
    
    eventSource.onerror = function(event) {
      console.warn('User notification stream error:', event);
      // Optionally retry connection after a delay
      setTimeout(() => {
        if (eventSource.readyState === EventSource.CLOSED) {
          setupRealtimeUserNotifications();
        }
      }, 5000);
    };
  } catch (err) {
    console.error('Error setting up notification stream:', err);
  }
}

// Handle notification click to navigate to booking or relevant page
function handleUserNotificationClick(element) {
  if (!element) {
    console.error('Element is null or undefined');
    return;
  }
  const bookingId = element.getAttribute('data-booking-id');
  const notificationId = element.getAttribute('data-id');
  const notificationType = element.getAttribute('data-notification-type');
  
  // Mark notification as read immediately
  markUserNotificationAsReadOnServer(notificationId);
  markUserNotificationAsRead(notificationId);
  
  // Close the modal first
  const modal = bootstrap.Modal.getInstance(document.getElementById('userNotificationModal'));
  if (modal) {
    modal.hide();
  }
  
  // Handle different notification types
  if (bookingId && bookingId !== 'null' && bookingId !== '') {
    if (notificationType === 'admin_message') {
      // We're already on my_bookings page, just highlight the relevant booking
      const bookingElement = document.querySelector(`[data-booking="${bookingId}"]`);
      if (bookingElement) {
        // Click on the booking to open it
        bookingElement.click();
      }
    } else {
      // Navigate to event status page for booking updates and payment updates
      window.location.href = `/event-status/${bookingId}/`;
    }
  } else {
    // For general notifications, just close the modal
    console.log('General notification clicked');
  }
}

function markUserNotificationAsRead(notificationId) {
  // Update the notification visually
  const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
  if (notificationElement) {
    notificationElement.classList.remove('bg-light');
    const unreadIndicator = notificationElement.querySelector('.text-primary');
    if (unreadIndicator) {
      unreadIndicator.remove();
    }
  }
  
  // Update the notifications array
  const notification = userNotifications.find(n => n.id == notificationId);
  if (notification) {
    notification.is_read = true;
  }
  
  // Update badge count
  updateUserNotificationUI();
}

function markUserNotificationAsReadOnServer(notificationId) {
  fetch(`/notifications/${notificationId}/mark-read/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('User notification marked as read on server');
    }
  })
  .catch(err => console.error('Error marking user notification as read:', err));
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
</script>
{% endif %}

<!-- Booking Details Modal - Popup Modal with bookhere.html content -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookingDetailsModalLabel">Booking Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Booking Summary Section - Modal Version -->
        <div class="summary-container" style="display: flex; gap: 2rem; margin: 0;">
          <!-- Left column: Event Details -->
          <div class="event-details" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0;">
            <div id="booking-summary-content">
              <!-- Summary content will be generated by JavaScript -->
            </div>
          </div>

          <!-- Right column: Receipt -->
          <div class="booking-receipt" style="flex: 1 1 50%; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin: 0; height: fit-content;">
            <div id="booking-receipt">
              <!-- Export PDF Button -->
              <button type="button" id="export-pdf-btn" class="export-btn">
                📄 Export PDF
              </button>
              
              <!-- Receipt content will be generated by JavaScript -->
              <div id="receipt-content">
                <!-- Receipt will be generated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// View Request button functionality
document.addEventListener('DOMContentLoaded', function() {
  const viewRequestBtn = document.getElementById('viewRequestBtn');
  
  if (viewRequestBtn) {
    viewRequestBtn.addEventListener('click', async function () {
      const bookingId = this.dataset.bookingId;
      if (bookingId) {
        try {
          // Get CSRF token from meta tag
          const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
          const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
          
          // Fetch booking details from the API
          const response = await fetch(`/api/booking/${bookingId}/details/`, {
            method: 'GET',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
          });
          if (response.ok) {
            const booking = await response.json();
            
            // Generate the booking summary exactly like bookhere.html
            showBookingSummary(booking);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
            modal.show();
          } else {
            alert('Failed to load booking details');
          }
        } catch (error) {
          console.error('Error fetching booking details:', error);
          alert('Error loading booking details');
        }
      }
    });
  }
  
  // Show booking summary function - copied and adapted from bookhere.html
  function showBookingSummary(booking) {
    const summaryContainer = document.getElementById('booking-summary-content');
    const receiptContainer = document.getElementById('receipt-content');
    if (!summaryContainer || !receiptContainer) return;

    // Clear previous content
    summaryContainer.innerHTML = '';
    receiptContainer.innerHTML = '';

    // Create summary sections exactly like bookhere.html
    const sections = [
      {
        title: 'Event Details',
        items: [
          { label: 'Celebrant Name', value: booking.celebrant_name },
          { label: 'Event Date', value: booking.event_date },
          { label: 'Event Type', value: booking.event_type },
          { label: 'Number of Guests', value: `${booking.pax} Pax` },
          { label: 'Color Motif', value: booking.color_motif, showColorPreview: true, colors: booking.color_motif_with_images }
        ]
      },
      {
        title: 'Theme & Venue',
        items: [
          { label: 'Theme', value: booking.theme_name },
          { label: 'Venue', value: booking.venue },
          { label: 'Floor Plan', value: booking.floorplan_name || 'Not Selected' },
          { label: 'Package', value: booking.package }
        ]
      },
      {
        title: 'Food Menu',
        items: [],
        showFoodImages: true,
        dishes: booking.dishes_with_images || [],
        pasta: { name: booking.pasta, image: booking.pasta_image },
        drink: { name: booking.drink, image: booking.drink_image }
      }
    ];

    sections.forEach(section => {
      const sectionDiv = document.createElement('div');
      sectionDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
      
      const titleDiv = document.createElement('h3');
      titleDiv.textContent = section.title;
      titleDiv.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
      sectionDiv.appendChild(titleDiv);

      if (section.showFoodImages) {
        // Show selected food items with images
        const foodGrid = document.createElement('div');
        foodGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;';
        
        // Add dishes
        if (section.dishes && section.dishes.length > 0) {
          section.dishes.forEach(dish => {
            const foodItem = document.createElement('div');
            foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
            
            if (dish.image_url) {
              const img = document.createElement('img');
              img.src = dish.image_url;
              img.alt = dish.name;
              img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
              img.onerror = function() {
                this.style.display = 'none';
              };
              foodItem.appendChild(img);
            }
            
            const label = document.createElement('div');
            label.textContent = dish.name;
            label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
            foodItem.appendChild(label);
            
            foodGrid.appendChild(foodItem);
          });
        }
        
        // Add pasta if exists
        if (section.pasta && section.pasta.name) {
          const foodItem = document.createElement('div');
          foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
          
          if (section.pasta.image) {
            const img = document.createElement('img');
            img.src = section.pasta.image;
            img.alt = section.pasta.name;
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
            img.onerror = function() {
              this.style.display = 'none';
            };
            foodItem.appendChild(img);
          }
          
          const label = document.createElement('div');
          label.textContent = section.pasta.name;
          label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
          foodItem.appendChild(label);
          
          foodGrid.appendChild(foodItem);
        }
        
        // Add drink if exists
        if (section.drink && section.drink.name) {
          const foodItem = document.createElement('div');
          foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
          
          if (section.drink.image) {
            const img = document.createElement('img');
            img.src = section.drink.image;
            img.alt = section.drink.name;
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
            img.onerror = function() {
              this.style.display = 'none';
            };
            foodItem.appendChild(img);
          }
          
          const label = document.createElement('div');
          label.textContent = section.drink.name;
          label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
          foodItem.appendChild(label);
          
          foodGrid.appendChild(foodItem);
        }
        
        sectionDiv.appendChild(foodGrid);
      } else {
        // Regular items
        section.items.forEach(item => {
          if (item.value) {
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'margin: 8px 0; display: flex; justify-content: space-between; align-items: center;';
            
            const labelSpan = document.createElement('span');
            labelSpan.textContent = item.label + ':';
            labelSpan.style.cssText = 'font-weight: 600; color: #555;';
            
            if (item.showColorPreview && item.colors && item.colors.length > 0) {
              // Create color preview container
              const colorContainer = document.createElement('div');
              colorContainer.style.cssText = 'display: flex; align-items: center; gap: 10px;';
              
              // Add text value
              const valueSpan = document.createElement('span');
              valueSpan.textContent = item.value;
              valueSpan.style.cssText = 'color: #333; font-size: 0.9rem;';
              colorContainer.appendChild(valueSpan);
              
              // Add color swatches with actual images
              const swatchContainer = document.createElement('div');
              swatchContainer.style.cssText = 'display: flex; gap: 3px;';
              
              item.colors.forEach((colorItem, index) => {
                
                const colorPreview = document.createElement('div');
                
                // Always ensure the basic styling is applied first
                colorPreview.style.cssText = `
                  width: 25px; 
                  height: 25px; 
                  border-radius: 4px; 
                  border: 2px solid #B8860B;
                  position: relative;
                  display: inline-block;
                `;
                
                // Then apply the background image if available
                if (colorItem.image_url) {
                  colorPreview.style.backgroundImage = `url('${colorItem.image_url}')`;
                  colorPreview.style.backgroundSize = 'cover';
                  colorPreview.style.backgroundPosition = 'center';
                } else {
                  colorPreview.style.backgroundColor = '#f0f0f0';
                }
                
                // Add order number
                const orderNum = document.createElement('div');
                orderNum.textContent = index + 1;
                orderNum.style.cssText = `
                  position: absolute;
                  bottom: -2px;
                  right: -2px;
                  background: #B8860B;
                  color: white;
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  font-size: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                `;
                colorPreview.appendChild(orderNum);
                swatchContainer.appendChild(colorPreview);
              });
              
              colorContainer.appendChild(swatchContainer);
              itemDiv.appendChild(colorContainer);
            } else {
              const valueSpan = document.createElement('span');
              valueSpan.textContent = item.value;
              valueSpan.style.cssText = 'color: #333; text-align: right; max-width: 60%; word-break: break-word;';
              itemDiv.appendChild(valueSpan);
            }
            
            itemDiv.insertBefore(labelSpan, itemDiv.firstChild);
            sectionDiv.appendChild(itemDiv);
          }
        });
      }

      summaryContainer.appendChild(sectionDiv);
    });

    // Add theme images if available (same as bookhere.html)
    if (booking.theme_urls && booking.theme_urls.length > 0) {
      const themeImagesDiv = document.createElement('div');
      themeImagesDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: 100%;';
      
      const themeTitle = document.createElement('h3');
      themeTitle.textContent = 'Theme Images';
      themeTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
      themeImagesDiv.appendChild(themeTitle);

      const imagesContainer = document.createElement('div');
      imagesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;';
      
      booking.theme_urls.slice(0, 3).forEach(imageUrl => {
        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
        img.alt = booking.theme_name;
        imagesContainer.appendChild(img);
      });

      themeImagesDiv.appendChild(imagesContainer);
      summaryContainer.appendChild(themeImagesDiv);
    }
    
    // Generate the receipt
    generateReceipt(receiptContainer, booking);
  }

  // Generate receipt function - adapted from bookhere.html
  function generateReceipt(container, booking) {
    // Receipt header
    const header = document.createElement('div');
    header.style.cssText = 'text-align: center; margin-bottom: 20px; border-bottom: 2px solid rgb(51, 51, 51); padding-bottom: 15px; display: flex; flex-direction: column';
    
    const companyName = document.createElement('h2');
    companyName.textContent = 'NIKE\'S CATERING SERVICES';
    companyName.style.cssText = 'margin: 0; color: #B8860B; font-size: 1.4rem; font-weight: bold;';
    
    const tagline = document.createElement('p');
    tagline.textContent = 'Celebrate with Nikes!';
    tagline.style.cssText = 'margin: 5px 0 0 0; color: #666; font-size: 0.9rem;';
    
    const receiptTitle = document.createElement('h3');
    receiptTitle.textContent = 'BOOKING RECEIPT';
    receiptTitle.style.cssText = 'margin: 15px 0 0 0; color: #333; font-size: 1.1rem;';
    
    header.appendChild(companyName);
    header.appendChild(tagline);
    header.appendChild(receiptTitle);
    container.appendChild(header);

    // Receipt details
    const details = document.createElement('div');
    details.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; justify-items: flex-start; margin-bottom: 20px;';
    
    const receiptItems = [
        { label: 'Booking Date', value: new Date().toLocaleDateString() },
        { label: 'Event Date', value: booking.event_date },
        { label: 'Celebrant', value: booking.celebrant_name },
        { label: 'Event Type', value: booking.event_type },
        { label: 'Guests', value: `${booking.pax} Pax` },
        { label: 'Theme', value: booking.theme_name },
        { label: 'Venue', value: booking.venue },
        { label: 'Package', value: booking.package },
        { label: 'Color Motif', value: booking.color_motif }
    ];

    receiptItems.forEach(item => {
        if (item.value) {
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'margin: 5px 0; display: flex; justify-content: space-between; width: 100%;';
            
            const label = document.createElement('span');
            label.textContent = item.label + ':';
            label.style.cssText = 'font-weight: 600; color: #555;';
            
            const value = document.createElement('span');
            value.textContent = item.value;
            value.style.cssText = 'color: #333;';
            
            itemDiv.appendChild(label);
            itemDiv.appendChild(value);
            details.appendChild(itemDiv);
        }
    });

    container.appendChild(details);

    // Contact info footer
    const footer = document.createElement('div');
    footer.style.cssText = 'margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 0.85rem; color: #666;';
    footer.innerHTML = '<p style="margin: 0;">Contact: nikes.catering@gmail.com | (02) 123-4567</p><p style="margin: 5px 0 0 0;">Thank you for choosing Nike\'s Catering!</p>';
    container.appendChild(footer);
  }

  // Helper function to format colors for display
  function formatColorsForDisplay(colors, separator = ' → ') {
    if (!colors || colors.length === 0) return 'Not specified';
    
    if (typeof colors === 'string') {
      return colors;
    }
    
    return colors.map(color => {
      if (color.startsWith('custom_')) {
        return color.replace('custom_', '');
      }
      return color;
    }).join(separator);
  }

  // PDF Export functionality - adapted from bookhere.html
  // Package pricing configuration - Based on actual package images analysis
  const packagePricing = {
      'Wedding': {
          'Package A': { 
              50: 40000, 60: 45000, 70: 50000, 80: 55000, 100: 60000, 
              120: 65000, 130: 70000, 150: 75000, 160: 80000, 170: 85000, 
              180: 95000, 200: 100000, 250: 125000 
          },
          'Package B': { 
              50: 45000, 60: 50000, 70: 55000, 80: 60000, 100: 65000, 
              120: 70000, 130: 75000, 150: 85000, 160: 90000, 170: 95000, 
              180: 105000, 200: 110000, 250: 145000 
          },
          'Package C': { 
              50: 50000, 60: 55000, 70: 60000, 80: 65000, 100: 70000, 
              120: 75000, 130: 80000, 150: 95000, 160: 100000, 170: 105000, 
              180: 115000, 200: 120000, 250: 165000 
          }
      },
      'Birthday Party': {
          'Package A': { 
              50: 35000, 70: 40000, 80: 45000, 100: 50000, 
              120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
              180: 85000, 200: 90000 
          },
          'Package B': { 
              50: 40000, 70: 45000, 80: 50000, 100: 55000, 
              120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
              180: 95000, 200: 100000 
          },
          'Package C': { 
              50: 45000, 70: 50000, 80: 55000, 100: 60000, 
              120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
              180: 105000, 200: 110000 
          }
      },
      'Kiddie Party': {
          'Package A': { 50: 30000, 70: 35000, 80: 40000, 100: 45000 },
          'Package B': { 50: 35000, 70: 40000, 80: 45000, 100: 50000 },
          'Package C': { 50: 40000, 70: 45000, 80: 50000, 100: 55000 }
      },
      'Baptismal': {
          'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
          'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
          'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
      },
      'Christening': {
          'Package A': { 50: 35000, 70: 40000, 80: 45000, 100: 50000, 120: 60000, 150: 70000 },
          'Package B': { 50: 40000, 70: 45000, 80: 50000, 100: 55000, 120: 65000, 150: 80000 },
          'Package C': { 50: 45000, 70: 50000, 80: 55000, 100: 60000, 120: 70000, 150: 90000 }
      }
  };

  // Custom event per-head pricing
  const customEventPricing = {
      'Below 100 pax': { 'Package A': 500, 'Package B': 600, 'Package C': 700 },
      '100+ pax': { 'Package A': 450, 'Package B': 550, 'Package C': 650 }
  };

  // Add-ons pricing
  const addonPricing = {
      'Photo Booth': 8000,
      'LED Wall': 15000,
      'Ceremony Styling': 10000,
      'Photo and Video Coverage': 5000,
      'Face Painting and Bubble Show': 5000,
      'Digital Invitations': 3000
  };

  // Calculate package price based on exact pax pricing
  function calculatePackagePrice(packageName, eventType, pax) {
      // Handle custom events with per-head pricing
      if (eventType && !packagePricing[eventType]) {
          // This is a custom event, use per-head pricing
          const pricingTier = pax >= 100 ? '100+ pax' : 'Below 100 pax';
          const perHeadPrice = customEventPricing[pricingTier][packageName];
          if (perHeadPrice) {
              return perHeadPrice * pax;
          }
          return 0;
      }

      const eventPricing = packagePricing[eventType];
      if (!eventPricing || !eventPricing[packageName]) {
          return 0;
      }

      const packagePrices = eventPricing[packageName];
      
      // Check if exact pax count exists
      if (packagePrices[pax]) {
          return packagePrices[pax];
      }
      
      // Find the closest lower and higher pax counts for interpolation
      const availablePax = Object.keys(packagePrices).map(Number).sort((a, b) => a - b);
      let lowerPax = null;
      let higherPax = null;
      
      for (let i = 0; i < availablePax.length; i++) {
          if (availablePax[i] <= pax) {
              lowerPax = availablePax[i];
          }
          if (availablePax[i] >= pax && !higherPax) {
              higherPax = availablePax[i];
              break;
          }
      }
      
      // If pax is lower than minimum, use minimum price
      if (!lowerPax) {
          return packagePrices[availablePax[0]];
      }
      
      // If pax is higher than maximum, use maximum price
      if (!higherPax) {
          return packagePrices[lowerPax];
      }
      
      // If exact match found, return it
      if (lowerPax === pax) {
          return packagePrices[lowerPax];
      }
      
      // Interpolate between lower and higher pax
      const lowerPrice = packagePrices[lowerPax];
      const higherPrice = packagePrices[higherPax];
      const ratio = (pax - lowerPax) / (higherPax - lowerPax);
      return Math.round(lowerPrice + (higherPrice - lowerPrice) * ratio);
  }

  function exportReceiptToPDF(booking) {
    try {
      console.log('Exporting PDF...');
      console.log('jsPDF available:', typeof window.jspdf);
      console.log('booking data:', booking);
      
      // Check if jsPDF is available
      if (typeof window.jspdf === 'undefined') {
        console.error('jsPDF library not loaded');
        alert('PDF library not loaded. Please refresh the page and try again.');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      console.log('jsPDF constructor:', jsPDF);
      const doc = new jsPDF();
      console.log('PDF document created:', doc);
      
      // Set up the PDF document
      doc.setFontSize(20);
      doc.setFont(undefined, 'bold');
      doc.text('NIKE\'S CATERING SERVICES', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text('Celebrate with Nikes!', 105, 30, { align: 'center' });
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('BOOKING RECEIPT', 105, 45, { align: 'center' });
      
      // Add a line
      doc.setLineWidth(0.5);
      doc.line(20, 50, 190, 50);
      
      // Receipt details
      let yPosition = 65;
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      const receiptData = [
          { label: 'Booking Date:', value: new Date().toLocaleDateString() },
          { label: 'Event Date:', value: booking.event_date || 'Not specified' },
          { label: 'Celebrant:', value: booking.celebrant_name || 'Not specified' },
          { label: 'Event Type:', value: booking.event_type || 'Not specified' },
          { label: 'Number of Guests:', value: booking.pax ? `${booking.pax} Pax` : 'Not specified' },
          { label: 'Theme:', value: booking.theme_name || 'Not specified' },
          { label: 'Venue:', value: booking.venue || 'Not specified' },
          { label: 'Package:', value: booking.package || 'Not specified' },
          { label: 'Color Motif:', value: formatColorsForDisplay(booking.color_motif, ', ') }
      ];
      
      receiptData.forEach(item => {
          doc.text(item.label, 20, yPosition);
          doc.text(item.value, 80, yPosition);
          yPosition += 7;
      });
      
      // Add food menu if available - combined format like bookhere
      const menuItems = [];
      if (booking.dishes_with_images && booking.dishes_with_images.length > 0) {
          booking.dishes_with_images.forEach(dish => {
              menuItems.push(dish.name);
          });
      }
      if (booking.pasta) {
          menuItems.push(booking.pasta);
      }
      if (booking.drink) {
          menuItems.push(booking.drink);
      }
      
      if (menuItems.length > 0) {
          yPosition += 10;
          doc.setFont(undefined, 'bold');
          doc.text('Selected Menu:', 20, yPosition);
          yPosition += 7;
          doc.setFont(undefined, 'normal');
          
          menuItems.forEach((item, index) => {
              doc.text(`${index + 1}. ${item}`, 25, yPosition);
              yPosition += 6;
          });
      } else {
          yPosition += 10;
          doc.setFont(undefined, 'bold');
          doc.text('Selected Menu:', 20, yPosition);
          yPosition += 7;
          doc.setFont(undefined, 'normal');
          doc.text('No menu selected', 25, yPosition);
          yPosition += 6;
      }
      
      // Add floor plan if available
      if (booking.floorplan_display_name || booking.floorplan_name) {
          yPosition += 10;
          doc.setFont(undefined, 'bold');
          doc.text('Floor Plan:', 20, yPosition);
          yPosition += 7;
          doc.setFont(undefined, 'normal');
          doc.text(booking.floorplan_display_name || booking.floorplan_name, 25, yPosition);
          yPosition += 6;
      }
      
      // Add pricing section
      yPosition += 15;
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('PRICE ESTIMATION', 105, yPosition, { align: 'center' });
      yPosition += 10;
      
      // Add a line
      doc.setLineWidth(0.3);
      doc.line(20, yPosition, 190, yPosition);
      yPosition += 8;
      
      // Calculate package price
      const packagePrice = calculatePackagePrice(booking.package, booking.event_type, booking.pax);
      
      // Package price
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`${booking.package}:`, 20, yPosition);
      doc.text(`PHP ${packagePrice.toLocaleString()}`, 150, yPosition);
      yPosition += 7;
      
      // Add-ons (placeholder - could be enhanced if add-on data is available)
      // For now, we'll skip add-ons since booking data doesn't include them
      
      // Total price (same as package price for now)
      const totalPrice = packagePrice;
      yPosition += 8;
      doc.setLineWidth(0.3);
      doc.line(20, yPosition, 190, yPosition);
      yPosition += 8;
      
      doc.setFont(undefined, 'bold');
      doc.setFontSize(11);
      doc.text('TOTAL:', 20, yPosition);
      doc.text(`PHP ${totalPrice.toLocaleString()}`, 150, yPosition);
      yPosition += 10;
      
      // Add footer
      yPosition += 15;
      doc.setLineWidth(0.3);
      doc.line(20, yPosition, 190, yPosition);
      yPosition += 10;
      
      doc.setFontSize(9);
      doc.text('Thank you for choosing Nike\'s Catering Services!', 105, yPosition, { align: 'center' });
      yPosition += 6;
      doc.text('Contact: nikescateringofficial@gmail.com', 105, yPosition, { align: 'center' });
      yPosition += 6;
      doc.text('Phone: +63 123 456 7890', 105, yPosition, { align: 'center' });
      
      // Save the PDF
      const celebrantName = booking.celebrant_name ? booking.celebrant_name.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown';
      const eventDate = booking.event_date ? booking.event_date.replace(/\//g, '-') : 'Unknown_Date';
      const fileName = `Nike_Catering_Receipt_${celebrantName}_${eventDate}.pdf`;
      
      console.log('Saving PDF as:', fileName);
      doc.save(fileName);
      
      // Show success message
      alert('Receipt downloaded successfully!');
      
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    }
  }

  // Add event listener for PDF export button
  let currentBooking = null;
  
  // Store booking data when modal is shown
  const originalShowBookingSummary = showBookingSummary;
  showBookingSummary = function(booking) {
    currentBooking = booking;
    originalShowBookingSummary(booking);
    
    // Set up PDF export listener
    setTimeout(() => {
      const exportBtn = document.getElementById('export-pdf-btn');
      if (exportBtn) {
        exportBtn.onclick = function() {
          console.log('Export PDF button clicked!');
          exportReceiptToPDF(currentBooking);
        };
      }
    }, 100);
  };
});
</script>

</body>
</html>
