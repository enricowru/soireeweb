{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bookings · Nike’s Catering</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/my_bookings.css' %}">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
</head>
<body>
{% include 'navbar.html' %}

<div class="chat-wrap">

  <!-- ────────── SIDEBAR ────────── -->
  <aside class="sidebar">
    <div class="d-flex align-items-center justify-content-between border-bottom px-3 py-2">
      <span class="fw-semibold">Bookings</span>
      <a href="{% url 'bookhere' %}"
         class="btn btn-sm d-flex align-items-center gap-1"
         style="background:var(--green-dark);color:#fff;border:none;border-radius:6px;">
        <i class="fas fa-plus small"></i><span class="d-none d-md-inline">Add</span>
      </a>
    </div>

    <!-- All Bookings -->
    <ul class="list-unstyled sidebar-list m-0">
      {% for bk in all_bookings %}
        <li class="booking-item{% if forloop.first %} active{% endif %}"
          data-id="{{ bk.chat.id }}"
          data-booking="{{ bk.id }}"
          data-meta="{{ bk.event_type }} • {{ bk.event_date|date:'M j Y' }}">
          <div class="fw-semibold text-truncate">
              {{ bk.event_date|date:"M j Y" }} · {{ bk.event_type }}
          </div>
          <small class="text-muted">{{ bk.get_status_display }}</small>
        </li>
      {% empty %}
        <li class="text-muted small p-4">No bookings yet.</li>
      {% endfor %}
    </ul>

    <!-- General chat -->
    <div class="border-top">
      <li class="booking-item general-chat"
        data-id="general"
        data-meta="General chat"></li>
    </div>
  </aside>

  <!-- ────────── CHAT PANE ────────── -->
  <section class="chat-pane">
  <header id="chat-header" class="d-flex align-items-center gap-2">
    {% if first_chat and first_booking %}
      <span id="chat-meta" class="flex-grow-1">{{ booking_meta }}</span>

      <!-- View Request btn -->
      <button id="viewRequestBtn" class="btn btn-outline-light btn-sm" 
              data-booking-id="{{ first_booking.id }}" 
              title="View Request Details"
              style="border-color: #3b6255; color: #3b6255;">
        <i class="fas fa-eye me-1" style="color: #3b6255;"></i> View Request
      </button>

      <!-- status btn -->
     <a id="status-link" class="btn btn-back"
      href="{% url 'event-status' first_booking.id %}">
      Status <i class="fas fa-arrow-right small"></i>
    </a>
    

    {% else %}
      <span class="small text-muted">Select a booking to start chatting</span>
    {% endif %}
  </header>
      <div id="chat-messages">
        {% for m in first_messages %}
          <div class="msg {% if m.sender_id == user.id %}sender{% else %}receiver{% endif %}">
            {{ m.content|safe }}
          </div>
        {% empty %}
          <div class="small text-muted text-center mt-5">No messages…</div>
        {% endfor %}
      </div>

    <form id="composer" class="composer">
      {%csrf_token%}
      {% comment %} <input type="hidden" id="csrf" value="{%csrf_token%}"> {% endcomment %}
      <textarea id="composer-input" placeholder="Type message…"></textarea>
      <button class="btn" type="submit"  id="send-message"><i class="fas fa-paper-plane"></i></button>
    </form>
  </section>

</div><!-- /.chat-wrap -->

<!-- ────────── JS ────────── -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script>
  const box = document.querySelector("#chat-messages"); 
  const form = document.querySelector("#composer");     
  const input = document.querySelector("#composer-input"); 
  const sendBtn = document.querySelector("#send-message");
  const clientId = {{ request.user.id }};
  let sock;
  let currentChatId = '{{ first_chat.id|default:"" }}';

  // Disable send button initially
  sendBtn.disabled = true;

  // Enable/disable send button based on textarea content
  input.addEventListener('input', function() {
    sendBtn.disabled = this.value.trim() === '';
  });

  function makeBubble(text, mine = false) {
      const bubble = document.createElement("div");
      bubble.className = mine ? "msg sender" : "msg receiver";
      bubble.innerHTML = text;
      return bubble;
  }

  function scrollBottom() {
      box.scrollTop = box.scrollHeight;
  }

  function connectSockJS(chatId) {
      if (sock) sock.close();
      if (!chatId || chatId === "general") return;

      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      sock = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/${chatId}/`);


      sock.onopen = () => console.log("SockJS connection opened");
      sock.onclose = () => console.warn("SockJS connection closed");
      sock.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            console.log(data.sender);
          
            // Check if data has sender and content before accessing them
            if (!data.sender || !data.message) {
                console.warn("Received message without sender or content:", data);
                return;  // ignore or handle differently
            }

            const mine = data.sender.id === clientId;
            const bubble = makeBubble(data.message, mine);
            box.appendChild(bubble);
            scrollBottom();

        } catch (err) {
            console.error("Invalid SockJS data", err);
        }
    };
  }

  form.addEventListener("submit", submitMessage);

async function submitMessage(e) {
      e.preventDefault();
      const txt = document.querySelector("#composer-input").value.trim();
      //const txt = input.value.trim();
      if (!txt) return;

      const csrfInput = document.querySelector('[name="csrfmiddlewaretoken"]').value.trim();
      if (!csrfInput || !currentChatId) {
          console.error("Missing CSRF token or currentChatId");
          return;
      }

      // Optimistic UI
      //const bubble = makeBubble(txt, true);
      //box.appendChild(bubble);
      //scrollBottom();
      input.value = "";

      // Send to backend API
      try {
          await fetch(`/event-booking-send/${currentChatId}`, { 
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrfInput
              },
              body: JSON.stringify({ message: txt })
          });
      } catch (err) {
          console.error("Send failed", err);
      }
  }

  // Chat list click handler
  document.querySelectorAll(".booking-item").forEach(li => {
      li.addEventListener('click', async () => {
          const chatId = li.dataset.id;
          const bookingId = li.dataset.booking;
          const meta = li.dataset.meta;
          currentChatId = chatId;

          // Highlight selected chat
          document.querySelectorAll(".booking-item").forEach(li => li.classList.remove("active"));
          li.classList.add("active");

          // Update header metadata and status button
          const chatMetaElement = document.getElementById('chat-meta');
          const statusLinkElement = document.getElementById('status-link');
          
          if (chatMetaElement && meta) {
              chatMetaElement.textContent = meta;
          }
          
          if (statusLinkElement) {
              if (bookingId) {
                  statusLinkElement.href = `/event-status/${bookingId}/`;
                  statusLinkElement.style.display = 'block';
              } else {
                  // Hide status button for general chat
                  statusLinkElement.style.display = 'none';
              }
          }

          // Fetch messages
          const res = await fetch(`/chat/${chatId}/messages-json/`);
          const json = await res.json();
          box.innerHTML = "";
          json.forEach((msg) => {
              const mine = msg.mine;
              const bubble = makeBubble(msg.html, mine);
              box.appendChild(bubble);
          });
          scrollBottom();

          // Reconnect SockJS
          connectSockJS(chatId);
      });
  });

  // Initial SockJS connection
  {% if first_chat %}
    connectSockJS('{{ first_chat.id }}');
  {% endif %}
</script>

<!-- User Notification Modal -->
{% if user.is_authenticated %}
<div class="modal fade user-notification-modal" id="userNotificationModal" tabindex="-1" aria-labelledby="userNotificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userNotificationModalLabel">
          <i class="fas fa-bell"></i> Notifications
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="userNotificationList" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
          <div class="text-center p-4 text-muted">
            <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
            <p>No new notifications</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn" style="background: #AD974F; color: white;" onclick="markAllUserNotificationsAsRead()">
          Mark All as Read
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Notification Styles -->
<style>
.notification-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  color: inherit;
}

.notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #AD974F;
  color: #fff;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 10px;
  min-width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.user-notification-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  border: none;
}

.user-notification-modal .modal-header {
  background: #AD974F;
  color: #fff;
  border-radius: 10px 10px 0 0;
}

.user-notification-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  transition: background 0.2s;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.user-notification-item:hover {
  background: #f8f9fa;
}

.user-notification-item:last-child {
  border-bottom: none;
}

.user-notification-icon {
  width: 40px;
  height: 40px;
  background: #AD974F;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  flex-shrink: 0;
}

.user-notification-content {
  flex-grow: 1;
  min-width: 0;
  overflow: hidden;
}

.user-notification-title {
  font-weight: 600;
  color: #222;
  margin-bottom: 5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.user-notification-text {
  color: #666;
  font-size: 14px;
  margin-bottom: 5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
}

.user-notification-time {
  color: #999;
  font-size: 12px;
}

.user-notification-sender {
  color: #AD974F;
  font-size: 12px;
  font-weight: 500;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.user-notification-item:hover {
  background-color: #f8f9fa !important;
  transform: translateX(2px);
}

.toast-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: #AD974F;
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
  max-width: 350px;
  animation: slideIn 0.3s ease-out;
}
</style>

<!-- User Notification JavaScript -->
<script>
let userNotificationCount = 0;
let userNotifications = [];

// Initialize user notification system
document.addEventListener('DOMContentLoaded', function() {
  loadUserNotifications();
  setupRealtimeUserNotifications();
});

function loadUserNotifications() {
  fetch('/notifications/')
    .then(response => response.json())
    .then(data => {
      userNotifications = data.notifications;
      updateUserNotificationUI();
    })
    .catch(err => console.error('Error loading user notifications:', err));
}

function updateUserNotificationUI() {
  const badge = document.getElementById('userNotificationBadge');
  const list = document.getElementById('userNotificationList');
  
  const unreadCount = userNotifications.filter(n => !n.is_read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
  
  if (userNotifications.length === 0) {
    list.innerHTML = `
      <div class="text-center p-4 text-muted">
        <i class="fas fa-bell-slash mb-2" style="font-size: 2rem;"></i>
        <p>No new notifications</p>
      </div>
    `;
  } else {
    list.innerHTML = userNotifications.map(notification => {
      // Determine icon based on notification type
      let icon = 'fas fa-envelope'; // default for admin message
      if (notification.notification_type === 'booking_update') {
        icon = 'fas fa-calendar-check';
      } else if (notification.notification_type === 'event_reminder') {
        icon = 'fas fa-clock';
      } else if (notification.notification_type === 'payment_update') {
        icon = 'fas fa-credit-card';
      }
      
      return `
        <div class="user-notification-item d-flex ${notification.is_read ? '' : 'bg-light'}" 
             data-id="${notification.id}" 
             data-booking-id="${notification.booking_id || ''}"
             data-notification-type="${notification.notification_type || 'admin_message'}"
             onclick="handleUserNotificationClick(this)"
             style="cursor: pointer; transition: all 0.2s ease;">
          <div class="user-notification-icon">
            <i class="${icon}"></i>
          </div>
          <div class="user-notification-content">
            <div class="user-notification-title">${notification.title}</div>
            <div class="user-notification-text">${notification.message}</div>
            <div class="user-notification-sender">From: ${notification.sender_name}</div>
            <div class="user-notification-time">${notification.created_at}</div>
          </div>
          ${!notification.is_read ? '<div class="text-primary"><i class="fas fa-circle" style="font-size: 8px;"></i></div>' : ''}
        </div>
      `;
    }).join('');
  }
}

function addUserNotification(data) {
  userNotifications.unshift({
    id: data.id,
    title: data.title,
    message: data.message,
    created_at: data.created_at,
    booking_id: data.booking_id,
    sender_name: data.sender_name,
    notification_type: data.type === 'booking_update' ? 'booking_update' : (data.type === 'event_reminder' ? 'event_reminder' : (data.type === 'payment_update' ? 'payment_update' : 'admin_message')),
    is_read: false
  });
  updateUserNotificationUI();
  
  // Show toast notification
  showUserToast(data.title, data.message);
}

function showUserToast(title, message) {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${title}</div>
    <div style="font-size: 14px; opacity: 0.9;">${message}</div>
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 5 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 5000);
}

function markAllUserNotificationsAsRead() {
  fetch('/notifications/mark-all-read/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      userNotifications.forEach(n => n.is_read = true);
      updateUserNotificationUI();
    }
  })
  .catch(err => console.error('Error marking user notifications as read:', err));
}

function setupRealtimeUserNotifications() {
  // Use Server-Sent Events for real-time notifications
  const eventSource = new EventSource('/notifications/stream/');
  
  eventSource.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'admin_message' || data.type === 'booking_update' || data.type === 'event_reminder' || data.type === 'payment_update') {
        addUserNotification(data);
      }
    } catch (err) {
      console.error('Error parsing user notification data:', err);
    }
  };
  
  eventSource.onerror = function(event) {
    console.warn('User notification stream error:', event);
  };
}

// Handle notification click to navigate to booking or relevant page
function handleUserNotificationClick(element) {
  const bookingId = element.getAttribute('data-booking-id');
  const notificationId = element.getAttribute('data-id');
  const notificationType = element.getAttribute('data-notification-type');
  
  // Mark notification as read immediately
  markUserNotificationAsReadOnServer(notificationId);
  markUserNotificationAsRead(notificationId);
  
  // Close the modal first
  const modal = bootstrap.Modal.getInstance(document.getElementById('userNotificationModal'));
  if (modal) {
    modal.hide();
  }
  
  // Handle different notification types
  if (bookingId && bookingId !== 'null' && bookingId !== '') {
    if (notificationType === 'admin_message') {
      // We're already on my_bookings page, just highlight the relevant booking
      const bookingElement = document.querySelector(`[data-booking="${bookingId}"]`);
      if (bookingElement) {
        // Click on the booking to open it
        bookingElement.click();
      }
    } else {
      // Navigate to event status page for booking updates and payment updates
      window.location.href = `/event-status/${bookingId}/`;
    }
  } else {
    // For general notifications, just close the modal
    console.log('General notification clicked');
  }
}

function markUserNotificationAsRead(notificationId) {
  // Update the notification visually
  const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
  if (notificationElement) {
    notificationElement.classList.remove('bg-light');
    const unreadIndicator = notificationElement.querySelector('.text-primary');
    if (unreadIndicator) {
      unreadIndicator.remove();
    }
  }
  
  // Update the notifications array
  const notification = userNotifications.find(n => n.id == notificationId);
  if (notification) {
    notification.is_read = true;
  }
  
  // Update badge count
  updateUserNotificationUI();
}

function markUserNotificationAsReadOnServer(notificationId) {
  fetch(`/notifications/${notificationId}/mark-read/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('User notification marked as read on server');
    }
  })
  .catch(err => console.error('Error marking user notification as read:', err));
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
</script>
{% endif %}

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookingDetailsModalLabel">Request Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
          <dt class="col-sm-3">Event Type</dt>
          <dd class="col-sm-9" id="modal-event-type">-</dd>
          <dt class="col-sm-3">Date</dt>
          <dd class="col-sm-9" id="modal-event-date">-</dd>
          <dt class="col-sm-3">Celebrant</dt>
          <dd class="col-sm-9" id="modal-celebrant">-</dd>
          <dt class="col-sm-3">Pax</dt>
          <dd class="col-sm-9" id="modal-pax">-</dd>
          <dt class="col-sm-3">Venue</dt>
          <dd class="col-sm-9" id="modal-venue">-</dd>
          <dt class="col-sm-3">Blue</dt>
          <dd class="col-sm-9" id="modal-color-motif">-</dd>
          <dt class="col-sm-3">Package</dt>
          <dd class="col-sm-9" id="modal-package">-</dd>
          <dt class="col-sm-3">Dishes</dt>
          <dd class="col-sm-9" id="modal-dishes">-</dd>
          <dt class="col-sm-3">Pasta</dt>
          <dd class="col-sm-9" id="modal-pasta">-</dd>
          <dt class="col-sm-3">Drink</dt>
          <dd class="col-sm-9" id="modal-drink">-</dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// View Request button functionality
document.addEventListener('DOMContentLoaded', function() {
  const viewRequestBtn = document.getElementById('viewRequestBtn');
  
  if (viewRequestBtn) {
    viewRequestBtn.addEventListener('click', async function () {
      const bookingId = this.dataset.bookingId;
      if (bookingId) {
        try {
          // Fetch booking details from the API
          const response = await fetch(`/api/booking/${bookingId}/details/`);
          if (response.ok) {
            const booking = await response.json();
            
            // Populate modal with booking details
            document.getElementById('modal-event-type').textContent = booking.event_type || '-';
            document.getElementById('modal-event-date').textContent = booking.event_date || '-';
            document.getElementById('modal-celebrant').textContent = booking.celebrant_name || '-';
            document.getElementById('modal-pax').textContent = booking.pax || '-';
            document.getElementById('modal-venue').textContent = booking.venue || '-';
            document.getElementById('modal-color-motif').textContent = booking.color_motif || '-';
            document.getElementById('modal-package').textContent = booking.package || '-';
            document.getElementById('modal-dishes').textContent = booking.dishes || '-';
            document.getElementById('modal-pasta').textContent = booking.pasta || '-';
            document.getElementById('modal-drink').textContent = booking.drink || '-';
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
            modal.show();
          } else {
            alert('Failed to load booking details');
          }
        } catch (error) {
          console.error('Error fetching booking details:', error);
          alert('Error loading booking details');
        }
      }
    });
  }
});
</script>

</body>
</html>
