{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Here ‑ Nike's Catering Services</title>
    
    <style>
    /* Color Swatch Grid Styles */
    .color-swatch-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        justify-items: center;
        margin: 14px 0;
        width: 100%;
        max-width: 100%;
    }
    
    .color-swatch {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 4px;
        border-radius: 12px;
        border: 2px solid transparent;
    }
    
    .color-swatch:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .color-swatch.selected {
        border: 2px solid #B8860B;
        background-color: rgba(184, 134, 11, 0.1);
        transform: translateY(-2px);
        position: relative;
    }

    /* Multi-color selection order numbers */
    .color-swatch.selected::after {
        content: attr(data-order);
        position: absolute;
        top: -8px;
        right: -8px;
        background: #B8860B;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Color Selection Preview Styles */
    .color-preview-container {
        margin: 0;
        padding: 20px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .preview-title {
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #B8860B;
        margin-bottom: 15px;
    }

    .color-stack-preview {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        height: 120px;
        width: 200px;
        margin: 0 auto;
    }

    .color-layer {
        position: absolute;
        transition: all 0.3s ease;
    }

    .layer-number {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #B8860B;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
    }

    .layer-color {
        width: 200px;
        height: 200px;
        border-radius: 12px;
        border: 3px solid white;
        background-size: cover;
        background-position: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Stacked positioning for the layers */
    .color-layer:nth-child(1) {
        z-index: 3;
        top: 0;
        left: -100px;
    }

    .color-layer:nth-child(2) {
        z-index: 2;
        top: 40px;
        left: 30px;
    }

    .color-layer:nth-child(3) {
        z-index: 1;
        top: 80px;
        left: 110px;
    }

    .swatch-image {
        width: 150px;
        height: 150px;
        border-radius: 8px;
        object-fit: cover;
        margin-bottom: 2px;
        transition: all 0.3s ease;
    }
    
    .color-swatch:hover .swatch-image {
        transform: scale(1.05);
    }
    
    .swatch-label {
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        color: #333;
        line-height: 1.2;
        min-height: 30px;
        display: flex;
        align-items: center;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .color-swatch-grid {
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .swatch-image {
            width: 45px;
            height: 45px;
        }
        
        .swatch-label {
            font-size: 11px;
        }
    }
    
    @media (max-width: 480px) {
        .color-swatch-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .swatch-image {
            width: 40px;
            height: 40px;
        }
        
        .swatch-label {
            font-size: 10px;
            min-height: 25px;
        }
    }
    
    /* Food Menu Grid Styles */
    .food-grid-container {
        margin: 20px 0;
    }
    
    .food-section-title {
        position: sticky;
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        padding-left: 4px;
    }
    
    .food-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    
    .food-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 8px;
        border-radius: 12px;
        border: 2px solid #e2dfda;
        background: rgba(255, 255, 255, 0.05);
    }
    
    .food-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: rgba(255, 255, 255, 0.1);
    }
    
    .food-item.selected {
        border: 2px solid #3b6255;
        background-color: rgba(184, 134, 11, 0.15);
        transform: translateY(-2px);
    }
    
    .food-image {
        width: 90%;
        height: 200px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    
    .food-item:hover .food-image {
        transform: scale(1.05);
    }
    
    .food-label {
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        color: #333;
        line-height: 1.3;
        min-height: 35px;
        display: flex;
        align-items: center;
        max-width: 100%;
    }
    
    .food-item.selected .food-label {
        color: #3b6255;
        font-weight: 600;
    }
    
    /* Responsive Food Grid */
    @media (max-width: 768px) {
        .food-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .food-image {
            width: 60px;
            height: 60px;
        }
        
        .food-label {
            font-size: 12px;
            min-height: 32px;
        }
    }
    
    @media (max-width: 480px) {
        .food-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .food-image {
            width: 55px;
            height: 55px;
        }
        
        .food-label {
            font-size: 11px;
            min-height: 30px;
        }
    }

    /* Theme Selection Styles */
    /* Theme Selection Grid Styles - exactly matching food menu design */
    .theme-grid-container {
        margin: 20px 0;
        margin-left: auto;
        margin-right: auto;
    }
    
    .theme-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        padding-left: 4px;
    }
    
    .theme-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .theme-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #e2dfda;
        background: rgba(255, 255, 255, 0.05);
        width: 100%;
    }
    
    .theme-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: rgba(255, 255, 255, 0.1);
    }
    
    .theme-item.selected {
        border: 2px solid #B8860B;
        background-color: rgba(184, 134, 11, 0.15);
        transform: translateY(-2px);
    }
    
    .theme-images {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        width: 100%;
        height: 100%;
        margin-bottom: 12px;
    }
    
    .theme-preview {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        object-fit: cover;
        transition: all 0.3s ease;
        aspect-ratio: 16 / 9;
    }
    
    .theme-item:hover .theme-preview {
        transform: scale(1.02);
    }
    
    .theme-label {
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        color: #333;
        line-height: 1.3;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }
    
    .theme-item.selected .theme-label {
        color: #333;
        font-weight: 600;
    }

    /* Responsive Theme Grid */
    @media (max-width: 768px) {
        .theme-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .theme-preview {
            height: 100px;
        }
        
        .theme-label {
            font-size: 15px;
        }
        
        .theme-name {
            font-size: 15px;
            margin-bottom: 12px;
        }
        
        .theme-images {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .theme-image {
            height: 75px;
        }
    }
    
    @media (max-width: 480px) {
        .theme-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .theme-preview {
            height: 80px;
        }
        
        .theme-label {
            font-size: 14px;
        }
        
        .theme-images {
            gap: 8px;
        }
    }
    
    /* Custom Floorplan Options Styles */
    .ai-estimations-btn {
        background: #B8860B !important;
        border: none !important;
        color: white !important;
        padding: 12px 24px !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }
    
    .ai-estimations-btn:hover {
        background: #9d7209 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3) !important;
    }
    
    .custom-option {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%;
        text-align: center;
    }
    
    .custom-option h4 {
        margin: 0 0 15px 0;
    }
    
    .ai-generated-option {
        border: 2px solid #28a745 !important;
        background: rgba(40, 167, 69, 0.1) !important;
    }
    
    .ai-generated-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }
    
    #ai-estimations {
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
    }
    
    #custom-floorplan-options input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 2px dashed #B8860B;
        border-radius: 8px;
        background: rgba(184, 134, 11, 0.05);
        color: #fff;
    }
    
    #custom-floorplan-options input[type="number"] {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #000;
    }
    
    #custom-floorplan-options input[type="number"]:focus {
        border-color: #B8860B;
        outline: none;
        box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.3);
    }

    /* Modern Upload Area Styles */
    .upload-container {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    .upload-area {
        position: relative;
        border: 2px dashed #B8860B;
        border-radius: 12px;
        background: rgba(184, 134, 11, 0.03);
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-area:hover {
        border-color: #9d7209;
        background: rgba(184, 134, 11, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(184, 134, 11, 0.15);
    }

    .upload-area.dragover {
        border-color: #9d7209;
        background: rgba(184, 134, 11, 0.12);
        border-style: solid;
        transform: scale(1.02);
    }

    .file-input {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        top: 0;
        left: 0;
    }

    .upload-content {
        pointer-events: none;
        width: 100%;
    }

    .upload-icon {
        font-size: 48px;
        color: #B8860B;
        margin-bottom: 20px;
        opacity: 0.8;
        transition: all 0.3s ease;
    }

    .upload-area:hover .upload-icon {
        transform: scale(1.1);
        opacity: 1;
    }

    .upload-title {
        font-size: 18px;
        font-weight: 600;
        color: #B8860B;
        margin: 0 0 8px 0;
    }

    .upload-subtitle {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        margin: 0 0 15px 0;
    }

    .upload-link {
        color: #B8860B;
        text-decoration: underline;
        font-weight: 500;
    }

    .upload-formats {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
    }

    /* Image Preview Styles */
    .image-preview {
        margin-top: 20px;
        width: 100%;
    }

    .preview-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.1);
        border: 2px solid #B8860B;
        box-shadow: 0 4px 15px rgba(184, 134, 11, 0.2);
    }

    .preview-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        display: block;
        transition: all 0.3s ease;
    }

    .preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .preview-container:hover .preview-overlay {
        opacity: 1;
    }

    .preview-container:hover .preview-img {
        transform: scale(1.05);
    }

    .preview-actions {
        display: flex;
        gap: 10px;
    }

    .preview-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .change-btn {
        background: #B8860B;
        color: white;
    }

    .change-btn:hover {
        background: #9d7209;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(184, 134, 11, 0.4);
    }

    .remove-btn {
        background: #dc3545;
        color: white;
    }

    .remove-btn:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .image-info {
        padding: 15px;
        background: rgba(184, 134, 11, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
        border-top: 1px solid rgba(184, 134, 11, 0.2);
    }

    #image-name {
        font-weight: 500;
        color: #B8860B;
        max-width: 60%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #image-size {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
    }

    /* Loading animation for upload */
    .upload-area.uploading {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .upload-area.uploading .upload-icon {
        animation: pulse 1.5s ease-in-out infinite;
        color: #28a745;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 0.8; }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .upload-area {
            padding: 30px 15px;
            min-height: 150px;
        }
        
        .upload-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }
        
        .upload-title {
            font-size: 16px;
        }
        
        .preview-img {
            height: 200px;
        }
        
        .preview-actions {
            flex-direction: column;
            gap: 8px;
        }
        
        .preview-btn {
            padding: 8px 16px;
            font-size: 13px;
        }
    }
    </style>

    <!-- STYLES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/bookhere.css' %}">
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
{% include 'navbar.html' %}

<!-- ===============   PROGRESS BAR AT TOP   =============== -->
<div class="wizard-progress-header">
    <div class="container">
        <div class="step-progress-bar">
            {% for s in "0123456789" %}
                <div class="step" data-step="{{ forloop.counter0 }}">
                    <div class="step-icon">
                        {% if forloop.counter0 == 0 %}<i class="fa-solid fa-user"></i>{% endif %}
                        {% if forloop.counter0 == 1 %}<i class="fa-regular fa-calendar"></i>{% endif %}
                        {% if forloop.counter0 == 2 %}<i class="fa-regular fa-clipboard"></i>{% endif %}
                        {% if forloop.counter0 == 3 %}<i class="fa-solid fa-palette"></i>{% endif %}
                        {% if forloop.counter0 == 4 %}<i class="fa-solid fa-users"></i>{% endif %}
                        {% if forloop.counter0 == 5 %}<i class="fa-solid fa-image"></i>{% endif %}
                        {% if forloop.counter0 == 6 %}<i class="fa-solid fa-location-dot"></i>{% endif %}
                        {% if forloop.counter0 == 7 %}<i class="fa-solid fa-box"></i>{% endif %}
                        {% if forloop.counter0 == 8 %}<i class="fa-solid fa-utensils"></i>{% endif %}
                        {% if forloop.counter0 == 9 %}<i class="fa-solid fa-check-circle"></i>{% endif %}
                    </div>
                    <div class="step-label">
                        {% if forloop.counter0 == 0 %}Celebrant{% endif %}
                        {% if forloop.counter0 == 1 %}Date of Event{% endif %}
                        {% if forloop.counter0 == 2 %}Type of Event{% endif %}
                        {% if forloop.counter0 == 3 %}Color Motif{% endif %}
                        {% if forloop.counter0 == 4 %}Number of Pax{% endif %}
                        {% if forloop.counter0 == 5 %}Theme{% endif %}
                        {% if forloop.counter0 == 6 %}Location{% endif %}
                        {% if forloop.counter0 == 7 %}Packages{% endif %}
                        {% if forloop.counter0 == 8 %}Food Menu{% endif %}
                        {% if forloop.counter0 == 9 %}Summary{% endif %}
                    </div>
                </div>
                {% if not forloop.last %}<div class="step-line"></div>{% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- ===============   MAIN WIZARD CONTAINER   =============== -->
<div class="wizard-container">
    
    <!-- ========================================================= -->
    <!--                       STEP 0 – CELEBRANT                  -->
    <!-- ========================================================= -->
    <div id="step-0" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-name" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">Please enter the celebrant's name.</div>
            <form id="name-form" autocomplete="off">
                <div style="display:flex; justify-content:center;">
                    <input style="width:100%;" type="text" id="celebrant-name" class="date-input" required placeholder="Enter full name">
                </div>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                       STEP 1 – DATE                       -->
    <!-- ========================================================= -->
    <div id="step-1" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-date" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">
                Select the date of the event.
            </div>
            <form id="date-form" autocomplete="off">
                <input type="date" id="date-picker" class="date-input" required min="">
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                     STEP 2 – EVENT TYPE                    -->
    <!-- ========================================================= -->
    <div id="step-2" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-event" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">
                Select the type of event.
            </div>
            <div class="event-btn-group">
                <button type="button" class="event-btn">Kiddie Party</button>
                <button type="button" class="event-btn">Birthday Party</button>
                <button type="button" class="event-btn">Wedding</button>
                <button type="button" class="event-btn">Christening</button>
            </div>
            <form id="custom-event-form" autocomplete="off">
                <input type="text" class="custom-event-input" placeholder="Or type your custom event type…">
                <button type="submit" class="custom-event-submit">Submit Custom Event</button>
            </form>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                <button type="button" class="back-btn">Back</button>
                <button type="button" class="next-btn" id="event-next-btn" disabled>Next</button>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                    STEP 3 – COLOR                          -->
    <!-- ========================================================= -->
     <div id="step-3" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-color" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">Choose 1 to 3 colors for your event motif (in order of preference).</div>
            <form id="color-form" autocomplete="off" style="width:100%; display:flex; flex-direction:column; gap:20px;">
                
                <!-- Color Swatch Grid -->
                <div class="color-swatch-grid">
                    <div class="color-swatch" data-color="Orange">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770591/orange_beq6g2.jpg" alt="Orange" class="swatch-image">
                        <div class="swatch-label">Orange</div>
                    </div>
                    <div class="color-swatch" data-color="Red">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770587/red_ddg0wx.jpg" alt="Red" class="swatch-image">
                        <div class="swatch-label">Red</div>
                    </div>
                    <div class="color-swatch" data-color="Royal Blue">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770577/royalblue_bhz1ow.jpg" alt="Royal Blue" class="swatch-image">
                        <div class="swatch-label">Royal Blue</div>
                    </div>
                    <div class="color-swatch" data-color="Rust Red">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770507/rustred_q2fgz8.jpg" alt="Rust Red" class="swatch-image">
                        <div class="swatch-label">Rust Red</div>
                    </div>
                    <div class="color-swatch" data-color="Yellow">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770509/yellow_v2d7ma.jpg" alt="Yellow" class="swatch-image">
                        <div class="swatch-label">Yellow</div>
                    </div>
                    <div class="color-swatch" data-color="Dark Green">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770513/darkgreen_zunnwu.jpg" alt="Dark Green" class="swatch-image">
                        <div class="swatch-label">Dark Green</div>
                    </div>
                    <div class="color-swatch" data-color="Gray">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770517/gray_b9dlwb.jpg" alt="Gray" class="swatch-image">
                        <div class="swatch-label">Gray</div>
                    </div>
                    <div class="color-swatch" data-color="Lake Blue">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770521/lakeblue_zsjili.jpg" alt="Lake Blue" class="swatch-image">
                        <div class="swatch-label">Lake Blue</div>
                    </div>
                    <div class="color-swatch" data-color="Brown">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770525/brown_kg72gb.jpg" alt="Brown" class="swatch-image">
                        <div class="swatch-label">Brown</div>
                    </div>
                    <div class="color-swatch" data-color="Champagne">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770529/champagne_rwkvv5.jpg" alt="Champagne" class="swatch-image">
                        <div class="swatch-label">Champagne</div>
                    </div>
                    <div class="color-swatch" data-color="Pink">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770533/pink_b9wuoq.jpg" alt="Pink" class="swatch-image">
                        <div class="swatch-label">Pink</div>
                    </div>
                    <div class="color-swatch" data-color="Light Pink">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770537/lightpink_jb3gqb.jpg" alt="Light Pink" class="swatch-image">
                        <div class="swatch-label">Light Pink</div>
                    </div>
                    <div class="color-swatch" data-color="Off White">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770541/offwhite_qu62zb.jpg" alt="Off White" class="swatch-image">
                        <div class="swatch-label">Off White</div>
                    </div>
                    <div class="color-swatch" data-color="Gold">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770545/gold_cpuahs.jpg" alt="Gold" class="swatch-image">
                        <div class="swatch-label">Gold</div>
                    </div>
                    <div class="color-swatch" data-color="Purple">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770549/purple_nsrd84.jpg" alt="Purple" class="swatch-image">
                        <div class="swatch-label">Purple</div>
                    </div>
                    <div class="color-swatch" data-color="White">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770553/white_aupuke.jpg" alt="White" class="swatch-image">
                        <div class="swatch-label">White</div>
                    </div>
                    <div class="color-swatch" data-color="Sky Blue">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770557/skyblue_i6mdz7.jpg" alt="Sky Blue" class="swatch-image">
                        <div class="swatch-label">Sky Blue</div>
                    </div>
                    <div class="color-swatch" data-color="Dark Yellow">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770561/darkyellow_d0pxgh.jpg" alt="Dark Yellow" class="swatch-image">
                        <div class="swatch-label">Dark Yellow</div>
                    </div>
                    <div class="color-swatch" data-color="Olive Green">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770565/olivegreen_ijgrtv.jpg" alt="Olive Green" class="swatch-image">
                        <div class="swatch-label">Olive Green</div>
                    </div>
                    <div class="color-swatch" data-color="Mint">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770569/mint_h8nbh0.jpg" alt="Mint" class="swatch-image">
                        <div class="swatch-label">Mint</div>
                    </div>
                    <div class="color-swatch" data-color="Skin Pink">
                        <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757770573/skinpink_ibuunv.jpg" alt="Skin Pink" class="swatch-image">
                        <div class="swatch-label">Skin Pink</div>
                    </div>
                </div>

                <!-- Color Selection Preview -->
                <div id="color-selection-preview" class="color-preview-container" style="display:none;">
                    <div class="preview-title">Your Selected Colors</div>
                    <div class="color-stack-preview">
                        <div class="color-layer" id="color-layer-1">
                            <div class="layer-color"></div>
                            <div class="layer-number">1</div>
                        </div>
                        <div class="color-layer" id="color-layer-2">
                            <div class="layer-color"></div>
                            <div class="layer-number">2</div>
                        </div>
                        <div class="color-layer" id="color-layer-3">
                            <div class="layer-color"></div>
                            <div class="layer-number">3</div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; justify-content:center; gap:10px; margin-top:150px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                     STEP 4 – PAX                           -->
    <!-- ========================================================= -->
    <div id="step-4" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-pax" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">
                Select the number of guests (pax) for your event.
            </div>
            <form id="pax-form" autocomplete="off" style="width:100%;">
                <select id="pax-select" class="pax-select" required>
                    <option value="" disabled selected>--Select Number of Guests--</option>
                    <option value="70">70 pax</option>
                    <option value="80">80 pax</option>
                    <option value="100">100 pax</option>
                    <option value="120">120 pax</option>
                    <option value="150">150 pax</option>
                    <option value="200">200 pax</option>
                    <option value="250">250 pax</option>
                </select>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
            <form id="custom-pax-form" autocomplete="off" style="width:100%; margin-top:10px;">
                <input type="number" class="custom-pax-input" placeholder="Or type custom number" min="1">
                <button type="submit" class="custom-pax-submit">Submit Custom</button>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                    STEP 5 – THEME                          -->
    <!-- ========================================================= -->
    <div id="step-5" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-theme" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">Select a theme for your <span id="theme-event-type">event</span>.</div>
            
            <form id="theme-form" style="width:100%; display:flex; flex-direction:column; gap:8px;">
                <!-- Theme Grid Container -->
                <div id="theme-grids-container">
                    <!-- Grid will be dynamically generated by JavaScript -->
                </div>
                
                <input type="hidden" id="selected-theme-name" name="selected-theme-name">
                <input type="hidden" id="selected-theme-urls" name="selected-theme-urls">
                
                <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                  STEP 6 – LOCATION                         -->
    <!-- ========================================================= -->
    <div id="step-6" class="wizard-step" style="display:none;">
        <div class="date-modal-content">
            <div id="alert-location" class="modal-alert alert alert-danger d-none"></div>
            <div class="date-modal-message">Please enter the venue name and select a floor plan.</div>
            <form id="location-form" style="width:100%; display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="venue-input" class="custom-location-input" placeholder="Venue name..." required>
                
                <button type="button" id="select-floorplan-btn" class="date-submit" style="margin: 10px 0;" disabled>Select Floor Plan</button>
                
                <div class="date-modal-message" id="floorplan-instruction" style="margin-bottom: 10px; display: none;">Select a floor plan:</div>
                
                <div id="floorplan-selection" style="display: none; flex-direction: column; gap: 20px; align-items: center;">
                    <!-- Floor plan images will be populated by JavaScript -->
                </div>
                
                <!-- Custom Floorplan Options -->
                <div id="custom-floorplan-options" style="display: none; flex-direction: column; gap: 10px; align-items: center; width: 100%; margin: 0 auto;">
                    <div class="date-modal-message">Choose your option:</div>
                    
                    <!-- Option 1: Upload Floorplan Image -->
                    <div class="custom-option">
                        <h4 style="margin-bottom: 10px; color: #B8860B;">Upload Floor plan Image</h4>
                        
                        <!-- Modern Upload Area -->
                        <div class="upload-container">
                            <div class="upload-area" id="upload-area">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        <p class="upload-title">Drop your floor plan image here</p>
                                        <p class="upload-subtitle">or <span class="upload-link">browse files</span></p>
                                    </div>
                                    <div class="upload-formats">
                                        <span>Supports: JPG, PNG, GIF (max 10MB)</span>
                                    </div>
                                </div>
                                <input type="file" id="floorplan-upload" accept="image/*" class="file-input">
                            </div>
                            
                            <!-- Image Preview -->
                            <div class="image-preview" id="image-preview" style="display: none;">
                                <div class="preview-container">
                                    <img id="preview-image" src="" alt="Floorplan preview" class="preview-img">
                                    <div class="preview-overlay">
                                        <div class="preview-actions">
                                            <button type="button" class="preview-btn change-btn" id="change-image-btn">
                                                <i class="fas fa-edit"></i>
                                                Change
                                            </button>
                                            <button type="button" class="preview-btn remove-btn" id="remove-image-btn">
                                                <i class="fas fa-trash"></i>
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="image-info">
                                    <span id="image-name"></span>
                                    <span id="image-size"></span>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="analyze-image-btn" class="date-submit" style="display: none; margin-top: 15px;">Analyze Image</button>
                    </div>
                    
                    <!-- OR Separator -->
                    <div style="text-align: center; margin: 10px 0; color: #666;">OR</div>
                    
                    <!-- Option 2: Enter Room Dimensions -->
                    <div class="custom-option">
                        <h4 style="margin-bottom: 10px; color: #B8860B;">Enter Room Dimensions</h4>
                        <div style="display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 10px;">
                            <input type="number" id="room-length" placeholder="Length (m)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" step="0.1" min="1">
                            <span style="color: #666;">×</span>
                            <input type="number" id="room-width" placeholder="Width (m)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" step="0.1" min="1">
                        </div>
                        <button type="button" id="analyze-dimensions-btn" class="date-submit">Generate Estimations</button>
                    </div>
                    
                    <!-- AI Analysis Results -->
                    <div id="ai-results" style="display: none; width: 100%; margin-top: 20px;">
                        <h4 style="color: #B8860B; margin-bottom: 10px;">AI Estimations:</h4>
                        <div id="ai-estimations" style="background: #f8f9fa; padding: 15px; border-radius: 8px; color: #242424; white-space: pre-line; font-family: monospace; font-size: 14px; border: 1px solid #e9ecef;"></div>
            
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="ai-loading" style="display: none; text-align: center; color: #666;">
                        <i class="fas fa-spinner fa-spin"></i> Analyzing...
                    </div>
                    
                </div>
                
                <input type="hidden" id="selected-floorplan" name="selected-floorplan">
                <input type="hidden" id="ai-estimations-data" name="ai-estimations-data">
                
                <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                 STEP 7 – PACKAGE SELECTION                  -->
    <!-- ========================================================= -->
    <div id="step-7" class="wizard-step" style="display:none;">
        <div class="package-selection-container">
            <div id="alert-package" class="modal-alert alert alert-danger d-none"></div>
            
            <!-- Two Column Layout -->
            <div class="package-two-column-layout">
                   <!-- Left Column - Package Image (Clickable) -->
                   <div class="package-left-column">
                       <div class="date-modal-message" style="margin-bottom:18px;">
                           You selected: <span id="package-summary">Wedding 180 Pax</span>
                       </div>
                       <div style="display:flex; justify-content:center; margin-bottom:18px;">
                           <img id="package_img" src="https://i.ibb.co/6b7Qw8d/sample-package.jpg" alt="Package Sample"
                                style="width:100%; max-width:300px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); cursor:pointer; transition:transform 0.3s ease;"
                                onclick="openPackageImageModal()">
                       </div>
                       <div style="text-align:center; color:#666; font-size:0.9rem;">
                           Click image to view larger
                       </div>

                        <!-- Add-ons Section -->
                    <div class="addons-section">
                        <h3>ADD ONS</h3>
                        <div class="addons-grid">
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="15000" data-name="Upgraded Balloon Setup">
                                <span class="checkmark"></span>
                                <span class="addon-text">Upgraded Balloon Setup</span>
                                <span class="addon-price">PHP 15,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="2000" data-name="Kiddie Meals">
                                <span class="checkmark"></span>
                                <span class="addon-text">Kiddie Meals</span>
                                <span class="addon-price">PHP 2,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="3000" data-name="Fondant & Soft Icing Cake">
                                <span class="checkmark"></span>
                                <span class="addon-text">Fondant & Soft Icing Cake</span>
                                <span class="addon-price">PHP 3,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="5000" data-name="Food Carts">
                                <span class="checkmark"></span>
                                <span class="addon-text">Food Carts</span>
                                <span class="addon-price">PHP 5,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="5000" data-name="Photo and Video Coverage">
                                <span class="checkmark"></span>
                                <span class="addon-text">Photo and Video Coverage</span>
                                <span class="addon-price">PHP 5,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="5000" data-name="Face Painting and Bubble Show">
                                <span class="checkmark"></span>
                                <span class="addon-text">Face Painting and Bubble Show</span>
                                <span class="addon-price">PHP 5,000</span>
                            </label>
                            <label class="addon-item">
                                <input type="checkbox" class="addon-checkbox" data-price="3000" data-name="Digital Invitations">
                                <span class="checkmark"></span>
                                <span class="addon-text">Digital Invitations</span>
                                <span class="addon-price">PHP 3,000</span>
                            </label>
                        </div>
                    </div>
                   </div>

                <!-- Right Column - New Package Selection Content -->
                <div class="package-right-column">
                    <!-- AI Recommendation Bar -->
                    <div class="ai-recommendation-bar">
                        <i class="fas fa-lightbulb"></i>
                        <span id="ai-recommendation-text">AI Recommendation: Package B is ideal for your event</span>
                    </div>

                    <!-- Package Cards -->
                    <div class="packages-container">
                        <!-- Package A -->
                        <div class="package-card" data-package="Package A">
                            <div class="package-header">
                                <h3>Package A</h3>
                                <div class="package-price" id="package-a-price">PHP 0</div>
                            </div>
                            <p class="package-description">Perfect for intimate gatherings and smaller events. Includes essential services with quality food options.</p>
                            <div class="package-features">
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Main Dishes: 3 choices</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Pasta & Drink: Included</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Setup & Service: Full service</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Extras: Basic decoration</span>
                                </div>
                            </div>
                        </div>

                        <!-- Package B (Recommended) -->
                        <div class="package-card recommended" data-package="Package B">
                            <div class="recommended-badge">Recommended</div>
                            <div class="package-header">
                                <h3>Package B</h3>
                                <div class="package-price" id="package-b-price">PHP 0</div>
                            </div>
                            <p class="package-description">Our most popular choice! Great balance of variety, quality, and value for medium-sized events.</p>
                            <div class="package-features">
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Main Dishes: 4 choices</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Pasta & Drink: Included</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Setup & Service: Full service</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Extras: Enhanced decoration, centerpieces</span>
                                </div>
                            </div>
                        </div>

                        <!-- Package C -->
                        <div class="package-card" data-package="Package C">
                            <div class="package-header">
                                <h3>Package C</h3>
                                <div class="package-price" id="package-c-price">PHP 0</div>
                            </div>
                            <p class="package-description">Premium experience for grand celebrations. Maximum variety and luxurious presentation.</p>
                            <div class="package-features">
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Main Dishes: 5 choices</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Pasta & Drink: Included</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Setup & Service: Full service</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check"></i>
                                    <span>Extras: Premium decoration, themed setup, extra staff</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Price Display -->
                    <div class="total-price-section">
                        <div class="total-price-display">
                            <span class="total-label">Total Package Price:</span>
                            <span class="total-amount" id="total-package-price">PHP 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="package-navigation">
                <button type="button" class="back-btn">Back</button>
                <button type="button" class="next-btn" id="package-next-btn" disabled>Next</button>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!--                   STEP 8 – FOOD MENU                       -->
    <!-- ========================================================= -->
    <div id="step-8" class="wizard-step" style="display:none;">
        <div class="date-modal-content" style="max-width:1600px; max-height:80vh; overflow-y:auto;">
            <div id="alert-food" class="modal-alert alert alert-danger d-none"></div>
            <form id="food-form" autocomplete="off" style="width:100%;">
                <div class="date-modal-message" id="food-menu-message">Please select <strong>4 dishes total</strong> + 1 pasta + 1 drink:</div>
                
                <!-- Food Grids Container -->
                <div id="food-grids-container">
                    <!-- Grids will be dynamically generated by JavaScript -->
                </div>

                <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="date-submit">Review Booking</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ========================================================= -->
    <!--                 STEP 9 – BOOKING SUMMARY                 -->
    <!-- ========================================================= -->
    <div id="step-9" class="wizard-step" style="display:none;">
        <div class="summary-full-screen">
            <div class="summary-header">
                <h2>Booking Summary</h2>
            </div>
            
            <!-- Booking Summary Section -->
            <div class="summary-container">
                <!-- Left column: Event Details -->
                <div class="event-details">
                    <div id="booking-summary-content">
                        <!-- Summary content will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Right column: Receipt -->
                <div class="booking-receipt">
                    <div id="booking-receipt">
                        <!-- Export PDF Button -->
                        <button type="button" id="export-pdf-btn" class="export-btn">
                            📄 Export PDF
                        </button>
                        
                        <!-- Receipt content will be generated by JavaScript -->
                        <div id="receipt-content">
                            <!-- Receipt will be generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-actions">
                <button type="button" class="back-btn" id="summary-back-btn">Back to Food Menu</button>
                <button type="button" class="date-submit" id="confirm-booking-btn">Confirm Booking</button>
            </div>
        </div>
    </div>
    
</div>

<!-- Hidden form for CSRF token -->
<form style="display:none;">
    {% csrf_token %}
</form>

<!-- Image Modal for Package Images -->
<div id="image-modal" class="image-modal">
    <button class="modal-prev">❮</button>
    <img class="modal-content" id="modal-img" src="" alt="Full Size">
    <button class="modal-next">❯</button>
    <span class="close-modal">&times;</span>
</div>

<!-- ===============   WIZARD JAVASCRIPT   =============== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 0;
    const totalSteps = 10;
    
    // Initialize custom event submit button as disabled
    document.querySelector('.custom-event-submit').disabled = true;
    
    // Initialize custom pax submit button as disabled
    document.querySelector('.custom-pax-submit').disabled = true;
    
    // Initialize all Next buttons as disabled (except theme, location, and food steps)
    document.querySelectorAll('.date-submit, .next-btn').forEach(btn => {
        if (btn.type === 'submit' || btn.id.includes('next-btn')) {
            // Skip theme, location, and food step buttons - keep them enabled
            const isThemeButton = btn.closest('#step-5');
            const isLocationButton = btn.closest('#step-6');
            const isFoodButton = btn.closest('#step-8');
            if (!isThemeButton && !isLocationButton && !isFoodButton) {
                btn.disabled = true;
            }
        }
    });
    
    // Food menu data with Cloudinary URLs
    const foodMenuData = {
        beef: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefwithgravysauce_qyrcsv.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefbroccolli_c3hbve.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefkarekare_n317oe.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/lenguapastel_ofenul.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/potroastbeef_tfekkp.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/beefcaldereta_ellvq7.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782675/garlicbeef_othv0q.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782675/beefteriyaki_yhszrn.jpg'
        ],
        pork: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783626/hawaiianspareribs_ouwkwg.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783626/lenguapastel_kodvks.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783625/lechonkawali_v3v04s.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783624/karekarebagnet_paezmf.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/roastporkraisinsauce_zcyjjj.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/porkteriyaki_iyrgu2.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/grilledliempo_fdq0kp.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/roastporkhawaiian_hbkpf1.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkmorcon_p5sdud.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkhamonado_noxvzn.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkcaldereta_lddwze.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkmenudo_mimd9h.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783621/porkbbq_hrudyt.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783621/lumpiangshanghai_p4ralv.jpg'
        ],
        chicken: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784429/chickenpastel_mgfrq5.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784418/chickenbbq_lkpnac.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784417/orangechicken_jo3vc3.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784416/chickenlollipop_z9dwso.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/butteredchicken_hgsxnr.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/chickencordonbleu_y9qjjw.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/honeyglazedchicken_d4evdv.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784414/breadedfriedchicken_agzutr.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784414/hongkongchicken_ymcmk3.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784413/royalchicken_tmd2ja.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784413/chickenteriyaki_azw467.jpg'
        ],
        seafood: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784686/squidlemonsauce_o5rhz6.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784680/fishwithchilisauce_gd0icq.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784678/miexedseafoodsvegetables_puvtvi.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784678/fishtartarsauce_ln7vfb.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784677/fishtofu_rsofxm.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784677/tempura_g0w6dz.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784676/calamares_hhy97q.jpg'
        ],
        pasta: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785111/pancit_pnh4ho.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785111/fettucinealfredo_ytvr6y.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785110/linguine_g4nteu.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785110/lasagnarolls_b0esab.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/bakedmac_dlltkg.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/rigatoni_wko7vk.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/spaghetti_gzwqbu.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785107/penne_twzzq9.jpg'
        ],
        drinks: [
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785373/pineapplejuice_svj2xb.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785364/orangejuice_jtybgq.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785363/lemontea_k3bvj4.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/fourseasons_yocljk.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/bluelemonade_pwthcl.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/cucumberlemonade_fciacg.jpg',
            'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785360/redtea_atzt39.jpg'
        ]
    };
    
    // Hardcoded food names mapping
    const foodNames = {
        // Beef dishes
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefwithgravysauce_qyrcsv.jpg': 'Beef with Gravy Sauce',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefbroccolli_c3hbve.jpg': 'Beef Brocolli',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782677/beefkarekare_n317oe.jpg': 'Beef Kare-Kare',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/lenguapastel_ofenul.jpg': 'Lengua Pastel',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/potroastbeef_tfekkp.jpg': 'Pot Roast Beef',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782676/beefcaldereta_ellvq7.jpg': 'Beef Caldereta',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782675/garlicbeef_othv0q.jpg': 'Garlic Beef',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757782675/beefteriyaki_yhszrn.jpg': 'Beef Teriyaki',
        
        // Pork dishes
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783626/hawaiianspareribs_ouwkwg.jpg': 'Hawaiian Spare Ribs',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783626/lenguapastel_kodvks.jpg': 'Lengua Pastel',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783625/lechonkawali_v3v04s.jpg': 'Lechon Kawali',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783624/karekarebagnet_paezmf.jpg': 'Kare-Kare Bagnet',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/roastporkraisinsauce_zcyjjj.jpg': 'Roast Pork Raisin Sauce',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/porkteriyaki_iyrgu2.jpg': 'Pork Teriyaki',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/grilledliempo_fdq0kp.jpg': 'Grilled Liempo',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783623/roastporkhawaiian_hbkpf1.jpg': 'Roast Pork Hawaiian',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkmorcon_p5sdud.jpg': 'Pork Morcon',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkhamonado_noxvzn.jpg': 'Pork Hamonado',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkcaldereta_lddwze.jpg': 'Pork Caldereta',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783622/porkmenudo_mimd9h.jpg': 'Pork Menudo',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783621/porkbbq_hrudyt.jpg': 'Pork BBQ',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757783621/lumpiangshanghai_p4ralv.jpg': 'Lumpiang Shanghai',
        
        // Chicken dishes
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784429/chickenpastel_mgfrq5.jpg': 'Chicken Pastel',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784418/chickenbbq_lkpnac.jpg': 'Chicken BBQ',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784417/orangechicken_jo3vc3.jpg': 'Orange Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784416/chickenlollipop_z9dwso.jpg': 'Chicken Lollipop',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/butteredchicken_hgsxnr.jpg': 'Buttered Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/chickencordonbleu_y9qjjw.jpg': 'Chicken Cordon Bleu',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784415/honeyglazedchicken_d4evdv.jpg': 'Honey Glazed Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784414/breadedfriedchicken_agzutr.jpg': 'Breaded Fried Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784414/hongkongchicken_ymcmk3.jpg': 'Hong Kong Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784413/royalchicken_tmd2ja.jpg': 'Royal Chicken',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784413/chickenteriyaki_azw467.jpg': 'Chicken Teriyaki',
        
        // Seafood dishes
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784686/squidlemonsauce_o5rhz6.jpg': 'Squid Lemon Sauce',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784680/fishwithchilisauce_gd0icq.jpg': 'Fish with Chili Sauce',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784678/miexedseafoodsvegetables_puvtvi.jpg': 'Mixed Seafoods & Vegetables',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784678/fishtartarsauce_ln7vfb.jpg': 'Fish Tartar Sauce',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784677/fishtofu_rsofxm.jpg': 'Fish Tofu',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784677/tempura_g0w6dz.jpg': 'Tempura',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757784676/calamares_hhy97q.jpg': 'Calamares',
        
        // Pasta dishes
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785111/pancit_pnh4ho.jpg': 'Pancit',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785111/fettucinealfredo_ytvr6y.jpg': 'Fettuccine Alfredo',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785110/linguine_g4nteu.jpg': 'Linguine',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785110/lasagnarolls_b0esab.jpg': 'Lasagna Rolls',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/bakedmac_dlltkg.jpg': 'Baked Mac',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/rigatoni_wko7vk.jpg': 'Rigatoni',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785109/spaghetti_gzwqbu.jpg': 'Spaghetti',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785107/penne_twzzq9.jpg': 'Penne',
        
        // Drinks
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785373/pineapplejuice_svj2xb.jpg': 'Pineapple Juice',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785364/orangejuice_jtybgq.jpg': 'Orange Juice',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785363/lemontea_k3bvj4.jpg': 'Lemon Tea',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/fourseasons_yocljk.jpg': 'Four Seasons',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/bluelemonade_pwthcl.jpg': 'Blue Lemonade',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785362/cucumberlemonade_fciacg.jpg': 'Cucumber Lemonade',
        'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1757785360/redtea_atzt39.jpg': 'Red Tea'
    };
    
    // Function to get food name from URL
    function getFoodName(url) {
        return foodNames[url] || 'Unknown Food';
    }
    
    // Set minimum date to today for date picker
    const today = new Date();
    const todayString = today.getFullYear() + '-' + 
                       String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(today.getDate()).padStart(2, '0');
    
    const datePicker = document.getElementById('date-picker');
    if (datePicker) {
        datePicker.setAttribute('min', todayString);
        // Also set the default value to today
        datePicker.value = todayString;
        
        // Add additional validation to prevent manual entry of past dates
        datePicker.addEventListener('change', function() {
            if (this.value < todayString) {
                alert('Please select today\'s date or a future date.');
                this.value = todayString;
            }
        });
        
        // Prevent typing/pasting past dates
        datePicker.addEventListener('blur', function() {
            if (this.value < todayString) {
                alert('Please select today\'s date or a future date.');
                this.value = todayString;
            }
        });
    }
    
    // Track which steps have been completed
    let completedSteps = [];
    
    // Data storage
    let wizardData = {
        celebrant: '',
        date: '',
        eventType: '',
        pax: '',
        location: '',
        floorplan: null,
        floorplanName: '',
        uploadedFloorplanUrl: null,
        uploadedFloorplanFilename: null,
        aiEstimations: null,
        roomLength: null,
        roomWidth: null,
        colors: [],
        package: '',
        menu: [],
        specialRequests: ''
    };

    function showAlert(stepId, message) {
        const alertDiv = document.querySelector(`#alert-${stepId}`);
        if (alertDiv) {
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
        }
    }

    function clearAlert(stepId) {
        const alertDiv = document.querySelector(`#alert-${stepId}`);
        if (alertDiv) {
            alertDiv.classList.add('d-none');
            alertDiv.textContent = '';
        }
    }

    // Show the first step
    showStep(0);

    // Progress bar click handlers - allow navigation to completed steps and current step
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.addEventListener('click', () => {
            // Allow navigation to completed steps, current step, or the next step
            if (index <= currentStep || completedSteps.includes(index)) {
                showStep(index);
            }
        });
    });

    function showStep(stepIndex) {
        // Hide all steps
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.style.display = 'none';
        });
        
        // Show current step
        const currentStepEl = document.getElementById(`step-${stepIndex}`);
        if (currentStepEl) {
            currentStepEl.style.display = 'block';
        }

        // Load themes when showing step 5 (theme)
        if (stepIndex === 5) { // step-5 is theme
            loadThemes();
        }

        // Load floor plans when showing step 6 (location) 
        if (stepIndex === 6) { // step-6 is location (formerly step-5)
            // Don't auto-load floorplans anymore - they load when Select Floorplan button is clicked
            setupLocationStep();
        }

        // Load package image when showing step 7 (packages)
        if (stepIndex === 7) { // step-7 is packages (formerly step-6)
            loadPackageImage();
            // Make package image clickable after it's loaded
            setTimeout(() => {
                makePackageImageClickable();
            }, 100);
            
            // Initialize package selection
            updateAIRecommendation();
            updatePackagePrices();
            updateTotalPrice();
        }

        currentStep = stepIndex;
        updateProgressBar();
    }

    function updateProgressBar() {
        document.querySelectorAll('.step').forEach((stepEl, index) => {
            stepEl.classList.remove('active', 'completed');
            
            if (completedSteps.includes(index)) {
                stepEl.classList.add('completed');
            }
            
            if (index === currentStep) {
                stepEl.classList.add('active');
            }
        });
        
        // Update step lines
        document.querySelectorAll('.step-line').forEach((line, index) => {
            line.classList.toggle('completed', completedSteps.includes(index));
        });
    }

    function nextStep() {
        if (currentStep < totalSteps - 1) {
            // Mark current step as completed
            if (!completedSteps.includes(currentStep)) {
                completedSteps.push(currentStep);
            }
            showStep(currentStep + 1);
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            showStep(currentStep - 1);
        }
    }

    // Back button handlers
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', prevStep);
    });

    // Step 0: Name form
    document.getElementById('celebrant-name').addEventListener('input', function() {
        const nextBtn = document.querySelector('#step-0 .date-submit');
        nextBtn.disabled = !this.value.trim();
    });

    document.getElementById('name-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('name');
        const name = document.getElementById('celebrant-name').value.trim();
        if (name) {
            wizardData.celebrant = name;
            nextStep();
        } else {
            showAlert('name', 'Please enter a name.');
        }
    });

    // Step 1: Date form
    document.getElementById('date-picker').addEventListener('change', function() {
        const nextBtn = document.querySelector('#step-1 .date-submit');
        nextBtn.disabled = !this.value;
    });

    document.getElementById('date-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('date');
        const date = document.getElementById('date-picker').value;
        if (date) {
            wizardData.date = date;
            nextStep();
        } else {
            showAlert('date', 'Please select a date.');
        }
    });

    // Step 2: Event type
    document.querySelectorAll('.event-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.event-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            wizardData.eventType = this.textContent;
            document.getElementById('event-next-btn').disabled = false;
            
            // Clear custom input when preset button is selected
            document.querySelector('.custom-event-input').value = '';
            // Disable custom submit button when preset is selected
            document.querySelector('.custom-event-submit').disabled = true;
        });
    });

    // Add input event listener to clear selected buttons when typing and control button state
    document.querySelector('.custom-event-input').addEventListener('input', function() {
        const submitBtn = document.querySelector('.custom-event-submit');
        
        if (this.value.trim()) {
            // Clear all selected preset buttons when user types
            document.querySelectorAll('.event-btn').forEach(b => b.classList.remove('selected'));
            // Enable submit button
            submitBtn.disabled = false;
        } else {
            // Disable submit button when input is empty
            submitBtn.disabled = true;
        }
    });

    document.getElementById('custom-event-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const customEvent = document.querySelector('.custom-event-input').value.trim();
        if (customEvent) {
            wizardData.eventType = customEvent;
            document.getElementById('event-next-btn').disabled = false;
            
            // Clear selected preset buttons when custom event is submitted
            document.querySelectorAll('.event-btn').forEach(b => b.classList.remove('selected'));
        }
    });

    document.getElementById('event-next-btn').addEventListener('click', nextStep);

    // Step 4: Pax with mutual exclusivity
    function updatePaxButtonState() {
        const nextBtn = document.querySelector('#step-4 .date-submit');
        const paxSelect = document.getElementById('pax-select').value;
        const customPax = document.querySelector('.custom-pax-input').value.trim();
        nextBtn.disabled = !paxSelect && !customPax;
    }

    document.getElementById('pax-select').addEventListener('change', function() {
        if (this.value) {
            // Clear custom input when dropdown is selected
            document.querySelector('.custom-pax-input').value = '';
            // Disable custom submit button when preset is selected
            document.querySelector('.custom-pax-submit').disabled = true;
        }
        updatePaxButtonState();
    });

    // Clear dropdown when custom input is typed and control button state
    document.querySelector('.custom-pax-input').addEventListener('input', function() {
        const submitBtn = document.querySelector('.custom-pax-submit');
        
        if (this.value.trim()) {
            // Clear dropdown selection when user types
            document.getElementById('pax-select').value = '';
            // Enable submit button
            submitBtn.disabled = false;
        } else {
            // Disable submit button when input is empty
            submitBtn.disabled = true;
        }
        updatePaxButtonState();
    });

    document.getElementById('pax-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('pax');
        const pax = document.getElementById('pax-select').value;
        if (pax) {
            wizardData.pax = pax;
            nextStep();
        } else {
            showAlert('pax', 'Please select number of guests.');
        }
    });

    document.getElementById('custom-pax-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('pax');
        const customPax = document.querySelector('.custom-pax-input').value;
        if (customPax) {
            wizardData.pax = customPax;
            nextStep();
        } else {
            showAlert('pax', 'Please enter number of guests.');
        }
    });

    // Step 5: Theme Selection
    function updateThemeButtonState() {
        const nextBtn = document.querySelector('#step-5 .date-submit');
        
        if (nextBtn) {
            nextBtn.disabled = false; // Always enabled
        }
    }

    document.getElementById('theme-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('theme');
        const selectedThemeName = document.getElementById('selected-theme-name').value;
        const selectedThemeUrls = document.getElementById('selected-theme-urls').value;
        
        if (selectedThemeName && selectedThemeUrls) {
            wizardData.theme_name = selectedThemeName;
            wizardData.theme_urls = JSON.parse(selectedThemeUrls);
            nextStep();
        } else {
            showAlert('theme', 'Please select a theme for your event.');
        }
    });

    // Step 6: Location with Floor Plan Selection
    function updateLocationButtonState() {
        const nextBtn = document.querySelector('#step-6 .date-submit');
        
        if (nextBtn) {
            nextBtn.disabled = false; // Always enabled
        }
    }

    document.getElementById('location-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const venue = document.getElementById('venue-input').value.trim();
        const selectedFloorplan = document.getElementById('selected-floorplan').value;
        const floorplanVisible = document.getElementById('floorplan-selection').style.display !== 'none';
        
        // Check for alternative inputs (uploaded image or dimensions)
        const hasUploadedImage = wizardData.uploadedFloorplanUrl || 
                                (document.getElementById('image-preview') && 
                                 document.getElementById('image-preview').style.display !== 'none');
        
        const roomLength = document.getElementById('room-length');
        const roomWidth = document.getElementById('room-width');
        const hasDimensions = roomLength && roomWidth && 
                             roomLength.value.trim() && roomWidth.value.trim();
        
        // Validation logic:
        // 1. Venue is always required
        // 2. If floorplan selection is visible, floorplan is required UNLESS there's an uploaded image or dimensions
        // 3. If no floorplan selection visible, no additional validation needed (AI estimations mode)
        
        const hasValidSelection = !floorplanVisible || selectedFloorplan || hasUploadedImage || hasDimensions;
        
        if (venue && hasValidSelection) {
            wizardData.location = venue;
            if (selectedFloorplan) {
                wizardData.floorplan = selectedFloorplan;
            }
            
            // Save room dimensions if they were entered
            if (hasDimensions) {
                wizardData.roomLength = parseFloat(roomLength.value);
                wizardData.roomWidth = parseFloat(roomWidth.value);
            }
            
            // floorplanName is already stored when clicking the floor plan option
            nextStep();
        } else if (!venue) {
            showAlert('location', 'Please enter venue name.');
        } else if (floorplanVisible && !selectedFloorplan && !hasUploadedImage && !hasDimensions) {
            showAlert('location', 'Please select a floor plan, upload an image, or enter room dimensions.');
        }
    });

    // Venue input handler
    document.getElementById('venue-input').addEventListener('input', updateLocationButtonState);

    // Dimension input handlers - clear upload state when typing dimensions
    const roomLengthInput = document.getElementById('room-length');
    const roomWidthInput = document.getElementById('room-width');
    
    if (roomLengthInput) {
        roomLengthInput.addEventListener('input', function() {
            if (this.value.trim()) {
                clearUploadState();
            }
            updateLocationButtonState();
        });
    }
    
    if (roomWidthInput) {
        roomWidthInput.addEventListener('input', function() {
            if (this.value.trim()) {
                clearUploadState();
            }
            updateLocationButtonState();
        });
    }

    // Setup location step functionality
    function setupLocationStep() {
        const venueInput = document.getElementById('venue-input');
        const selectFloorplanBtn = document.getElementById('select-floorplan-btn');
        const floorplanSelection = document.getElementById('floorplan-selection');
        const floorplanInstruction = document.getElementById('floorplan-instruction');
        
        // Restore venue name if previously entered
        if (wizardData.location) {
            venueInput.value = wizardData.location;
        }
        
        // Reset state when entering location step
        selectFloorplanBtn.disabled = !venueInput.value.trim();
        floorplanSelection.style.display = 'none';
        floorplanInstruction.style.display = 'none';
        
        // Restore previous selections if they exist
        restoreLocationStepData();
        
        // Enable/disable Select Floorplan button based on venue input
        venueInput.addEventListener('input', function() {
            const hasVenue = this.value.trim().length > 0;
            selectFloorplanBtn.disabled = !hasVenue;
            
            // If venue is cleared, hide floorplan selection
            if (!hasVenue) {
                floorplanSelection.style.display = 'none';
                floorplanInstruction.style.display = 'none';
                document.getElementById('selected-floorplan').value = '';
            }
        });
        
        // Show floorplan selection when button is clicked
        selectFloorplanBtn.addEventListener('click', function() {
            if (venueInput.value.trim()) {
                // Hide any AI estimations UI first
                document.getElementById('custom-floorplan-options').style.display = 'none';
                
                const idealSqm = getIdealSqmRange(wizardData.pax || 0);
                floorplanInstruction.innerHTML = `Select a floor plan:<br><small style="font-size: 16px;">Ideal sqm.: ${idealSqm}</small>`;
                floorplanInstruction.style.display = 'block';
                floorplanSelection.style.display = 'flex';
                loadFloorPlans();
            }
        });
    }

    // Restore location step data when returning from later steps
    function restoreLocationStepData() {
        const venueInput = document.getElementById('venue-input');
        const selectFloorplanBtn = document.getElementById('select-floorplan-btn');
        const floorplanSelection = document.getElementById('floorplan-selection');
        const floorplanInstruction = document.getElementById('floorplan-instruction');
        const customOptions = document.getElementById('custom-floorplan-options');
        
        // First, hide both UIs to ensure clean state
        floorplanSelection.style.display = 'none';
        floorplanInstruction.style.display = 'none';
        customOptions.style.display = 'none';
        
        // Enable the button if venue is filled
        if (venueInput.value.trim()) {
            selectFloorplanBtn.disabled = false;
            
            // EITHER/OR Logic: Determine which UI to show based on previous selection
            
            // CASE 1: AI Estimations were completed (final AI results exist)
            if (wizardData.aiEstimations) {
                // Show ONLY AI estimations UI, keep floorplan selection hidden
                restoreAIEstimations();
                return; // Exit early - don't show floorplan selection
            }
            
            // CASE 1.5: User uploaded image or entered dimensions but no AI results yet
            if (wizardData.uploadedFloorplanUrl || (wizardData.roomLength && wizardData.roomWidth)) {
                // Show custom options UI for continuing the AI process
                customOptions.style.display = 'flex';
                
                if (wizardData.uploadedFloorplanUrl) {
                    restoreUploadedImagePreview();
                } else if (wizardData.roomLength && wizardData.roomWidth) {
                    restoreDimensionInputs();
                }
                return; // Exit early - don't show floorplan selection
            }
            
            // CASE 2: Regular floorplan was selected from the 2 images
            if (wizardData.floorplan && wizardData.floorplan !== 'ai-generated') {
                // Show ONLY floorplan selection, keep AI UI hidden
                const idealSqm = getIdealSqmRange(wizardData.pax || 0);
                floorplanInstruction.innerHTML = `Select a floor plan:<br><small style="font-size: 16px;">Ideal sqm.: ${idealSqm}</small>`;
                floorplanInstruction.style.display = 'block';
                floorplanSelection.style.display = 'flex';
                loadFloorPlansAndRestore();
                return; // Exit early - don't show AI UI
            }
            
            // CASE 3: No previous selection - show default (floorplan selection only)
            const idealSqm = getIdealSqmRange(wizardData.pax || 0);
            floorplanInstruction.innerHTML = `Select a floor plan:<br><small style="font-size: 16px;">Ideal sqm.: ${idealSqm}</small>`;
            floorplanInstruction.style.display = 'block';
            floorplanSelection.style.display = 'flex';
            loadFloorPlans();
        }
    }

    // Restore uploaded image preview and AI analysis button
    function restoreUploadedImage() {
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const imageName = document.getElementById('image-name');
        const imageSize = document.getElementById('image-size');
        const analyzeBtn = document.getElementById('analyze-image-btn');
        const customOptions = document.getElementById('custom-floorplan-options');
        
        if (uploadArea && imagePreview && wizardData.uploadedFloorplanUrl) {
            // Show custom options
            customOptions.style.display = 'flex';
            
            // Hide upload area and show preview
            uploadArea.style.display = 'none';
            imagePreview.style.display = 'block';
            
            // Set preview image
            previewImage.src = wizardData.uploadedFloorplanUrl;
            imageName.textContent = wizardData.uploadedFloorplanFilename || 'Uploaded Image';
            imageSize.textContent = ''; // Size info not stored
            
            // Show analyze button only if no AI analysis has been done yet
            if (!wizardData.aiEstimations) {
                analyzeBtn.style.display = 'inline-block';
            } else {
                analyzeBtn.style.display = 'none';
                // Show AI results
                document.getElementById('ai-results').style.display = 'block';
                document.getElementById('ai-estimations').textContent = wizardData.aiEstimations;
            }
        }
    }

    // Load floorplans and restore previous selection
    function loadFloorPlansAndRestore() {
        // HIDE AI estimations UI completely when showing floorplan selection
        const customOptions = document.getElementById('custom-floorplan-options');
        customOptions.style.display = 'none';
        
        loadFloorPlans().then(() => {
            // After floorplans are loaded, highlight the previously selected one
            if (wizardData.floorplan) {
                const floorplanOptions = document.querySelectorAll('.floorplan-option');
                floorplanOptions.forEach(option => {
                    if (option.dataset.floorplan === wizardData.floorplan) {
                        option.classList.add('selected');
                        // Update hidden input
                        document.getElementById('selected-floorplan').value = wizardData.floorplan;
                    }
                });
            }
        });
    }

    // Restore AI estimations display (handles both uploaded images and dimensions)
    function restoreAIEstimations() {
        const customOptions = document.getElementById('custom-floorplan-options');
        const floorplanContainer = document.getElementById('floorplan-selection');
        const floorplanInstruction = document.getElementById('floorplan-instruction');
        
        // HIDE floorplan selection UI completely when showing AI estimations
        floorplanContainer.style.display = 'none';
        floorplanInstruction.style.display = 'none';
        
        if (wizardData.aiEstimations) {
            // Check if this was from an uploaded image
            if (wizardData.uploadedFloorplanUrl && wizardData.uploadedFloorplanFilename) {
                // Show custom options with uploaded image preview
                customOptions.style.display = 'flex';
                restoreUploadedImagePreview();
            } else {
                // This was from dimensions - show custom options with dimensions
                customOptions.style.display = 'flex';
                restoreDimensionInputs();
            }
            
            // In both cases, show the AI results and hide the use button
            const aiResults = document.getElementById('ai-results');
            const aiEstimations = document.getElementById('ai-estimations');
            aiResults.style.display = 'block';
            aiEstimations.textContent = wizardData.aiEstimations;
            
            // Hide the use button since estimations are already selected
            const useBtn = document.getElementById('use-ai-estimations-btn');
            if (useBtn) {
                useBtn.style.display = 'none';
            }
            
            // Show AI selection in the main container
            floorplanContainer.innerHTML = `
                <div class="floorplan-option selected ai-generated-option">
                    <div class="ai-generated-content">
                        <i class="fas fa-robot" style="font-size: 48px; color: #B8860B; margin-bottom: 10px;"></i>
                        <div class="floorplan-label">AI Custom Estimations</div>
                        <div style="font-size: 12px; color: #666; text-align: center;">Custom estimations generated</div>
                    </div>
                </div>
            `;
            
            // Set the hidden input
            document.getElementById('selected-floorplan').value = 'ai-generated';
            
            // Update button state
            updateLocationButtonState();
        }
    }
    
    // Restore uploaded image preview
    function restoreUploadedImagePreview() {
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const imageName = document.getElementById('image-name');
        const imageSize = document.getElementById('image-size');
        const analyzeBtn = document.getElementById('analyze-image-btn');
        
        if (uploadArea && imagePreview && wizardData.uploadedFloorplanUrl) {
            // Hide upload area and show preview
            uploadArea.style.display = 'none';
            imagePreview.style.display = 'block';
            
            // Set preview image
            previewImage.src = wizardData.uploadedFloorplanUrl;
            imageName.textContent = wizardData.uploadedFloorplanFilename || 'Uploaded Image';
            imageSize.textContent = ''; // Size info not stored
            
            // Show analyze button if no AI results yet
            if (analyzeBtn && !wizardData.aiEstimations) {
                analyzeBtn.style.display = 'inline-block';
            }
        }
    }
    
    // Restore dimension inputs
    function restoreDimensionInputs() {
        if (wizardData.roomLength && wizardData.roomWidth) {
            const roomLength = document.getElementById('room-length');
            const roomWidth = document.getElementById('room-width');
            const analyzeBtn = document.getElementById('analyze-dimensions-btn');
            
            if (roomLength && roomWidth) {
                roomLength.value = wizardData.roomLength;
                roomWidth.value = wizardData.roomWidth;
                
                // Show analyze button if no AI results yet
                if (analyzeBtn && !wizardData.aiEstimations) {
                    analyzeBtn.style.display = 'inline-block';
                }
            }
        }
    }

    // Clear AI-related state when floorplan is selected
    function clearAIState() {
        // Clear wizardData AI fields
        wizardData.uploadedFloorplanUrl = null;
        wizardData.uploadedFloorplanFilename = null;
        wizardData.aiEstimations = null;
        wizardData.roomLength = null;
        wizardData.roomWidth = null;
        
        // Clear AI UI elements
        const customOptions = document.getElementById('custom-floorplan-options');
        if (customOptions) {
            customOptions.style.display = 'none';
        }
        
        // Reset upload UI completely
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        const floorplanInput = document.getElementById('floorplan-input');
        if (uploadArea && imagePreview) {
            uploadArea.style.display = 'flex';
            imagePreview.style.display = 'none';
            document.getElementById('preview-image').src = '';
            document.getElementById('image-name').textContent = '';
            document.getElementById('image-size').textContent = '';
        }
        if (floorplanInput) {
            floorplanInput.value = '';
        }
        
        // Clear dimension inputs completely
        const roomLength = document.getElementById('room-length');
        const roomWidth = document.getElementById('room-width');
        if (roomLength) roomLength.value = '';
        if (roomWidth) roomWidth.value = '';
        
        // Hide and clear AI results
        const aiResults = document.getElementById('ai-results');
        const aiEstimations = document.getElementById('ai-estimations');
        if (aiResults) {
            aiResults.style.display = 'none';
        }
        if (aiEstimations) {
            aiEstimations.innerHTML = '';
        }
        
        console.log('Cleared all AI state: uploaded images, dimensions, and results');
    }
    
    // Clear floorplan-related state when AI is used
    function clearFloorplanState() {
        // Clear wizardData floorplan field (but keep floorplanName as it now contains AI estimations)
        wizardData.floorplan = null;
        
        // Clear floorplan UI selection
        const selectedInput = document.getElementById('selected-floorplan');
        // Don't clear this as it's set to 'ai-generated' for AI estimations
    }

    // Clear dimension inputs when image is uploaded
    function clearDimensionState() {
        // Clear wizardData dimension fields
        wizardData.roomLength = null;
        wizardData.roomWidth = null;
        
        // Clear dimension input UI
        const roomLength = document.getElementById('room-length');
        const roomWidth = document.getElementById('room-width');
        if (roomLength) roomLength.value = '';
        if (roomWidth) roomWidth.value = '';
        
        console.log('Cleared dimension state');
    }

    // Clear upload state when dimensions are entered
    function clearUploadState() {
        // Clear wizardData upload fields
        wizardData.uploadedFloorplanUrl = null;
        wizardData.uploadedFloorplanFilename = null;
        
        // Reset upload UI
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        const floorplanInput = document.getElementById('floorplan-input');
        if (uploadArea && imagePreview) {
            uploadArea.style.display = 'flex';
            imagePreview.style.display = 'none';
            document.getElementById('preview-image').src = '';
            document.getElementById('image-name').textContent = '';
            document.getElementById('image-size').textContent = '';
        }
        if (floorplanInput) {
            floorplanInput.value = '';
        }
        
        console.log('Cleared upload state');
    }

    // Get ideal square meter range based on pax count
    function getIdealSqmRange(pax) {
        if (pax <= 70) return "90-110sqm";
        if (pax <= 80) return "105-130sqm";
        if (pax <= 100) return "130-160sqm";
        if (pax <= 120) return "155-190sqm";
        if (pax <= 150) return "195-240sqm";
        if (pax <= 200) return "260-320sqm";
        if (pax <= 250) return "325-400sqm";
        return "400+sqm"; // For pax > 250
    }

    // Floor plan selection functionality
    function loadFloorPlans() {
        return new Promise((resolve) => {
        const pax = wizardData.pax || 0;
        const floorplanContainer = document.getElementById('floorplan-selection');
        
        // HIDE AI estimations UI when showing floorplan selection
        const customOptions = document.getElementById('custom-floorplan-options');
        customOptions.style.display = 'none';
        
        // Clear existing content
        floorplanContainer.innerHTML = '';
        
        // Define floor plan options based on pax ranges
        let floorPlans = [];
        
        if (pax <= 50) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/50_pax_1_ss3xaa.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/50_pax_2_xyynkf.png'
                }
            ];
        } else if (pax <= 70) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/70_pax_1_kia9rg.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/70_pax_2_gqzl3h.png'
                }
            ];
        } else if (pax <= 80) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/80_pax_1_dyaebj.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/80_pax_2_phx0yj.png'
                }
            ];
        } else if (pax <= 90) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/90_pax_1_ja3dds.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/90_pax_2_rpkuf1.png'
                }
            ];
        } else if (pax <= 100) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/100_pax_1_czxiqu.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/100_pax_2_unlui5.png'
                }
            ];
        } else if (pax <= 120) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/120_pax_1_pgqcik.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/120_pax_2_icgqtv.png'
                }
            ];
        } else if (pax <= 130) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/130_pax_1_yet6qc.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/130_pax_2_w1qzbb.png'
                }
            ];
        } else if (pax <= 150) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/150_pax_1_wcucqu.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/150_pax_2_nodcl3.png'
                }
            ];
        } else if (pax <= 160) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/160_pax_1_inbm3u.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/160_pax_2_v8qb63.png'
                }
            ];
        } else if (pax <= 170) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/170_pax_1_k6rq3r.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/170_pax_2_x9clqv.png'
                }
            ];
        } else if (pax <= 180) {
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/180_pax_1_ajj06i.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/180_pax_2_s0v7hp.png'
                }
            ];
        } else if (pax > 180) {
            // For pax > 180
            floorPlans = [
                {
                    name: 'Floor Plan 1',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034565/200_pax_1_amwaj9.png'
                },
                {
                    name: 'Floor Plan 2',
                    url: 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1756034560/24_j29h4o.png'
                }
            ];
        }
        
        // Get the ideal sqm range for current pax
        const idealSqm = getIdealSqmRange(pax);
        
        // Create floor plan options
        floorPlans.forEach((plan, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'floorplan-option';
            optionDiv.dataset.floorplan = plan.url;
            
            optionDiv.innerHTML = `
                <img src="${plan.url}" alt="${plan.name}" class="floorplan-image">
                <div class="floorplan-label">${plan.name}</div>
            `;
            
            optionDiv.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.floorplan-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Select this option
                this.classList.add('selected');
                
                // Store both the URL and the plan name
                document.getElementById('selected-floorplan').value = plan.url;
                wizardData.floorplanName = plan.name; // Store the display name
                
                // CLEAR AI STATE - when floorplan is selected, clear all AI data
                clearAIState();
                
                // Update button state
                updateLocationButtonState();
            });
            
            floorplanContainer.appendChild(optionDiv);
        });
        
        // Add "Make AI Estimations" button
        const aiButton = document.createElement('button');
        aiButton.type = 'button';
        aiButton.className = 'date-submit ai-estimations-btn';
        aiButton.textContent = 'Make AI Estimations';
        aiButton.style.cssText = 'margin-top: 20px; width: 200px;';
        
        aiButton.addEventListener('click', function() {
            // Show the custom options UI
            showCustomFloorplanOptions();
        });
        
        floorplanContainer.appendChild(aiButton);
        
        // Resolve the promise after DOM elements are created
        setTimeout(resolve, 0);
        });
    }

    // Custom Floorplan Options Functions
    function showCustomFloorplanOptions() {
        document.getElementById('floorplan-selection').style.display = 'none';
        document.getElementById('floorplan-instruction').style.display = 'none'; // Hide the instruction
        document.getElementById('custom-floorplan-options').style.display = 'flex';
        
        // CLEAR FLOORPLAN STATE - when switching to AI estimations, clear floorplan selection
        clearFloorplanState();
        
        // Reset the custom options
        document.getElementById('floorplan-upload').value = '';
        document.getElementById('room-length').value = '';
        document.getElementById('room-width').value = '';
        document.getElementById('ai-results').style.display = 'none';
        document.getElementById('analyze-image-btn').style.display = 'none';
        
        // Reset modern upload UI
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        if (uploadArea && imagePreview) {
            uploadArea.style.display = 'flex';
            imagePreview.style.display = 'none';
            document.getElementById('preview-image').src = '';
            document.getElementById('image-name').textContent = '';
            document.getElementById('image-size').textContent = '';
        }
        
        // Add event listeners
        setupCustomFloorplanEvents();
    }
    
    function setupCustomFloorplanEvents() {
        // Modern upload area elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('floorplan-upload');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const imageName = document.getElementById('image-name');
        const imageSize = document.getElementById('image-size');
        const changeBtn = document.getElementById('change-image-btn');
        const removeBtn = document.getElementById('remove-image-btn');

        // Check if required elements exist before adding event listeners
        if (!uploadArea || !fileInput) {
            console.warn('Required floorplan upload elements not found');
            return;
        }

        // Drag and drop events
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        // Click to upload
        uploadArea.addEventListener('click', function(e) {
            if (e.target === uploadArea || e.target.closest('.upload-content')) {
                fileInput.click();
            }
        });

        // File input change event
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        // Change image button
        if (changeBtn) {
            changeBtn.addEventListener('click', function() {
                fileInput.click();
            });
        }

        // Remove image button
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                removeImage();
            });
        }

        function handleFileSelection(file) {
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, or GIF).');
                return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                alert('File size must be less than 10MB.');
                return;
            }

            // Show loading state
            uploadArea.classList.add('uploading');

            // Clear dimension state when image is uploaded
            clearDimensionState();
            
            // Create file reader to preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                // Update preview
                previewImage.src = e.target.result;
                imageName.textContent = file.name;
                imageSize.textContent = formatFileSize(file.size);
                
                // Hide upload area and show preview
                uploadArea.style.display = 'none';
                imagePreview.style.display = 'block';
                
                // Show analyze button
                document.getElementById('analyze-image-btn').style.display = 'inline-block';
                
                // Remove loading state
                uploadArea.classList.remove('uploading');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            // Clear file input
            fileInput.value = '';
            
            // Hide preview and show upload area
            imagePreview.style.display = 'none';
            uploadArea.style.display = 'flex';
            
            // Hide analyze button
            document.getElementById('analyze-image-btn').style.display = 'none';
            
            // Clear preview data
            previewImage.src = '';
            imageName.textContent = '';
            imageSize.textContent = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Analyze uploaded image
        document.getElementById('analyze-image-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('floorplan-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file first.');
                return;
            }
            
            analyzeUploadedImage(file);
        });
        
        // Analyze room dimensions
        document.getElementById('analyze-dimensions-btn').addEventListener('click', function() {
            const length = parseFloat(document.getElementById('room-length').value);
            const width = parseFloat(document.getElementById('room-width').value);
            
            if (!length || !width || length <= 0 || width <= 0) {
                alert('Please enter valid room dimensions.');
                return;
            }
            
            // Clear upload state when dimensions are analyzed
            clearUploadState();
            
            analyzeRoomDimensions(length, width);
        });
        
        // Use AI estimations
        document.getElementById('use-ai-estimations-btn').addEventListener('click', function() {
            const estimations = document.getElementById('ai-estimations').textContent;
            
            // Store the AI estimations
            document.getElementById('ai-estimations-data').value = estimations;
            document.getElementById('selected-floorplan').value = 'ai-generated';
            wizardData.floorplanName = estimations; // Store the actual AI estimation text
            wizardData.aiEstimations = estimations;
            
            // CLEAR FLOORPLAN STATE - when AI is used, clear regular floorplan selection
            clearFloorplanState();
            
            // Hide custom options and show success message
            document.getElementById('custom-floorplan-options').style.display = 'none';
            document.getElementById('floorplan-selection').style.display = 'flex';
            
            // Update the display to show selection
            const floorplanContainer = document.getElementById('floorplan-selection');
            floorplanContainer.innerHTML = `
                <div class="floorplan-option selected ai-generated-option">
                    <div class="ai-generated-content">
                        <i class="fas fa-robot" style="font-size: 48px; color: #B8860B; margin-bottom: 10px;"></i>
                        <div class="floorplan-label">AI Custom Estimations</div>
                        <div style="font-size: 12px; color: #666; text-align: center;">Custom estimations generated</div>
                    </div>
                </div>
            `;
        });
        
        // Back to floorplan selection
        document.getElementById('back-to-floorplans-btn').addEventListener('click', function() {
            document.getElementById('custom-floorplan-options').style.display = 'none';
            document.getElementById('floorplan-selection').style.display = 'flex';
            
            // Show the instruction again
            const idealSqm = getIdealSqmRange(wizardData.pax || 0);
            const floorplanInstruction = document.getElementById('floorplan-instruction');
            floorplanInstruction.innerHTML = `Select a floor plan:<br><small style="font-size: 16px;">Ideal sqm.: ${idealSqm}</small>`;
            floorplanInstruction.style.display = 'block';
            
            // Deselect the Others option
            document.querySelectorAll('.floorplan-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        });
    }
    
    function analyzeUploadedImage(file) {
        const loadingDiv = document.getElementById('ai-loading');
        const resultsDiv = document.getElementById('ai-results');
        
        loadingDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        
        const formData = new FormData();
        formData.append('floorplan_image', file);
        formData.append('event_type', wizardData.eventType || 'wedding');
        formData.append('pax', wizardData.pax || 100);
        
        fetch('/api/ai/analyze-floorplan/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (data.success) {
                document.getElementById('ai-estimations').textContent = data.estimations;
                resultsDiv.style.display = 'block';
                
                // Store the Cloudinary URL and filename for later database saving
                wizardData.uploadedFloorplanUrl = data.cloudinary_url;
                wizardData.uploadedFloorplanFilename = data.filename;
                
                // Store the AI estimation result to floorplanName for booking summary display
                wizardData.floorplanName = data.estimations;
                wizardData.aiEstimations = data.estimations;
                
                // CLEAR FLOORPLAN STATE - when AI analysis succeeds, clear floorplan selection
                clearFloorplanState();
            } else {
                alert('Error analyzing image: ' + data.error);
            }
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            alert('Error analyzing image: ' + error.message);
        });
    }
    
    function analyzeRoomDimensions(length, width) {
        const loadingDiv = document.getElementById('ai-loading');
        const resultsDiv = document.getElementById('ai-results');
        
        loadingDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        
        const eventType = wizardData.eventType || 'wedding';
        const pax = wizardData.pax || 100;
        
        fetch('/api/ai/estimate-dimensions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                length: length,
                width: width,
                event_type: eventType,
                pax: pax
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (data.success) {
                document.getElementById('ai-estimations').textContent = data.estimations;
                resultsDiv.style.display = 'block';
                
                // Store the AI estimation result to floorplanName for booking summary display
                wizardData.floorplanName = data.estimations;
                wizardData.aiEstimations = data.estimations;
                
                // CLEAR FLOORPLAN STATE - when AI analysis succeeds, clear floorplan selection
                clearFloorplanState();
            } else {
                alert('Error generating estimations: ' + data.error);
            }
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            alert('Error generating estimations: ' + error.message);
        });
    }

    // Theme loading functionality
    function loadThemes() {
        const eventType = wizardData.eventType || '';
        const themeContainer = document.getElementById('theme-grids-container');
        const eventTypeSpan = document.getElementById('theme-event-type');
        
        // Update event type in the message
        if (eventTypeSpan) {
            eventTypeSpan.textContent = eventType.toLowerCase() + ' event';
        }
        
        // MUTUAL EXCLUSIVITY LOGIC: Check what type of theme was previously selected
        // Show EITHER preset themes OR custom generated theme, never both
        
        // Case 1: Custom theme was generated - show only the generated theme
        if (wizardData.isCustomTheme && wizardData.customThemeImage) {
            console.log('Restoring custom generated theme');
            showGeneratedTheme(wizardData.theme_name, wizardData.customThemeImage, '');
            return; // Exit early - don't load preset themes
        }
        
        // Case 2: Preset theme was selected OR no theme selected yet - show preset themes
        console.log('Loading preset themes');
        
        // Clear existing content
        themeContainer.innerHTML = '<div style="text-align: center; color: #666;">Loading themes...</div>';
        
        // Fetch themes for this event type
        fetch(`/api/themes/?event_type=${encodeURIComponent(eventType)}`)
            .then(response => response.json())
            .then(data => {
                themeContainer.innerHTML = '';
                
                if (data.themes && data.themes.length > 0) {
                    // Create theme grid container (similar to food-grid-container)
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'theme-grid-container';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'theme-section-title';
                    titleDiv.textContent = 'Available Themes';
                    sectionDiv.appendChild(titleDiv);
                    
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'theme-grid';
                    
                    data.themes.forEach(theme => {
                        const themeItem = document.createElement('div');
                        themeItem.className = 'theme-item';
                        themeItem.setAttribute('data-name', theme.name);
                        themeItem.setAttribute('data-images', JSON.stringify(theme.images));
                        
                        // Create container for all 3 images
                        const themeImagesContainer = document.createElement('div');
                        themeImagesContainer.className = 'theme-images';
                        
                        // Add all 3 images
                        theme.images.slice(0, 3).forEach(imageUrl => {
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.className = 'theme-preview';
                            img.alt = theme.name;
                            img.onerror = function() {
                                this.style.display = 'none';
                            };
                            themeImagesContainer.appendChild(img);
                        });
                        
                        const label = document.createElement('div');
                        label.className = 'theme-label';
                        label.textContent = theme.name;
                        
                        themeItem.appendChild(label);
                        themeItem.appendChild(themeImagesContainer);
                        gridDiv.appendChild(themeItem);
                        
                        // Add click handler
                        themeItem.addEventListener('click', function() {
                            selectTheme(theme.name, theme.images, this);
                        });
                    });
                    
                    sectionDiv.appendChild(gridDiv);
                    themeContainer.appendChild(sectionDiv);
                    
                    // Add "Generate Theme" button
                    const generateThemeBtn = document.createElement('button');
                    generateThemeBtn.type = 'button';
                    generateThemeBtn.className = 'date-submit generate-theme-btn';
                    generateThemeBtn.textContent = 'Generate Custom Theme';
                    generateThemeBtn.style.cssText = 'margin-top: 20px; width: 250px; display: block; margin-left: auto; margin-right: auto;';
                    
                    generateThemeBtn.addEventListener('click', function() {
                        showCustomThemeGenerator();
                    });
                    
                    themeContainer.appendChild(generateThemeBtn);
                    
                    // Restore previously selected preset theme if any (only if not custom theme)
                    if (!wizardData.isCustomTheme) {
                        const previouslySelectedTheme = document.getElementById('selected-theme-name').value;
                        if (previouslySelectedTheme && previouslySelectedTheme !== 'Custom Generated Theme') {
                            const themeItemToSelect = document.querySelector(`[data-name="${previouslySelectedTheme}"]`);
                            if (themeItemToSelect) {
                                themeItemToSelect.classList.add('selected');
                            }
                        }
                    }
                } else {
                    themeContainer.innerHTML = '<div style="text-align: center; color: #666;">No themes available for this event type.</div>';
                    
                    // Still add Generate Theme button even if no predefined themes
                    const generateThemeBtn = document.createElement('button');
                    generateThemeBtn.type = 'button';
                    generateThemeBtn.className = 'date-submit generate-theme-btn';
                    generateThemeBtn.textContent = 'Generate Custom Theme';
                    generateThemeBtn.style.cssText = 'margin-top: 20px; width: 250px; display: block; margin-left: auto; margin-right: auto;';
                    
                    generateThemeBtn.addEventListener('click', function() {
                        showCustomThemeGenerator();
                    });
                    
                    themeContainer.appendChild(generateThemeBtn);
                }
            })
            .catch(error => {
                console.error('Error loading themes:', error);
                themeContainer.innerHTML = '<div style="text-align: center; color: #d32f2f;">Error loading themes. Please try again.</div>';
            });
    }

    function selectTheme(themeName, themeImages, themeItemElement) {
        // CLEAR CUSTOM THEME DATA - Mutual exclusivity
        clearCustomThemeData();
        
        // Remove selection from all theme items
        document.querySelectorAll('.theme-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Select this theme item
        themeItemElement.classList.add('selected');
        
        // Store theme data
        document.getElementById('selected-theme-name').value = themeName;
        document.getElementById('selected-theme-urls').value = JSON.stringify(themeImages);
        
        // Update button state
        updateThemeButtonState();
        
        // Store in wizardData to indicate this is a preset theme
        wizardData.theme_name = themeName;
        wizardData.theme_urls = themeImages;
        wizardData.isCustomTheme = false; // Mark as preset theme
    }

    // Package image loading functionality
    function loadPackageImage() {
        const eventType = wizardData.eventType || '';
        const pax = parseInt(wizardData.pax) || 0;
        const packageImg = document.getElementById('package_img');
        
        // Normalize event type to lowercase and handle special cases
        let eventTypeLower = eventType.toLowerCase().trim();
        
        // Handle various event type variations
        if (eventTypeLower.includes('birthday') || eventTypeLower.includes('birth')) {
            eventTypeLower = 'birthday';
        } else if (eventTypeLower.includes('christening') || eventTypeLower.includes('baptism')) {
            eventTypeLower = 'christening';
        } else if (eventTypeLower.includes('kiddie') || eventTypeLower.includes('kids')) {
            eventTypeLower = 'kiddie';
        } else if (eventTypeLower.includes('wedding') || eventTypeLower.includes('marry')) {
            eventTypeLower = 'wedding';
        } else {
            // For any other event types, use "others"
            eventTypeLower = 'others';
        }
        
        let imageFilename = '';
        
        // Determine the appropriate image based on event type and pax
        if (eventTypeLower === 'birthday') {
            if (pax <= 50) imageFilename = 'birthday_50pax_yjwdwl.jpg';
            else if (pax <= 70) imageFilename = 'birthday_70pax_vew5ay.jpg';
            else if (pax <= 80) imageFilename = 'birthday_80pax_vvu9g2.jpg';
            else if (pax <= 100) imageFilename = 'birthday_100pax_zheug3.jpg';
            else if (pax <= 120) imageFilename = 'birthday_120pax_r25otc.jpg';
            else if (pax <= 130) imageFilename = 'birthday_130pax_hz5unq.jpg';
            else if (pax <= 150) imageFilename = 'birthday_150pax_gtqtim.jpg';
            else if (pax <= 160) imageFilename = 'birthday_160pax_b3ecp4.jpg';
            else if (pax <= 170) imageFilename = 'birthday_170pax_jtbtam.jpg';
            else if (pax <= 180) imageFilename = 'birthday_180_pax_hircrw.jpg';
            else imageFilename = 'birthday_200pax_gcjprl.jpg'; // For pax > 180
            
        } else if (eventTypeLower === 'christening') {
            if (pax <= 50) imageFilename = 'christening_50pax_nxh9ke.jpg';
            else if (pax <= 70) imageFilename = 'christening_70pax_cyznmy.jpg';
            else if (pax <= 80) imageFilename = 'christening_80pax_slf4sl.jpg';
            else if (pax <= 100) imageFilename = 'christening_100pax_insvxv.jpg';
            else if (pax <= 120) imageFilename = 'christening_120pax_ua9yie.jpg';
            else if (pax <= 150) imageFilename = 'christening_150pax_idheaa.jpg';
            else imageFilename = 'christening_200pax_t3vuye.jpg'; // For pax > 150
            
        } else if (eventTypeLower === 'kiddie') {
            if (pax <= 50) imageFilename = 'kiddie_50pax_dpgjez.jpg';
            else if (pax <= 70) imageFilename = 'kiddie_70pax_hdawxz.jpg';
            else if (pax <= 80) imageFilename = 'kiddie_80pax_twgrmz.jpg';
            else if (pax <= 100) imageFilename = 'kiddie_100pax_z1jsn0.jpg';
            else if (pax <= 120) imageFilename = 'kiddie_120pax_soflwe.jpg';
            else if (pax <= 130) imageFilename = 'kiddie_130pax_yeyoka.jpg';
            else if (pax <= 150) imageFilename = 'kiddie_150pax_m7cdrz.jpg';
            else if (pax <= 160) imageFilename = 'kiddie_160pax_b5ezdz.jpg';
            else if (pax <= 170) imageFilename = 'kiddie_170pax_irkxsg.jpg';
            else if (pax <= 180) imageFilename = 'kiddie_180pax_knwwyp.jpg';
            else imageFilename = 'kiddie_200pax_kmpgn4.jpg'; // For pax > 180
            
        } else if (eventTypeLower === 'wedding') {
            if (pax <= 50) imageFilename = 'wedding_50pax_akotgi.jpg';
            else if (pax <= 60) imageFilename = 'wedding_60pax_wjrahh.jpg';
            else if (pax <= 70) imageFilename = 'wedding_70pax_swgj6f.jpg';
            else if (pax <= 80) imageFilename = 'wedding_80pax_y7az0i.jpg';
            else if (pax <= 100) imageFilename = 'wedding_100pax_mtujpw.jpg';
            else if (pax <= 120) imageFilename = 'wedding_120pax_cnd4mj.jpg';
            else if (pax <= 130) imageFilename = 'wedding_130pax_eamuys.jpg';
            else if (pax <= 150) imageFilename = 'wedding_150pax_ftvdmh.jpg';
            else if (pax <= 160) imageFilename = 'wedding_160pax_twyve5.jpg';
            else if (pax <= 170) imageFilename = 'wedding_170pax_wb3mcl.jpg';
            else if (pax <= 180) imageFilename = 'wedding_180pax_aotyby.jpg';
            else if (pax <= 200) imageFilename = 'wedding_200pax_dsdfrl.jpg';
            else imageFilename = 'wedding_250pax_haxcqu.jpg'; // For pax > 200
            
        } else {
            // For "others" or any custom event types
            if (pax <= 100) imageFilename = 'Others_package_akx2zo.jpg';
            else imageFilename = 'others_package2_zazqff.jpg';
        }
        
        // Construct the full Cloudinary URL
        const baseUrl = 'https://res.cloudinary.com/dzjrdqkiw/image/upload/v1749018729/';
        const fullImageUrl = baseUrl + imageFilename;
        
        // Update the package image
        if (packageImg) {
            packageImg.src = fullImageUrl;
            packageImg.alt = `${eventType} ${pax} Pax Package`;
        }
    }

    // Step 3: Color Swatch Selection (Multi-select)
    let colorSwatchesInitialized = false;
    function initializeColorSwatches() {
        if (colorSwatchesInitialized) return;
        
        const colorSwatches = document.querySelectorAll('.color-swatch');
        const previewContainer = document.getElementById('color-selection-preview');
        
        colorSwatches.forEach(swatch => {
            // Remove any existing event listeners by cloning the element
            const newSwatch = swatch.cloneNode(true);
            swatch.parentNode.replaceChild(newSwatch, swatch);
        });
        
        // Re-select the swatches after cloning
        const freshColorSwatches = document.querySelectorAll('.color-swatch');
        
        freshColorSwatches.forEach(swatch => {
            swatch.addEventListener('click', function() {
                const selectedColor = this.dataset.color;
                
                // If already selected, remove it
                if (this.classList.contains('selected')) {
                    const currentOrder = parseInt(this.dataset.order);
                    this.classList.remove('selected');
                    this.removeAttribute('data-order');
                    
                    // Remove from wizardData.colors
                    wizardData.colors = wizardData.colors.filter(color => color !== selectedColor);
                    
                    // Update order numbers for remaining selections
                    freshColorSwatches.forEach(s => {
                        if (s.classList.contains('selected')) {
                            const order = parseInt(s.dataset.order);
                            if (order > currentOrder) {
                                s.dataset.order = order - 1;
                            }
                        }
                    });
                } else {
                    // Check if we already have 3 colors selected
                    if (wizardData.colors.length >= 3) {
                        showAlert('color', 'You can only select up to 3 colors.');
                        return;
                    }
                    
                    // Add new selection
                    this.classList.add('selected');
                    const order = wizardData.colors.length + 1;
                    this.dataset.order = order;
                    wizardData.colors.push(selectedColor);
                }
                
                updateColorPreview();
                updateColorButtonState();
                console.log('Colors selected:', wizardData.colors);
            });
        });
        
        colorSwatchesInitialized = true;
    }
    
    // Update the color stack preview
    function updateColorPreview() {
        const previewContainer = document.getElementById('color-selection-preview');
        
        if (wizardData.colors.length === 0) {
            previewContainer.style.display = 'none';
            return;
        }
        
        previewContainer.style.display = 'block';
        
        // Get color images for preview
        wizardData.colors.forEach((colorName, index) => {
            const layerId = `color-layer-${index + 1}`;
            const layerElement = document.getElementById(layerId);
            const colorDiv = layerElement.querySelector('.layer-color');
            
            // Find the corresponding swatch image
            const swatch = document.querySelector(`[data-color="${colorName}"]`);
            if (swatch) {
                const image = swatch.querySelector('.swatch-image');
                if (image) {
                    colorDiv.style.backgroundImage = `url('${image.src}')`;
                }
            }
        });
        
        // Show/hide layers based on selection count and clear unused layers
        for (let i = 0; i < 3; i++) {
            const layerId = `color-layer-${i + 1}`;
            const layerElement = document.getElementById(layerId);
            
            if (i < wizardData.colors.length) {
                layerElement.style.display = 'block';
            } else {
                layerElement.style.display = 'none';
                const colorDiv = layerElement.querySelector('.layer-color');
                colorDiv.style.backgroundImage = 'none';
                colorDiv.style.backgroundColor = 'transparent';
            }
        }
    }
    
    // Function to update color step button state
    function updateColorButtonState() {
        const nextBtn = document.querySelector('#step-3 .date-submit');
        nextBtn.disabled = wizardData.colors.length < 1;
    }

    document.getElementById('color-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (wizardData.colors.length < 1 || wizardData.colors.length > 3) {
            showAlert('color', 'Please select 1 to 3 colors for your event motif.');
            return;
        }
        
        updatePackageSummary();
        nextStep();
    });
    
    // Image Modal Functionality
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-img');
    const closeBtn = document.querySelector('.close-modal');
    const prevBtn = document.querySelector('.modal-prev');
    const nextBtn = document.querySelector('.modal-next');
    
    let currentImageUrl = '';

    // Make package image clickable
    function makePackageImageClickable() {
        const packageImg = document.getElementById('package_img');
        if (packageImg) {
            packageImg.style.cursor = 'pointer';
            packageImg.addEventListener('click', function() {
                currentImageUrl = this.src;
                modalImg.src = currentImageUrl;
                modal.classList.add('open');
            });
        }
    }

    // Modal event listeners
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            modal.classList.remove('open');
            modalImg.src = '';
        });
    }

    // Close modal on background click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('open');
                modalImg.src = '';
            }
        });
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === "Escape" && modal.classList.contains('open')) {
            modal.classList.remove('open');
            modalImg.src = '';
        }
    });

    // Hide navigation buttons for single image
    if (prevBtn && nextBtn) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }

    // Initialize food grids
    function initializeFoodGrids() {
        const container = document.getElementById('food-grids-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Create food sections
        const sections = [
            { key: 'beef', title: 'Beef', multiSelect: true },
            { key: 'pork', title: 'Pork', multiSelect: true },
            { key: 'chicken', title: 'Chicken', multiSelect: true },
            { key: 'seafood', title: 'Seafood', multiSelect: true },
            { key: 'pasta', title: 'Pasta (Select 1)', multiSelect: false },
            { key: 'drinks', title: 'Drinks (Select 1)', multiSelect: false }
        ];
        
        sections.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'food-grid-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'food-section-title';
            titleDiv.textContent = section.title;
            sectionDiv.appendChild(titleDiv);
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'food-grid';
            gridDiv.setAttribute('data-section', section.key);
            gridDiv.setAttribute('data-multi-select', section.multiSelect);
            
            foodMenuData[section.key].forEach((url, index) => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.setAttribute('data-name', getFoodName(url));
                foodItem.setAttribute('data-url', url);
                
                const img = document.createElement('img');
                img.src = url;
                img.className = 'food-image';
                img.alt = getFoodName(url);
                
                const label = document.createElement('div');
                label.className = 'food-label';
                label.textContent = getFoodName(url);
                
                foodItem.appendChild(img);
                foodItem.appendChild(label);
                gridDiv.appendChild(foodItem);
                
                // Add click handler
                foodItem.addEventListener('click', function() {
                    handleFoodItemClick(this, section.key, section.multiSelect);
                });
            });
            
            sectionDiv.appendChild(gridDiv);
            container.appendChild(sectionDiv);
        });
    }
    
    // Handle food item selection
    function handleFoodItemClick(foodItem, sectionKey, multiSelect) {
        const isSelected = foodItem.classList.contains('selected');
        const foodName = foodItem.getAttribute('data-name');
        
        if (multiSelect) {
            // Multi-select behavior for dishes
            if (isSelected) {
                foodItem.classList.remove('selected');
                // Remove from wizardData.menu
                const index = wizardData.menu.indexOf(foodName);
                if (index > -1) {
                    wizardData.menu.splice(index, 1);
                }
            } else {
                // Check dish limit based on package
                const requiredDishes = getRequiredDishCount();
                const currentDishCount = wizardData.menu.filter(item => 
                    !item.includes('Pancit') && !item.includes('Fettuccine') && 
                    !item.includes('Lasagna') && !item.includes('Linguine') && 
                    !item.includes('Baked Mac') && !item.includes('Rigatoni') && 
                    !item.includes('Spaghetti') && !item.includes('Penne') &&
                    !item.includes('Lemonade') && !item.includes('Juice') && 
                    !item.includes('Tea') && !item.includes('Seasons')
                ).length;
                
                if (currentDishCount >= requiredDishes) {
                    showAlert('food', `You can only select ${requiredDishes} dishes total.`);
                    return;
                }
                
                foodItem.classList.add('selected');
                wizardData.menu.push(foodName);
            }
        } else {
            // Single-select behavior for pasta and drinks
            const grid = foodItem.parentElement;
            grid.querySelectorAll('.food-item').forEach(item => item.classList.remove('selected'));
            
            if (!isSelected) {
                foodItem.classList.add('selected');
                // Update wizardData.menu appropriately
                if (sectionKey === 'pasta') {
                    // Remove any existing pasta
                    wizardData.menu = wizardData.menu.filter(item => 
                        !item.includes('Pancit') && !item.includes('Fettuccine') && 
                        !item.includes('Lasagna') && !item.includes('Linguine') && 
                        !item.includes('Baked Mac') && !item.includes('Rigatoni') && 
                        !item.includes('Spaghetti') && !item.includes('Penne')
                    );
                    wizardData.menu.push(foodName);
                } else if (sectionKey === 'drinks') {
                    // Remove any existing drink
                    wizardData.menu = wizardData.menu.filter(item => 
                        !item.includes('Lemonade') && !item.includes('Juice') && 
                        !item.includes('Tea') && !item.includes('Seasons')
                    );
                    wizardData.menu.push(foodName);
                }
            }
        }
        
        console.log('Updated menu:', wizardData.menu);
    }

    // Show booking summary
    function showBookingSummary() {
        console.log('showBookingSummary called');
        const summaryContainer = document.getElementById('booking-summary-content');
        const receiptContainer = document.getElementById('receipt-content');
        
        console.log('Summary container found:', !!summaryContainer);
        console.log('Receipt container found:', !!receiptContainer);
        console.log('Summary container element:', summaryContainer);
        console.log('Receipt container element:', receiptContainer);
        
        if (!summaryContainer || !receiptContainer) {
            console.error('Containers not found!');
            console.error('Available elements with booking-summary-content:', document.querySelectorAll('[id*="booking-summary"]'));
            console.error('Available elements with receipt-content:', document.querySelectorAll('[id*="receipt"]'));
            return;
        }

        // Debug floorplan data
        console.log('Summary Debug - floorplanName:', wizardData.floorplanName);
        console.log('Summary Debug - floorplan:', wizardData.floorplan);
        console.log('Summary Debug - aiEstimations:', wizardData.aiEstimations);
        console.log('Summary Debug - uploadedFloorplanUrl:', wizardData.uploadedFloorplanUrl);

        // Clear previous content
        summaryContainer.innerHTML = '';
        receiptContainer.innerHTML = '';

        // Generate original summary (left side) - keep original structure
        console.log('Generating summary...');
        generateOriginalSummary(summaryContainer);
        
        // Generate receipt (right side) - completely separate
        console.log('Generating receipt...');
        generateReceipt(receiptContainer);
        
        console.log('Summary content length:', summaryContainer.innerHTML.length);
        console.log('Receipt content length:', receiptContainer.innerHTML.length);
        
        // Setup PDF buttons after content is generated
        setTimeout(() => {
            console.log('Setting up PDF buttons after content generation...');
            setupPDFButtons();
        }, 100);
    }

    function generateOriginalSummary(container) {
        // Create summary sections - keeping original structure
        const sections = [
            {
                title: 'Event Details',
                items: [
                    { label: 'Celebrant Name', value: wizardData.celebrant },
                    { label: 'Event Date', value: wizardData.date },
                    { label: 'Event Type', value: wizardData.eventType },
                    { label: 'Number of Guests', value: `${wizardData.pax} Pax` },
                    { label: 'Color Motif', value: wizardData.colors.join(' → '), showColorPreview: true }
                ]
            },
            {
                title: 'Theme & Venue',
                items: [
                    { label: 'Theme', value: wizardData.theme_name },
                    { label: 'Venue', value: wizardData.location },
                    { label: 'Floor Plan', value: wizardData.floorplanName || 
                        (wizardData.aiEstimations || '') ||
                        (wizardData.floorplan && wizardData.floorplan !== 'ai-generated' ? 'Selected Floor Plan' : '') ||
                        'Not Selected' },
                    { label: 'Package', value: wizardData.package }
                ]
            },
            {
                title: 'Food Menu',
                items: [],
                showFoodImages: true
            }
        ];

        sections.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
            
            const titleDiv = document.createElement('h3');
            titleDiv.textContent = section.title;
            titleDiv.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
            sectionDiv.appendChild(titleDiv);

            if (section.showFoodImages && wizardData.menu && wizardData.menu.length > 0) {
                // Show selected food items with images
                const foodGrid = document.createElement('div');
                foodGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;';
                
                wizardData.menu.forEach(foodName => {
                    // Find the URL for this food item from the foodNames mapping
                    const foodUrl = Object.keys(foodNames).find(url => foodNames[url] === foodName);
                    
                    const foodItem = document.createElement('div');
                    foodItem.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;';
                    
                    if (foodUrl) {
                        const img = document.createElement('img');
                        img.src = foodUrl;
                        img.alt = foodName;
                        img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
                        img.onerror = function() {
                            this.style.display = 'none';
                        };
                        foodItem.appendChild(img);
                    }
                    
                    const label = document.createElement('div');
                    label.textContent = foodName;
                    label.style.cssText = 'text-align: center; font-size: 0.9rem; color: #333; font-weight: 500; line-height: 1.2;';
                    foodItem.appendChild(label);
                    
                    foodGrid.appendChild(foodItem);
                });
                
                sectionDiv.appendChild(foodGrid);
            } else {
                // Regular items
                section.items.forEach(item => {
                    if (item.value) {
                        const itemDiv = document.createElement('div');
                        itemDiv.style.cssText = 'margin: 8px 0; display: flex; justify-content: space-between; align-items: center;';
                        
                        const labelSpan = document.createElement('span');
                        labelSpan.textContent = item.label + ':';
                        labelSpan.style.cssText = 'font-weight: 600; color: #555;';
                        
                        if (item.showColorPreview && wizardData.colors && wizardData.colors.length > 0) {
                            // Create color preview container
                            const colorContainer = document.createElement('div');
                            colorContainer.style.cssText = 'display: flex; align-items: center; gap: 10px;';
                            
                            // Add text value
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = item.value;
                            valueSpan.style.cssText = 'color: #333; font-size: 0.9rem;';
                            colorContainer.appendChild(valueSpan);
                            
                            // Add color swatches
                            const swatchContainer = document.createElement('div');
                            swatchContainer.style.cssText = 'display: flex; gap: 3px;';
                            
                            wizardData.colors.forEach((colorName, index) => {
                                const swatch = document.querySelector(`[data-color="${colorName}"]`);
                                if (swatch) {
                                    const image = swatch.querySelector('.swatch-image');
                                    if (image) {
                                        const colorPreview = document.createElement('div');
                                        colorPreview.style.cssText = `
                                            width: 25px; 
                                            height: 25px; 
                                            border-radius: 4px; 
                                            background-image: url('${image.src}'); 
                                            background-size: cover; 
                                            background-position: center;
                                            border: 1px solid #ccc;
                                            position: relative;
                                        `;
                                        
                                        // Add order number
                                        const orderNum = document.createElement('div');
                                        orderNum.textContent = index + 1;
                                        orderNum.style.cssText = `
                                            position: absolute;
                                            bottom: -2px;
                                            right: -2px;
                                            background: #B8860B;
                                            color: white;
                                            width: 12px;
                                            height: 12px;
                                            border-radius: 50%;
                                            font-size: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        `;
                                        colorPreview.appendChild(orderNum);
                                        swatchContainer.appendChild(colorPreview);
                                    }
                                }
                            });
                            
                            colorContainer.appendChild(swatchContainer);
                            itemDiv.appendChild(colorContainer);
                        } else {
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = item.value;
                            valueSpan.style.cssText = 'color: #333; text-align: right; max-width: 60%; word-break: break-word;';
                            itemDiv.appendChild(valueSpan);
                        }
                        
                        itemDiv.insertBefore(labelSpan, itemDiv.firstChild);
                        sectionDiv.appendChild(itemDiv);
                    }
                });
            }

            container.appendChild(sectionDiv);
        });

        // Add theme images if available
        if (wizardData.theme_urls && wizardData.theme_urls.length > 0) {
            const themeImagesDiv = document.createElement('div');
            themeImagesDiv.style.cssText = 'background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;';
            
            const themeTitle = document.createElement('h3');
            themeTitle.textContent = 'Theme Images';
            themeTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1.1rem; border-bottom: 2px solid #AD974F; padding-bottom: 5px;';
            themeImagesDiv.appendChild(themeTitle);

            const imagesContainer = document.createElement('div');
            imagesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;';
            
            wizardData.theme_urls.slice(0, 3).forEach(imageUrl => {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
                img.alt = wizardData.theme_name;
                imagesContainer.appendChild(img);
            });

            themeImagesDiv.appendChild(imagesContainer);
            container.appendChild(themeImagesDiv);
        }
    }

    function generateReceipt(container) {
        // Receipt header
        const header = document.createElement('div');
        header.style.cssText = 'text-align: center; margin-bottom: 20px; border-bottom: 2px solid rgb(51, 51, 51); padding-bottom: 15px; display: flex; flex-direction: column';
        
        const companyName = document.createElement('h2');
        companyName.textContent = 'NIKE\'S CATERING SERVICES';
        companyName.style.cssText = 'margin: 0; color: #B8860B; font-size: 1.4rem; font-weight: bold;';
        
        const tagline = document.createElement('p');
        tagline.textContent = 'Celebrate with Nikes!';
        tagline.style.cssText = 'margin: 5px 0 0 0; color: #666; font-size: 0.9rem;';
        
        const receiptTitle = document.createElement('h3');
        receiptTitle.textContent = 'BOOKING RECEIPT';
        receiptTitle.style.cssText = 'margin: 15px 0 0 0; color: #333; font-size: 1.1rem;';
        
        header.appendChild(companyName);
        header.appendChild(tagline);
        header.appendChild(receiptTitle);
        container.appendChild(header);

        // Receipt details
        const details = document.createElement('div');
        details.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; justify-items: flex-start; margin-bottom: 20px;';
        
        const receiptItems = [
            { label: 'Booking Date', value: new Date().toLocaleDateString() },
            { label: 'Event Date', value: wizardData.date },
            { label: 'Celebrant', value: wizardData.celebrant },
            { label: 'Event Type', value: wizardData.eventType },
            { label: 'Guests', value: `${wizardData.pax} Pax` },
            { label: 'Theme', value: wizardData.theme_name },
            { label: 'Venue', value: wizardData.location },
            { label: 'Package', value: wizardData.package },
            { label: 'Color Motif', value: wizardData.colors.join(', ') }
        ];

        receiptItems.forEach(item => {
            if (item.value) {
                const itemDiv = document.createElement('div');
                
                const label = document.createElement('span');
                label.textContent = item.label + ':';
                label.className = 'label';
                
                const value = document.createElement('span');
                value.textContent = item.value;
                value.className = 'value';
                
                itemDiv.appendChild(label);
                itemDiv.appendChild(value);
                details.appendChild(itemDiv);
            }
        });

        container.appendChild(details);

        // Pricing section
        const pricingSection = document.createElement('div');
        pricingSection.style.cssText = 'display: flex;flex-direction: column; align-items: stretch;margin-bottom: 20px; background: rgb(248, 249, 250);padding: 15px; border-radius: 8px;';
        
        const pricingTitle = document.createElement('h4');
        pricingTitle.textContent = 'PRICE ESTIMATION';
        pricingTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 1rem; border-bottom: 2px solid #28a745; padding-bottom: 8px; text-align: center;';
        pricingSection.appendChild(pricingTitle);
        
        // Calculate package price using display pricing
        const packagePrice = calculatePackagePrice(wizardData.package, wizardData.eventType, wizardData.pax);
        
        // Package price
        const packagePriceDiv = document.createElement('div');
        packagePriceDiv.style.display = 'flex';
        packagePriceDiv.style.justifyContent = 'space-between';
        packagePriceDiv.style.alignItems = 'center';
        
        
        const packageLabel = document.createElement('span');
        packageLabel.textContent = `${wizardData.package}:`;
        packageLabel.className = 'label';
        
        const packageValue = document.createElement('span');
        packageValue.textContent = `PHP ${packagePrice.toLocaleString()}`;
        packageValue.className = 'value';
        packageValue.style.color = '#28a745';
        packageValue.style.fontWeight = '600';
        
        packagePriceDiv.appendChild(packageLabel);
        packagePriceDiv.appendChild(packageValue);
        pricingSection.appendChild(packagePriceDiv);
        
        // Add-ons section
        const selectedAddons = [];
        document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
            selectedAddons.push({
                name: checkbox.dataset.name,
                price: parseInt(checkbox.dataset.price)
            });
        });
        
        if (selectedAddons.length > 0) {
            const addonsTitle = document.createElement('h5');
            addonsTitle.textContent = 'Add-ons:';
            addonsTitle.style.cssText = 'margin: 15px 0 8px 0; color: #666; font-size: 0.85rem; font-weight: 600;';
            pricingSection.appendChild(addonsTitle);
            
            selectedAddons.forEach(addon => {
                const addonDiv = document.createElement('div');
                addonDiv.style.paddingLeft = '15px';
                addonDiv.style.display = 'flex';
                addonDiv.style.justifyContent = 'space-between';
                addonDiv.style.alignItems = 'center';
                
                const addonLabel = document.createElement('span');
                addonLabel.textContent = addon.name;
                addonLabel.className = 'label';
                addonLabel.style.color = '#666';
                
                const addonValue = document.createElement('span');
                addonValue.textContent = `PHP ${addon.price.toLocaleString()}`;
                addonValue.className = 'value';
                addonValue.style.color = '#28a745';
                addonValue.style.fontWeight = '500';
                
                addonDiv.appendChild(addonLabel);
                addonDiv.appendChild(addonValue);
                pricingSection.appendChild(addonDiv);
            });
        }
        
        // Total price
        const totalPrice = packagePrice + selectedAddons.reduce((sum, addon) => sum + addon.price, 0);
        
        const totalDiv = document.createElement('div');
        totalDiv.style.cssText = 'margin: 15px 0 0 0; padding: 10px 0; border-top: 2px solid #28a745; font-size: 1rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;';
        
        const totalLabel = document.createElement('span');
        totalLabel.textContent = 'TOTAL:';
        totalLabel.className = 'label';
        totalLabel.style.color = '#333';
        
        const totalValue = document.createElement('span');
        totalValue.textContent = `PHP ${totalPrice.toLocaleString()}`;
        totalValue.className = 'value';
        totalValue.style.color = '#28a745';
        totalValue.style.fontSize = '1.1rem';
        
        totalDiv.appendChild(totalLabel);
        totalDiv.appendChild(totalValue);
        pricingSection.appendChild(totalDiv);
        
        container.appendChild(pricingSection);

        // Food menu section
        if (wizardData.menu && wizardData.menu.length > 0) {
            const foodSection = document.createElement('div');
            foodSection.style.cssText = 'margin-bottom: 20px;';
            foodSection.style.display = 'flex';
            foodSection.style.flexDirection = 'column';
            foodSection.style.alignItems = 'flex-start';
            foodSection.style.justifyContent = 'flex-start';
            
            const foodTitle = document.createElement('h4');
            foodTitle.textContent = 'Selected Menu';
            foodTitle.style.cssText = 'margin: 0 0 10px 0; color: #333; font-size: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;';
            foodSection.appendChild(foodTitle);
            
            const foodList = document.createElement('div');
            foodList.style.cssText = 'font-size: 0.85rem;';
            
            wizardData.menu.forEach((foodName, index) => {
                const foodItem = document.createElement('div');
                foodItem.style.cssText = 'margin: 3px 0; padding: 2px 0;';
                foodItem.textContent = `${index + 1}. ${foodName}`;
                foodList.appendChild(foodItem);
            });
            
            foodSection.appendChild(foodList);
            container.appendChild(foodSection);
        }

        // Receipt footer
        const footer = document.createElement('div');
        footer.style.cssText = 'margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 0.8rem; color: #666;';
        
        const footerText = document.createElement('p');
        footerText.textContent = 'Thank you for choosing Nike\'s Catering Services!';
        footerText.style.cssText = 'margin: 0 0 5px 0;';
        
        const contactInfo = document.createElement('p');
        contactInfo.textContent = 'Contact: nikescateringofficial@gmail.com';
        contactInfo.style.cssText = 'margin: 0;';
        
        footer.appendChild(footerText);
        footer.appendChild(contactInfo);
        container.appendChild(footer);
    }

    // PDF Export functionality
    function exportReceiptToPDF() {
        try {
            console.log('Exporting PDF...');
            console.log('jsPDF available:', typeof window.jspdf);
            console.log('wizardData:', wizardData);
            
            // Check if jsPDF is available
            if (typeof window.jspdf === 'undefined') {
                console.error('jsPDF library not loaded');
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            console.log('jsPDF constructor:', jsPDF);
            const doc = new jsPDF();
            console.log('PDF document created:', doc);
            
            // Set up the PDF document
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('NIKE\'S CATERING SERVICES', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Celebrate with Nikes!', 105, 30, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('BOOKING RECEIPT', 105, 45, { align: 'center' });
            
            // Add a line
            doc.setLineWidth(0.5);
            doc.line(20, 50, 190, 50);
            
            // Receipt details
            let yPosition = 65;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const receiptData = [
                { label: 'Booking Date:', value: new Date().toLocaleDateString() },
                { label: 'Event Date:', value: wizardData.date || 'Not specified' },
                { label: 'Celebrant:', value: wizardData.celebrant || 'Not specified' },
                { label: 'Event Type:', value: wizardData.eventType || 'Not specified' },
                { label: 'Number of Guests:', value: wizardData.pax ? `${wizardData.pax} Pax` : 'Not specified' },
                { label: 'Theme:', value: wizardData.theme_name || 'Not specified' },
                { label: 'Venue:', value: wizardData.location || 'Not specified' },
                { label: 'Package:', value: wizardData.package || 'Not specified' },
                { label: 'Color Motif:', value: wizardData.colors ? wizardData.colors.join(', ') : 'Not specified' }
            ];
            
            receiptData.forEach(item => {
                doc.text(item.label, 20, yPosition);
                doc.text(item.value, 80, yPosition);
                yPosition += 7;
            });
            
            // Add food menu if available
            if (wizardData.menu && wizardData.menu.length > 0) {
                yPosition += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Selected Menu:', 20, yPosition);
                yPosition += 7;
                doc.setFont(undefined, 'normal');
                
                wizardData.menu.forEach((foodName, index) => {
                    doc.text(`${index + 1}. ${foodName}`, 25, yPosition);
                    yPosition += 6;
                });
            } else {
                yPosition += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Selected Menu:', 20, yPosition);
                yPosition += 7;
                doc.setFont(undefined, 'normal');
                doc.text('No menu selected', 25, yPosition);
                yPosition += 6;
            }
            
            // Add floor plan if available
            if (wizardData.floorplanName) {
                yPosition += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Floor Plan:', 20, yPosition);
                yPosition += 7;
                doc.setFont(undefined, 'normal');
                doc.text(wizardData.floorplanName, 25, yPosition);
                yPosition += 6;
            }
            
            // Add pricing section
            yPosition += 15;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('PRICE ESTIMATION', 105, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Add a line
            doc.setLineWidth(0.3);
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 8;
            
            // Calculate package price
            const packagePrice = calculatePackagePrice(wizardData.package, wizardData.eventType, wizardData.pax);
            
            // Package price
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${wizardData.package}:`, 20, yPosition);
            doc.text(`PHP ${packagePrice.toLocaleString()}`, 150, yPosition);
            yPosition += 7;
            
            // Add-ons
            const selectedAddons = [];
            document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
                selectedAddons.push({
                    name: checkbox.dataset.name,
                    price: parseInt(checkbox.dataset.price)
                });
            });
            
            if (selectedAddons.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('Add-ons:', 20, yPosition);
                yPosition += 7;
                doc.setFont(undefined, 'normal');
                
                selectedAddons.forEach(addon => {
                    doc.text(`• ${addon.name}`, 25, yPosition);
                    doc.text(`PHP ${addon.price.toLocaleString()}`, 150, yPosition);
                    yPosition += 6;
                });
            }
            
            // Total price
            const totalPrice = packagePrice + selectedAddons.reduce((sum, addon) => sum + addon.price, 0);
            yPosition += 8;
            doc.setLineWidth(0.3);
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 8;
            
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL:', 20, yPosition);
            doc.text(`PHP ${totalPrice.toLocaleString()}`, 150, yPosition);
            yPosition += 10;
            
            // Add footer
            yPosition += 15;
            doc.setLineWidth(0.3);
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 10;
            
            doc.setFontSize(9);
            doc.text('Thank you for choosing Nike\'s Catering Services!', 105, yPosition, { align: 'center' });
            yPosition += 6;
            doc.text('Contact: nikescateringofficial@gmail.com', 105, yPosition, { align: 'center' });
            yPosition += 6;
            doc.text('Phone: +63 123 456 7890', 105, yPosition, { align: 'center' });
            
            // Save the PDF
            const celebrantName = wizardData.celebrant ? wizardData.celebrant.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown';
            const eventDate = wizardData.date ? wizardData.date.replace(/\//g, '-') : 'Unknown_Date';
            const fileName = `Nike_Catering_Receipt_${celebrantName}_${eventDate}.pdf`;
            
            console.log('Saving PDF as:', fileName);
            doc.save(fileName);
            
            // Show success message
            alert('Receipt downloaded successfully!');
            
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
        }
    }
    
    
    // Function to setup PDF button listeners
    function setupPDFButtons() {
        console.log('Setting up PDF button listeners...');
        
        const exportBtn = document.getElementById('export-pdf-btn');
        
        if (exportBtn) {
            console.log('Found export button, adding listener');
            // Remove any existing listeners first
            exportBtn.replaceWith(exportBtn.cloneNode(true));
            const newExportBtn = document.getElementById('export-pdf-btn');
            newExportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Export PDF button clicked!');
                exportReceiptToPDF();
            });
        } else {
            console.log('Export button not found');
        }
    }

    // Add event listener for PDF export button
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up PDF export listener');
        
        // Use event delegation to handle dynamically created buttons
        document.addEventListener('click', function(e) {
            console.log('Click detected on:', e.target, 'ID:', e.target.id);
            if (e.target && e.target.id === 'export-pdf-btn') {
                console.log('PDF export button clicked via delegation');
                e.preventDefault();
                e.stopPropagation();
                exportReceiptToPDF();
            }
        });
        
        // Try to setup buttons immediately
        setupPDFButtons();
        
        // Also try after a delay
        setTimeout(setupPDFButtons, 1000);
        setTimeout(setupPDFButtons, 3000);
    });
    
    // Package pricing configuration - Based on actual package images analysis
    const packagePricing = {
        'Wedding': {
            'Package A': { 
                50: 40000, 60: 45000, 70: 50000, 80: 55000, 100: 60000, 
                120: 65000, 130: 70000, 150: 75000, 160: 80000, 170: 85000, 
                180: 95000, 200: 100000, 250: 125000 
            },
            'Package B': { 
                50: 45000, 60: 50000, 70: 55000, 80: 60000, 100: 65000, 
                120: 70000, 130: 75000, 150: 85000, 160: 90000, 170: 95000, 
                180: 105000, 200: 110000, 250: 145000 
            },
            'Package C': { 
                50: 50000, 60: 55000, 70: 60000, 80: 65000, 100: 70000, 
                120: 75000, 130: 80000, 150: 95000, 160: 100000, 170: 105000, 
                180: 115000, 200: 120000, 250: 165000 
            }
        },
        'Birthday Party': {
            'Package A': { 
                50: 35000, 70: 40000, 80: 45000, 100: 50000, 
                120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
                180: 85000, 200: 90000 
            },
            'Package B': { 
                50: 40000, 70: 45000, 80: 50000, 100: 55000, 
                120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
                180: 95000, 200: 100000 
            },
            'Package C': { 
                50: 45000, 70: 50000, 80: 55000, 100: 60000, 
                120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
                180: 105000, 200: 110000 
            }
        },
        'Kiddie Party': {
            'Package A': { 
                50: 35000, 70: 40000, 80: 45000, 100: 50000, 
                120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
                180: 85000, 200: 90000 
            },
            'Package B': { 
                50: 40000, 70: 45000, 80: 50000, 100: 55000, 
                120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
                180: 95000, 200: 100000 
            },
            'Package C': { 
                50: 45000, 70: 50000, 80: 55000, 100: 60000, 
                120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
                180: 105000, 200: 110000 
            }
        },
        'Christening': {
            'Package A': { 
                50: 30000, 70: 35000, 80: 40000, 100: 50000, 
                120: 50000, 150: 65000, 180: 80000, 200: 65000 
            },
            'Package B': { 
                50: 35000, 70: 40000, 80: 45000, 100: 55000, 
                120: 55000, 150: 70000, 180: 90000, 200: 70000 
            },
            'Package C': { 
                50: 40000, 70: 45000, 80: 50000, 100: 60000, 
                120: 60000, 150: 80000, 180: 100000, 200: 80000 
            }
        },
        'Corporate Event': {
            'Package A': { 
                50: 35000, 70: 40000, 80: 45000, 100: 50000, 
                120: 60000, 130: 65000, 150: 70000, 160: 75000, 170: 80000, 
                180: 85000, 200: 90000 
            },
            'Package B': { 
                50: 40000, 70: 45000, 80: 50000, 100: 55000, 
                120: 65000, 130: 70000, 150: 80000, 160: 85000, 170: 90000, 
                180: 95000, 200: 100000 
            },
            'Package C': { 
                50: 45000, 70: 50000, 80: 55000, 100: 60000, 
                120: 70000, 130: 75000, 150: 90000, 160: 95000, 170: 100000, 
                180: 105000, 200: 110000 
            }
        }
    };

    // Custom Event pricing (per-head)
    const customEventPricing = {
        '100+ pax': {
            'Package A': 350,
            'Package B': 400,
            'Package C': 450
        },
        'Below 100 pax': {
            'Package A': 400,
            'Package B': 450,
            'Package C': 500
        }
    };

    // Add-ons pricing
    const addonPrices = {
        'Upgraded Balloon Setup': 15000,
        'Kiddie Meals': 2000,
        'Fondant & Soft Icing Cake': 3000,
        'Food Carts': 5000,
        'Photo and Video Coverage': 5000,
        'Face Painting and Bubble Show': 5000,
        'Digital Invitations': 3000
    };

    // Calculate package price based on exact pax pricing
    function calculatePackagePrice(packageName, eventType, pax) {
        // Handle custom events with per-head pricing
        if (eventType && !packagePricing[eventType]) {
            // This is a custom event, use per-head pricing
            const pricingTier = pax >= 100 ? '100+ pax' : 'Below 100 pax';
            const perHeadPrice = customEventPricing[pricingTier][packageName];
            if (perHeadPrice) {
                return perHeadPrice * pax;
            }
            return 0;
        }

        const eventPricing = packagePricing[eventType];
        if (!eventPricing || !eventPricing[packageName]) {
            return 0;
        }

        const packagePrices = eventPricing[packageName];
        
        // Check if exact pax count exists
        if (packagePrices[pax]) {
            return packagePrices[pax];
        }
        
        // Find the closest lower and higher pax counts for interpolation
        const availablePax = Object.keys(packagePrices).map(Number).sort((a, b) => a - b);
        let lowerPax = null;
        let higherPax = null;
        
        for (let i = 0; i < availablePax.length; i++) {
            if (availablePax[i] <= pax) {
                lowerPax = availablePax[i];
            }
            if (availablePax[i] >= pax && !higherPax) {
                higherPax = availablePax[i];
                break;
            }
        }
        
        // If pax is lower than minimum, use minimum price
        if (!lowerPax) {
            return packagePrices[availablePax[0]];
        }
        
        // If pax is higher than maximum, use maximum price
        if (!higherPax) {
            return packagePrices[lowerPax];
        }
        
        // If exact match found, return it
        if (lowerPax === pax) {
            return packagePrices[lowerPax];
        }
        
        // Interpolate between lower and higher pax
        const lowerPrice = packagePrices[lowerPax];
        const higherPrice = packagePrices[higherPax];
        const pricePerPax = (higherPrice - lowerPrice) / (higherPax - lowerPax);
        const additionalPax = pax - lowerPax;
        
        return Math.round(lowerPrice + (additionalPax * pricePerPax));
    }

    // Calculate total price using display pricing
    function calculateTotalPrice() {
        const selectedPackage = wizardData.package;
        const eventType = wizardData.eventType;
        const pax = wizardData.pax;
        
        if (!selectedPackage || !eventType || !pax) {
            return 0;
        }

        // Use display pricing for total calculation (same as package display)
        const packagePrice = calculatePackagePrice(selectedPackage, eventType, pax);
        
        // Calculate add-ons total
        let addonsTotal = 0;
        document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
            addonsTotal += parseInt(checkbox.dataset.price);
        });

        console.log(`Total calculation: ${eventType} ${selectedPackage} for ${pax} pax`);
        console.log(`Package price: ${packagePrice}, Addons: ${addonsTotal}, Total: ${packagePrice + addonsTotal}`);

        return packagePrice + addonsTotal;
    }

    // Update package prices display
    function updatePackagePrices() {
        const eventType = wizardData.eventType || 'Wedding';
        const pax = wizardData.pax || 150;

        ['Package A', 'Package B', 'Package C'].forEach(packageName => {
            const price = calculatePackagePrice(packageName, eventType, pax);
            const priceElement = document.getElementById(`${packageName.toLowerCase().replace(' ', '-')}-price`);
            if (priceElement) {
                priceElement.textContent = `PHP ${price.toLocaleString()}`;
            }
        });
    }

    // Update total price display
    function updateTotalPrice() {
        const totalPrice = calculateTotalPrice();
        const totalElement = document.getElementById('total-package-price');
        if (totalElement) {
            totalElement.textContent = `PHP ${totalPrice.toLocaleString()}`;
        }
    }


    // Update AI recommendation
    function updateAIRecommendation() {
        const recommendationElement = document.getElementById('ai-recommendation-text');
        if (!recommendationElement) return;

        const eventType = wizardData.eventType || 'Wedding';
        const pax = wizardData.pax || 150;

        let recommendation = '';
        
        // Calculate prices for comparison
        const packageAPrice = calculatePackagePrice('Package A', eventType, pax);
        const packageBPrice = calculatePackagePrice('Package B', eventType, pax);
        const packageCPrice = calculatePackagePrice('Package C', eventType, pax);
        
        // Determine best recommendation based on event type and guest count
        if (eventType === 'Kiddie Party') {
            if (pax <= 50) {
                recommendation = `Package A (PHP ${packageAPrice.toLocaleString()}) is perfect for your small kiddie party with ${pax} guests.`;
            } else if (pax <= 100) {
                recommendation = `Package B (PHP ${packageBPrice.toLocaleString()}) offers great value with more entertainment options for your kiddie party.`;
            } else {
                recommendation = `Package C (PHP ${packageCPrice.toLocaleString()}) provides premium entertainment and activities for your large kiddie party.`;
            }
        } else if (eventType === 'Wedding') {
            if (pax <= 75) {
                recommendation = `Package A (PHP ${packageAPrice.toLocaleString()}) is ideal for your intimate wedding with ${pax} guests.`;
            } else if (pax <= 150) {
                recommendation = `Package B (PHP ${packageBPrice.toLocaleString()}) offers the perfect balance of elegance and value for your wedding.`;
            } else {
                recommendation = `Package C (PHP ${packageCPrice.toLocaleString()}) provides luxury service for your grand wedding celebration.`;
            }
        } else if (eventType === 'Birthday Party') {
            if (pax <= 60) {
                recommendation = `Package A (PHP ${packageAPrice.toLocaleString()}) is perfect for your birthday celebration with ${pax} guests.`;
            } else if (pax <= 120) {
                recommendation = `Package B (PHP ${packageBPrice.toLocaleString()}) offers great variety and entertainment for your birthday party.`;
            } else {
                recommendation = `Package C (PHP ${packageCPrice.toLocaleString()}) provides premium celebration experience for your large birthday party.`;
            }
        } else if (eventType === 'Christening') {
            if (pax <= 80) {
                recommendation = `Package A (PHP ${packageAPrice.toLocaleString()}) is perfect for your intimate christening with ${pax} guests.`;
            } else if (pax <= 120) {
                recommendation = `Package B (PHP ${packageBPrice.toLocaleString()}) offers elegant service for your christening celebration.`;
            } else {
                recommendation = `Package C (PHP ${packageCPrice.toLocaleString()}) provides premium service for your large christening celebration.`;
            }
        } else {
            // Corporate Event or other
            if (pax <= 80) {
                recommendation = `Package A (PHP ${packageAPrice.toLocaleString()}) is perfect for your corporate event with ${pax} guests.`;
            } else if (pax <= 150) {
                recommendation = `Package B (PHP ${packageBPrice.toLocaleString()}) offers professional service for your corporate event.`;
            } else {
                recommendation = `Package C (PHP ${packageCPrice.toLocaleString()}) provides premium corporate service for your large event.`;
            }
        }

        recommendationElement.textContent = `AI Recommendation: ${recommendation}`;
    }

    // Helper function to get required dish count
    function getRequiredDishCount() {
        switch (wizardData.package) {
            case 'Package A': return 3;
            case 'Package B': return 4;
            case 'Package C': return 5;
            default: return 4;
        }
    }

    // Package image modal functionality
    function openPackageImageModal() {
        const packageImg = document.getElementById('package_img');
        if (!packageImg) return;

        // Create modal if it doesn't exist
        let modal = document.getElementById('package-image-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'package-image-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            const modalImg = document.createElement('img');
            modalImg.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                cursor: default;
            `;
            
            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 30px;
                color: white;
                font-size: 40px;
                font-weight: bold;
                cursor: pointer;
                z-index: 10001;
            `;
            
            modal.appendChild(modalImg);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
            
            // Event listeners
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePackageImageModal();
                }
            });
            
            closeBtn.addEventListener('click', closePackageImageModal);
            
            // Store reference to modal image
            modal.modalImg = modalImg;
        }
        
        // Set image source and show modal
        modal.modalImg.src = packageImg.src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closePackageImageModal() {
        const modal = document.getElementById('package-image-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // Initialize color swatches when step 3 is shown
    const originalShowStep = showStep;
    showStep = function(stepIndex) {
        originalShowStep(stepIndex);
        if (stepIndex === 2) { // step-3 is index 2
            setTimeout(initializeColorSwatches, 100);
        }
        if (stepIndex === 8) { // step-8 is index 8 (food menu)
            updateFoodMenuMessage();
            setTimeout(initializeFoodGrids, 100);
        }
    };

    // Step 6: Package (Legacy - for backward compatibility)
    document.querySelectorAll('.package-choice-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.package-choice-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            
            // If package is changing, reset food selections
            const newPackage = this.textContent.trim();
            if (wizardData.package !== newPackage) {
                // Clear all selected food items
                document.querySelectorAll('.food-btn.selected').forEach(foodBtn => {
                    foodBtn.classList.remove('selected');
                });
            }
            
            wizardData.package = newPackage;
            document.getElementById('package-next-btn').disabled = false;
            
            // Update food menu message with new package requirements
            updateFoodMenuMessage();
        });
    });

    // New Package Selection Event Listeners
    document.addEventListener('click', function(e) {
        // Handle package card selection
        if (e.target.closest('.package-card')) {
            const packageCard = e.target.closest('.package-card');
            const packageName = packageCard.dataset.package;
            
            // Remove selected class from all cards
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            packageCard.classList.add('selected');
            
            // Update wizard data
            wizardData.package = packageName;
            
            // Update total price
            updateTotalPrice();
            
            // Enable next button
            document.getElementById('package-next-btn').disabled = false;
            
            console.log('Package selected:', packageName);
        }
        
        // Handle addon checkbox changes
        if (e.target.classList.contains('addon-checkbox')) {
            const addonItem = e.target.closest('.addon-item');
            const isChecked = e.target.checked;
            
            if (isChecked) {
                addonItem.classList.add('selected');
            } else {
                addonItem.classList.remove('selected');
            }
            
            // Update total price
            updateTotalPrice();
            
            console.log('Addon toggled:', e.target.dataset.name, 'Price:', e.target.dataset.price);
        }
    });

    document.getElementById('package-next-btn').addEventListener('click', nextStep);

    // Summary step event listeners
    document.getElementById('summary-back-btn').addEventListener('click', function() {
        showStep(8); // Go back to food menu
    });

    document.getElementById('confirm-booking-btn').addEventListener('click', function() {
        markStepComplete(9);
        submitBooking();
    });
    

    
    // Helper function to update food menu message based on package
    function updateFoodMenuMessage() {
        console.log('updateFoodMenuMessage called, wizardData.package:', wizardData.package);
        
        const getRequiredDishCount = () => {
            switch (wizardData.package) {
                case 'Package A': return 3;
                case 'Package B': return 4;
                case 'Package C': return 5;
                default: return 4; // Default fallback
            }
        };
        
        const requiredDishes = getRequiredDishCount();
        console.log('Required dishes:', requiredDishes);
        
        const messageElement = document.getElementById('food-menu-message');
        if (messageElement) {
            messageElement.innerHTML = `Please select <strong>${requiredDishes} dishes total</strong> + 1 pasta + 1 drink:`;
            console.log('Message updated successfully');
        } else {
            console.log('Message element not found');
        }
    }

    // Step 7: Food Menu
    // Add click handlers for food buttons with dynamic limits
    document.querySelectorAll('.food-btn-group').forEach(group => {
        const limit = parseInt(group.dataset.limit, 10);
        group.querySelectorAll('.food-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.closest('.food-section');
                const groupType = section.dataset.group;
                
                if (btn.classList.contains('selected')) {
                    // Always allow deselection
                    btn.classList.remove('selected');
                } else {
                    if (groupType === 'pasta' || groupType === 'drink') {
                        // For pasta and drink, follow the original limit (1 each)
                        const selectedButtons = group.querySelectorAll('.food-btn.selected');
                        if (selectedButtons.length >= limit) {
                            selectedButtons[0].classList.remove('selected');
                        }
                        btn.classList.add('selected');
                    } else {
                        // For dishes, check total across all dish groups
                        const getRequiredDishCount = () => {
                            switch (wizardData.package) {
                                case 'Package A': return 3;
                                case 'Package B': return 4;
                                case 'Package C': return 5;
                                default: return 4; // Add default case
                            }
                        };
                        
                        const allDishesSelected = document.querySelectorAll('.food-section:not([data-group="pasta"]):not([data-group="drink"]) .food-btn.selected');
                        const requiredDishes = getRequiredDishCount();
                        
                        if (allDishesSelected.length < requiredDishes) {
                            btn.classList.add('selected');
                        } else {
                            // Optional: Show a message when limit is reached
                            console.log(`Maximum ${requiredDishes} dishes already selected`);
                        }
                    }
                }
            });
        });
    });



    document.getElementById('food-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearAlert('food');

        const requiredDishes = getRequiredDishCount();

        // Get selected items from wizardData.menu (already updated by handleFoodItemClick)
        const selectedItems = wizardData.menu || [];
        
        // Count dishes, pasta, and drinks from the array
        let dishCount = 0;
        let pastaCount = 0;
        let drinkCount = 0;
        
        selectedItems.forEach(item => {
            // Check if it's pasta
            if (item.includes('Pancit') || item.includes('Fettuccine') || 
                item.includes('Lasagna') || item.includes('Linguine') || 
                item.includes('Baked Mac') || item.includes('Rigatoni') || 
                item.includes('Spaghetti') || item.includes('Penne')) {
                pastaCount++;
            }
            // Check if it's drink
            else if (item.includes('Lemonade') || item.includes('Juice') || 
                     item.includes('Tea') || item.includes('Seasons')) {
                drinkCount++;
            }
            // Otherwise it's a dish
            else {
                dishCount++;
            }
        });

        // Validate selections
        if (dishCount !== requiredDishes) {
            showAlert('food', `Please select exactly ${requiredDishes} dishes total.`);
            return;
        }
        if (pastaCount !== 1) {
            showAlert('food', 'Please select exactly 1 pasta.');
            return;
        }
        if (drinkCount !== 1) {
            showAlert('food', 'Please select exactly 1 drink.');
            return;
        }

        // Store the food selections (already stored by handleFoodItemClick)
        markStepComplete(8);
        console.log('About to show step 9...');
        showStep(9);
        console.log('Step 9 should now be visible');
        
        // Wait a moment for the step to be visible, then populate content
        setTimeout(() => {
            console.log('About to show booking summary...');
            showBookingSummary();
        }, 100);
    });

    function updatePackageSummary() {
        // Update package prices when summary changes
        updatePackagePrices();
        updateTotalPrice();
        
        // Legacy support - try to update old package-summary element if it exists
        const packageSummaryElement = document.getElementById('package-summary');
        if (packageSummaryElement) {
            let summary = `${wizardData.eventType} ${wizardData.pax} Pax`;
            if (wizardData.location) {
                if (wizardData.floorplanName && wizardData.aiEstimations) {
                    // For AI estimations, show a shortened version in summary
                    summary += ` - ${wizardData.location} (AI Custom Estimations)`;
                } else if (wizardData.floorplanName) {
                    // For regular floorplan selections, show the floorplan name
                    summary += ` - ${wizardData.location} (${wizardData.floorplanName})`;
                } else {
                    summary += ` - ${wizardData.location}`;
                }
            }
            packageSummaryElement.textContent = summary;
        }
    }

    // Helper function to extract filename from Cloudinary URL
    function extractFilename(url) {
        if (!url) return '';
        // Extract the filename with extension from the Cloudinary URL
        // e.g., "https://res.cloudinary.com/.../120_pax_2_icgqtv.png" -> "120_pax_2_icgqtv.png"
        const parts = url.split('/');
        return parts[parts.length - 1] || '';
    }

    function markStepComplete(stepIndex) {
        if (!completedSteps.includes(stepIndex)) {
            completedSteps.push(stepIndex);
        }
        updateProgressBar();
    }

    function submitBooking() {
        // Mark final step as completed
        markStepComplete(9);
        
        // Transform wizardData.menu array into the expected format
        const menuItems = wizardData.menu || [];
        const dishes = [];
        let pasta = "";
        let drink = "";
        
        menuItems.forEach(item => {
            // Check if it's pasta
            if (item.includes('Pancit') || item.includes('Fettuccine') || 
                item.includes('Lasagna') || item.includes('Linguine') || 
                item.includes('Baked Mac') || item.includes('Rigatoni') || 
                item.includes('Spaghetti') || item.includes('Penne')) {
                pasta = item;
            }
            // Check if it's drink
            else if (item.includes('Lemonade') || item.includes('Juice') || 
                     item.includes('Tea') || item.includes('Seasons')) {
                drink = item;
            }
            // Otherwise it's a dish
            else {
                dishes.push(item);
            }
        });
        
        // Prepare theme data based on type (custom vs preset)
        let themePayload;
        if (wizardData.isCustomTheme && wizardData.customThemeImage) {
            // Custom Generated Theme: Save with "Custom Generated Theme" name and Cloudinary URL
            themePayload = {
                theme_name: "Custom Generated Theme",
                theme_urls: [wizardData.customThemeImage] // Cloudinary URL goes in theme_urls column
            };
        } else if (wizardData.theme_name && wizardData.theme_urls) {
            // Preset Theme: Use normal preset theme data
            themePayload = {
                theme_name: wizardData.theme_name,
                theme_urls: wizardData.theme_urls
            };
        } else {
            // No theme selected
            themePayload = {
                theme_name: "",
                theme_urls: []
            };
        }
        
        // Prepare the payload with all collected data
        const payload = {
            celebrant_name: wizardData.celebrant,           // Step 0 - Celebrant's Name
            date: wizardData.date,                          // Step 1 - Date of Event
            event_type: wizardData.eventType,               // Step 2 - Type of Event
            color_motif: wizardData.colors,                 // Step 3 - Color Motif (array of 1-3 colors)
            pax: wizardData.pax,                            // Step 4 - Number of Pax
            theme_name: themePayload.theme_name,            // Step 5 - Theme Name (Custom Generated Theme OR preset name)
            theme_urls: themePayload.theme_urls,            // Step 5 - Theme URLs (Cloudinary URL for custom OR preset URLs)
            location: {                                     // Step 6 - Venue & Floor Plan
                venue: wizardData.location || "",
                floorplan_filename: wizardData.uploadedFloorplanFilename || 
                                   (wizardData.aiEstimations ? `ai_dimensions_${Date.now()}.txt` : extractFilename(wizardData.floorplan || "")),
                floorplan_display_name: wizardData.floorplanName || "", // This now contains the actual AI estimation text
                cloudinary_url: wizardData.uploadedFloorplanUrl || "",
                ai_estimations: wizardData.aiEstimations || ""
            },
            package: wizardData.package,                    // Step 7 - Package
            menu: {                                         // Step 8 - Food Menu (transformed format)
                dishes: dishes,
                pasta: pasta,
                drink: drink
            }
        };

        // Create form data for submission
        const formData = new FormData();
        formData.append("payload", JSON.stringify(payload));

        // Submit to backend
        fetch("{% url 'bookhere_submit' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
            },
            body: formData,
        })
        .then(response => {
            if (response.ok) {
                // Redirect to my_bookings page on success
                window.location.replace("/my_bookings");
            } else {
                throw new Error('Booking submission failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error submitting your booking. Please try again.');
        });
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper functions for mutual exclusivity
    function clearPresetThemeSelections() {
        // Clear all selected theme items visually
        document.querySelectorAll('.theme-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Clear form inputs for preset themes
        document.getElementById('selected-theme-name').value = '';
        document.getElementById('selected-theme-urls').value = '';
        
        // Clear wizardData preset theme data
        wizardData.theme_name = '';
        wizardData.theme_urls = [];
        wizardData.isCustomTheme = false;
        
        // Update button state
        updateThemeButtonState();
        
        console.log('Cleared preset theme selections');
    }
    
    function clearCustomThemeData() {
        // Clear wizardData custom theme data
        wizardData.isCustomTheme = false;
        wizardData.customThemeImage = null;
        
        // Remove any generated theme display
        const generatedThemeDisplay = document.getElementById('generated-theme-display');
        if (generatedThemeDisplay) {
            generatedThemeDisplay.remove();
        }
        
        // Remove custom theme interface if visible
        const customInterface = document.getElementById('custom-theme-interface');
        if (customInterface) {
            customInterface.remove();
        }
        
        // Update button state
        updateThemeButtonState();
        
        console.log('Cleared custom theme data');
    }

    // Custom Theme Generator Functions
    function showCustomThemeGenerator() {
        const themeContainer = document.getElementById('theme-grids-container');
        
        // CLEAR PRESET THEME SELECTIONS - Mutual exclusivity
        clearPresetThemeSelections();
        
        // Hide existing theme options
        const existingThemes = themeContainer.querySelector('.theme-grid-container');
        const existingGenerateBtn = themeContainer.querySelector('.generate-theme-btn');
        if (existingThemes) existingThemes.style.display = 'none';
        if (existingGenerateBtn) existingGenerateBtn.style.display = 'none';
        
        // Create custom theme generation interface
        const customThemeInterface = document.createElement('div');
        customThemeInterface.id = 'custom-theme-interface';
        customThemeInterface.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #AD974F; margin-bottom: 15px;">Generate Custom Theme</h3>
                <p style="color: #666; font-size: 0.95rem; max-width: 500px; margin: 0 auto;">
                    Create a unique theme tailored to your event using AI
                </p>
            </div>
            
            <div style="width: 100%; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #ddd;">
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #AD974F;">
                    <p style="margin: 0 0 10px 0; color: #333; font-size: 0.9rem; line-height: 1.4;">
                        <strong>Event:</strong> ${wizardData.eventType || 'Not selected'} • 
                        <strong>Guests:</strong> ${wizardData.pax || 'Not selected'} pax
                    </p>
                    <p style="margin: 0 0 10px 0; color: #333; font-size: 0.9rem; line-height: 1.4;">
                        <strong>Colors:</strong> ${wizardData.colors && wizardData.colors.length > 0 ? wizardData.colors.join(', ') : 'Not selected'}
                    </p>
                    <p style="margin: 0; color: #666; font-size: 0.85rem; line-height: 1.3;">
                        We'll automatically create a beautiful theme using your event details and colors. 
                        Add a description below for extra customization.
                    </p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label for="theme-description" style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        Theme Description (Optional):
                    </label>
                    <textarea 
                        id="theme-description" 
                        placeholder="Optional: Add specific details like 'vintage', 'modern', 'rustic', 'elegant', 'tropical paradise', etc. Leave blank for a beautiful default theme based on your event and colors."
                        style="width: 100%; height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; resize: vertical; font-family: inherit; line-height: 1.4;"
                        maxlength="300"
                    ></textarea>
                    <div style="text-align: right; margin-top: 5px;">
                        <span id="char-count" style="font-size: 0.8rem; color: #999;">0/300</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button 
                        id="back-to-preset-themes" 
                        style="padding: 12px 24px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 0.95rem;"
                    >
                        Select Preset Themes
                    </button>
                    <button 
                        id="generate-theme-btn" 
                        style="padding: 12px 24px; background: #AD974F; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600;"
                    >
                        Generate Theme
                    </button>
                </div>
            </div>
        `;
        
        themeContainer.appendChild(customThemeInterface);
        
        // Character count functionality
        const textarea = document.getElementById('theme-description');
        const charCount = document.getElementById('char-count');
        const generateBtn = document.getElementById('generate-theme-btn');
        
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length}/300`;
        });
        
        // Back to preset themes handler
        document.getElementById('back-to-preset-themes').addEventListener('click', function() {
            showPresetThemes();
        });
        
        // Generate theme handler
        generateBtn.addEventListener('click', function() {
            const description = textarea.value.trim();
            generateCustomTheme(description);
        });
        
        // Focus on textarea
        setTimeout(() => textarea.focus(), 100);
    }
    
    function showPresetThemes() {
        const themeContainer = document.getElementById('theme-grids-container');
        
        // CLEAR CUSTOM THEME DATA - Mutual exclusivity
        clearCustomThemeData();
        
        // Remove custom theme interface
        const customInterface = document.getElementById('custom-theme-interface');
        if (customInterface) {
            customInterface.remove();
        }
        
        // Show existing theme options
        const existingThemes = themeContainer.querySelector('.theme-grid-container');
        const existingGenerateBtn = themeContainer.querySelector('.generate-theme-btn');
        if (existingThemes) existingThemes.style.display = 'block';
        if (existingGenerateBtn) existingGenerateBtn.style.display = 'block';
    }
    
    function generateCustomTheme(description) {
        console.log('Generating custom theme with description:', description);
        
        // Check if we're in regeneration mode or initial generation
        const loadingIndicator = document.getElementById('theme-loading-indicator');
        const customInterface = document.getElementById('custom-theme-interface');
        
        if (loadingIndicator) {
            // We're regenerating - show the loading indicator
            loadingIndicator.style.display = 'block';
        } else if (customInterface) {
            // Initial generation - replace interface with loading indicator
            customInterface.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="display: inline-block; animation: spin 1s linear infinite; margin-bottom: 20px;">
                        <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #AD974F; border-radius: 50%;"></div>
                    </div>
                    <div style="color: #AD974F; font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                        Generating Custom Theme...
                    </div>
                    <div style="color: #666; font-size: 0.95rem; max-width: 400px; margin: 0 auto; line-height: 1.4;">
                        Our AI is creating a unique entrance design based on your event details. This may take up to a minute.
                    </div>
                </div>
            `;
        }
        
        // Add CSS animation for spinner if not already added
        if (!document.getElementById('spinner-style')) {
            const style = document.createElement('style');
            style.id = 'spinner-style';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Prepare data for API call
        const requestData = {
            description: description,
            event_type: wizardData.eventType || 'birthday',
            colors: wizardData.colors || [],
            pax: wizardData.pax || 50
        };
        
        // Create AbortController for timeout handling (5 minutes for OpenAI generation)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minute timeout
        
        // Make API call to generate theme
        fetch('/api/generate-custom-theme/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId); // Clear timeout on successful response
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Hide loading indicator first
                const loadingIndicator = document.getElementById('theme-loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Show generated theme (single image)
                showGeneratedTheme(data.theme_name, data.theme_image, data.description);
            } else {
                // Hide loading indicator and restore buttons
                const loadingIndicator = document.getElementById('theme-loading-indicator');
                const regenerateBtn = document.getElementById('regenerate-theme-btn');
                
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (regenerateBtn) {
                    regenerateBtn.disabled = false;
                    regenerateBtn.style.opacity = '1';
                    regenerateBtn.textContent = '🔄 Regenerate Theme';
                }
                
                showError('Failed to generate custom theme: ' + (data.error || 'Unknown error'));
                
                // If we're not in regeneration mode, go back to preset themes
                if (!loadingIndicator) {
                    showPresetThemes();
                }
            }
        })
        .catch(error => {
            clearTimeout(timeoutId); // Clear timeout on error
            console.error('Error generating theme:', error);
            
            // Hide loading indicator and restore buttons
            const loadingIndicator = document.getElementById('theme-loading-indicator');
            const regenerateBtn = document.getElementById('regenerate-theme-btn');
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            if (regenerateBtn) {
                regenerateBtn.disabled = false;
                regenerateBtn.style.opacity = '1';
                regenerateBtn.textContent = '🔄 Regenerate Theme';
            }
            
            // Handle specific error types
            let errorMessage = 'Failed to generate custom theme. Please try again.';
            if (error.name === 'AbortError') {
                errorMessage = 'Theme generation timed out after 5 minutes. Please try again with a shorter description.';
            } else if (error.message && error.message.includes('timeout')) {
                errorMessage = 'Connection timeout. Please check your internet connection and try again.';
            }
            
            showError(errorMessage);
            
            // If we're not in regeneration mode, go back to preset themes
            if (!loadingIndicator) {
                showPresetThemes();
            }
        });
    }
    
    function showGeneratedTheme(themeName, themeImage, description) {
        const themeContainer = document.getElementById('theme-grids-container');
        
        // Clear all content and show only the generated theme
        themeContainer.innerHTML = '';
        
        // Create generated theme display
        const generatedThemeDiv = document.createElement('div');
        generatedThemeDiv.id = 'generated-theme-display';
        generatedThemeDiv.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #AD974F; margin-bottom: 10px;">🤖 AI Generated Theme</h3>
                <p style="color: #666; font-size: 0.9rem;">${themeName}</p>
            </div>
            
            <div style="max-width: 500px; margin: 0 auto; text-align: center;">
                <div style="position: relative; display: inline-block;">
                    <img src="${themeImage}" alt="${themeName}" 
                         style="width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 3px solid #AD974F;" />
                    
                    <div style="position: absolute; top: 15px; right: 15px; background: #AD974F; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        AI Generated
                    </div>
                </div>
                
                <!-- Loading indicator (hidden by default) -->
                <div id="theme-loading-indicator" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #AD974F;">
                    <div style="display: inline-block; animation: spin 1s linear infinite; margin-bottom: 10px;">
                        <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #AD974F; border-radius: 50%;"></div>
                    </div>
                    <div style="color: #AD974F; font-size: 1rem; font-weight: 600;">
                        Generating your custom theme...
                    </div>
                    <div style="color: #666; font-size: 0.85rem; margin-top: 5px;">
                        🎨 AI is creating your entrance design (this may take 1-3 minutes)
                    </div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 8px;">
                        Please don't close this page while we generate your unique design
                    </div>
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                    <button 
                        id="select-preset-themes-btn"
                        style="padding: 12px 20px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 0.9rem;"
                    >
                        📋 Select Preset Themes
                    </button>
                    <button 
                        id="regenerate-theme-btn"
                        style="padding: 12px 20px; background: #AD974F; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;"
                    >
                        🔄 Regenerate Theme
                    </button>
                </div>
            </div>
        `;
        
        themeContainer.appendChild(generatedThemeDiv);
        
        // Set the theme data for form submission
        document.getElementById('selected-theme-name').value = themeName;
        document.getElementById('selected-theme-urls').value = JSON.stringify([themeImage]);
        
        // Store in wizardData to indicate this is a custom theme
        wizardData.theme_name = themeName;
        wizardData.theme_urls = [themeImage];
        wizardData.isCustomTheme = true; // Mark as custom theme
        wizardData.customThemeImage = themeImage; // Store the Cloudinary URL for database
        
        // Update button state
        updateThemeButtonState();
        
        // Add event handlers for buttons
        document.getElementById('select-preset-themes-btn').addEventListener('click', function() {
            showPresetThemes();
        });
        
        document.getElementById('regenerate-theme-btn').addEventListener('click', function() {
            regenerateTheme();
        });
        
        console.log('Generated theme displayed:', themeName, themeImage);
    }
    
    function regenerateTheme() {
        // Show loading indicator
        const loadingIndicator = document.getElementById('theme-loading-indicator');
        const regenerateBtn = document.getElementById('regenerate-theme-btn');
        
        if (loadingIndicator && regenerateBtn) {
            loadingIndicator.style.display = 'block';
            regenerateBtn.disabled = true;
            regenerateBtn.style.opacity = '0.6';
            regenerateBtn.textContent = '🔄 Generating...';
        }
        
        // Get the current description from previous generation or ask for new one
        const description = document.getElementById('theme-description')?.value || '';
        
        // Generate new theme
        generateCustomTheme(description);
    }
    
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            max-width: 400px;
            text-align: center;
        `;
        
        errorDiv.innerHTML = `
            <div style="margin-bottom: 15px;">${message}</div>
            <button onclick="this.parentElement.remove()" 
                    style="background: white; color: #dc3545; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                Close
            </button>
        `;
        
        document.body.appendChild(errorDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentElement) {
                errorDiv.remove();
            }
        }, 5000);
    }
});
</script>

</script>

</body>
</html>
