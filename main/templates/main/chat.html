{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-header">
            <h3>Messages</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>
        <div class="chat-list">
            {% for entry in chats %}
            {% with chat=entry.chat other_user=entry.other_user %}
            <div class="chat-item {% if chat.id == active_chat.id %}active{% endif %}" data-chat-id="{{ chat.id }}">
                <div class="chat-item-avatar">
                    {% if chat.is_group_chat %}
                    <i class="fas fa-users"></i>
                    {% else %}
                    {% if other_user.profile_picture %}
                    <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.username }}">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="chat-item-info">
                    <div class="chat-item-name">
                        {% if chat.is_group_chat %}
                        {{ chat.name }}
                        {% else %}
                        {{ other_user.get_full_name|default:other_user.username }}
                        {% endif %}
                    </div>
                    <div class="chat-item-preview">
                        {% with last_message=chat.messages.last %}
                        {% if last_message %}
                        {{ last_message.content|truncatechars:30 }}
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="chat-item-time">
                    {% with last_message=chat.messages.last %}
                    {% if last_message %}
                    {{ last_message.timestamp|timesince }} ago
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
    </div>

    <div class="chat-main">
        {% if active_chat %}
        <div class="chat-header">
            <div class="chat-header-info">
                {% if active_chat.is_group_chat %}
                <h4>{{ active_chat.name }}</h4>
                <span>{{ active_chat.participants.count }} participants</span>
                {% else %}
                <h4>{{ active_other_user.get_full_name|default:active_other_user.username }}</h4>
                <span>{% if active_other_user.is_online %}Online{% else %}Offline{% endif %}</span>
                {% endif %}
            </div>
            <div class="chat-header-actions">
                <button class="btn btn-icon" title="Search">
                    <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-icon" title="More options">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            {% for message in active_chat.messages.all %}
            <div class="message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                {% if not message.sender == request.user %}
                <div class="message-avatar">
                    {% if message.sender.profile_picture %}
                    <img src="{{ message.sender.profile_picture }}" alt="{{ message.sender.username }}">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                {% endif %}
                <div class="message-content">
                    <div class="message-text">{{ message.content }}</div>
                    <div class="message-time">{{ message.timestamp|time:"H:i" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="chat-input">
            <form id="message-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="chat_id" value="{{ active_chat.id }}">
                <div class="input-group">
                    <button type="button" class="btn btn-icon" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" name="message" class="form-control" placeholder="Type a message...">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="chat-welcome">
            <div class="welcome-content">
                <i class="fas fa-comments"></i>
                <h3>Welcome to Chat</h3>
                <p>Select a conversation or start a new one</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="new-chat-form" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Chat Type</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="chat_type" value="direct" checked>
                            <label class="form-check-label">Direct Message</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="chat_type" value="group">
                            <label class="form-check-label">Group Chat</label>
                        </div>
                    </div>
                    <div class="mb-3 direct-chat">
                        <label class="form-label">Select User</label>
                        <select class="form-select" name="user_id">
                            {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 group-chat" style="display: none;">
                        <label class="form-label">Group Name</label>
                        <input type="text" class="form-control" name="group_name">
                        <label class="form-label mt-3">Select Participants</label>
                        <select class="form-select" name="participants" multiple>
                            {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="new-chat-form" class="btn btn-primary">Create Chat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* [unchanged styling â€“ same as before] */
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatTypeInputs = document.querySelectorAll('input[name="chat_type"]');
    const directChat = document.querySelector('.direct-chat');
    const groupChat = document.querySelector('.group-chat');

    chatTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'direct') {
                directChat.style.display = 'block';
                groupChat.style.display = 'none';
            } else {
                directChat.style.display = 'none';
                groupChat.style.display = 'block';
            }
        });
    });

    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
        item.addEventListener('click', function() {
            const chatId = this.dataset.chatId;
            window.location.href = `/chat/${chatId}/`;
        });
    });

    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    const messageForm = document.getElementById('message-form');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/chat/send-message/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messagesContainer = document.getElementById('chat-messages');
                    const messageHtml = `
                        <div class="message message-sent">
                            <div class="message-content">
                                <div class="message-text">${data.message.content}</div>
                                <div class="message-time">${data.message.timestamp}</div>
                            </div>
                        </div>
                    `;
                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    this.reset();
                }
            });
        });
    }
});
</script>
{% endblock %}
