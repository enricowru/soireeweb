{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="{% static 'images/logo-round.png' %}">
  <title>Login</title>
</head>

<body>
  {% include "navbar.html" %}

  <div class="form-center">

   <!-- Login Form -->
<div class="login-container" id="login-form">
  <h2>LOGIN</h2>

    <!-- Error Message -->
    {% if message %}
      <div class="error-message">
        {{ message }}
      </div>
    {% endif %}

    <form action="{% url 'login' %}" method="POST" autocomplete="off">
        {% csrf_token %}
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" autocomplete="username" required>
        <br>
        <label for="password">Password:</label>
        <div class="password-wrapper">
          <input type="password" id="password" name="password" autocomplete="current-password" required>
          <i class="fa-solid fa-eye-slash toggle-password" toggle="#password"></i>
        </div>
        <div class="forgot-remember">
          <a href="#" id="forgot-password-link">Forgot password?</a>
        </div>
        <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <a href="#" id="show-register">Register here</a></p>
  </div>


    <!-- Register Form -->
    <div class="register-container" id="register-form" style="display:none;">
      <h2>REGISTER</h2>
      <form id="registerForm" autocomplete="off">
        <div class="register-flex">
          <div class="register-col">
            <label for="reg-firstname">First Name:</label>
            <input type="text" id="reg-firstname" name="firstname" autocomplete="given-name" required>
          </div>
          <div class="register-col">
            <label for="reg-lastname">Last Name:</label>
            <input type="text" id="reg-lastname" name="lastname" autocomplete="family-name" required>
          </div>
        </div>
        <div class="register-flex">
          <div class="register-col">
            <label for="reg-username">Username:</label>
            <input type="text" id="reg-username" name="username" autocomplete="username" required minlength="6" maxlength="12">
          </div>
          <div class="register-col">
            <label for="reg-mobile">Mobile Number (PH):</label>
            <input type="text" id="reg-mobile" name="mobile" autocomplete="tel" maxlength="11" placeholder="09XXXXXXXXX" required>
          </div>
        </div>
        <label for="reg-email">Email:</label>
        <input type="email" id="reg-email" name="email" autocomplete="email" required>

        <div class="register-flex">
          <div class="register-col">
            <label for="reg-password1">Password:</label>
            <div class="password-wrapper">
              <input type="password" id="reg-password1" name="password" autocomplete="new-password" required minlength="8" maxlength="16">
              <i class="fa-solid fa-eye-slash toggle-password" toggle="#reg-password1"></i>
            </div>
          </div>
          <div class="register-col">
            <label for="reg-password2">Confirm Password:</label>
            <div class="password-wrapper">
              <input type="password" id="reg-password2" name="password2" autocomplete="new-password" required minlength="8" maxlength="16">
              <i class="fa-solid fa-eye-slash toggle-password" toggle="#reg-password2"></i>
            </div>
          </div>
        </div>

        <button type="submit">Register</button>
      </form>
      <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
    </div>

    <!-- ✅ EMAIL VERIFICATION FORMS -->
    
    <!-- Email Verification Request Form -->
    <div class="login-container" id="email-verification-form" style="display:none;">
      <h2>Email Verification Required</h2>
      <p>Please verify your email address to complete registration.</p>
      <form id="emailVerificationForm" autocomplete="off">
        <input 
          type="email" 
          id="verification-email" 
          placeholder="Enter your email address" 
          required 
          autocomplete="off"
        />
        <button type="submit" id="send-verification-btn">Send Verification Code</button>
      </form>
      <div id="email-verification-message" class="message-container"></div>
      <p>Already have a code? <a href="#" id="show-verification-otp">Enter code</a></p>
      <p><a href="#" id="back-to-login-from-verification">Back to Login</a></p>
    </div>

    <!-- Email Verification OTP Form -->
    <div class="login-container" id="email-verification-otp-form" style="display:none;">
      <h2>Enter Verification Code</h2>
      <p>Please enter the 6-digit verification code sent to your email.</p>
      <form id="emailVerificationOtpForm" autocomplete="off">
        <input 
          type="email" 
          id="verification-otp-email" 
          placeholder="Enter your email address" 
          required 
          autocomplete="off"
        />
        <input 
          type="text" 
          id="verification-otp" 
          placeholder="Enter 6-digit verification code" 
          maxlength="6" 
          required 
          autocomplete="off"
        />
        <button type="submit" id="verify-email-btn">Verify Email</button>
      </form>
      <div id="email-verification-otp-message" class="message-container"></div>
      <p><a href="#" id="resend-verification-code">Resend verification code</a></p>
      <p><a href="#" id="back-to-login-from-otp">Back to Login</a></p>
    </div>

    <!-- ✅ FORGOT PASSWORD FORMS -->
    
    <!-- Email Request Form -->
    <div class="login-container" id="forgot-email-form" style="display:none;">
      <h2>FORGOT PASSWORD</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter your email to receive an OTP</p>
      
      <div id="forgot-email-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotEmailForm" autocomplete="off">
        {% csrf_token %}
        <label for="forgot-email">Email:</label>
        <input type="email" id="forgot-email" name="email" autocomplete="email" required>
        <button type="submit" id="send-otp-btn">Send OTP</button>
      </form>
      <p><a href="#" id="back-to-login">Back to Login</a></p>
    </div>

    <!-- OTP Verification Form -->
    <div class="login-container" id="forgot-otp-form" style="display:none;">
      <h2>VERIFY OTP</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter the 6-digit code sent to your email</p>
      
      <div id="forgot-otp-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotOtpForm" autocomplete="off">
        {% csrf_token %}
        <label for="forgot-otp">OTP Code:</label>
        <input type="text" id="forgot-otp" name="otp_code" maxlength="6" pattern="[0-9]{6}" required placeholder="123456">
        <button type="submit" id="verify-otp-btn">Verify OTP</button>
      </form>
      <p><a href="#" id="resend-otp">Resend OTP</a> | <a href="#" id="back-to-email">Change Email</a></p>
    </div>

    <!-- Password Reset Form -->
    <div class="login-container" id="forgot-reset-form" style="display:none;">
      <h2>RESET PASSWORD</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter your new password</p>
      
      <div id="forgot-reset-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotResetForm" autocomplete="off">
        {% csrf_token %}
        <label for="new-password">New Password:</label>
        <div class="password-wrapper">
          <input type="password" id="new-password" name="new_password" required minlength="8" maxlength="16">
          <i class="fa-solid fa-eye-slash toggle-password" toggle="#new-password"></i>
        </div>
        
        <label for="confirm-new-password">Confirm Password:</label>
        <div class="password-wrapper">
          <input type="password" id="confirm-new-password" name="confirm_password" required minlength="8" maxlength="16">
          <i class="fa-solid fa-eye-slash toggle-password" toggle="#confirm-new-password"></i>
        </div>
        
        <button type="submit" id="reset-password-btn">Reset Password</button>
      </form>
    </div>
  </div>

  <script>
     const BASE_URL = "{{ BASE_URL }}";
    
    // Check if we need to show email verification form
    {% if show_verification %}
      // Auto-show email verification form for unverified users
      window.addEventListener('DOMContentLoaded', function() {
        document.getElementById('verification-email').value = "{{ user_email }}";
        document.getElementById('verification-otp-email').value = "{{ user_email }}";
        showForm('email-verification-form');
      });
    {% endif %}
    // Toggle between login and register
    document.getElementById('show-register').onclick = function (e) {
      e.preventDefault();
      showForm('register-form');
    };
    document.getElementById('show-login').onclick = function (e) {
      e.preventDefault();
      showForm('login-form');
    };

    // ✅ EMAIL VERIFICATION NAVIGATION
    document.getElementById('show-verification-otp').onclick = function (e) {
      e.preventDefault();
      showForm('email-verification-otp-form');
    };

    document.getElementById('back-to-login-from-verification').onclick = function (e) {
      e.preventDefault();
      showForm('login-form');
    };

    document.getElementById('back-to-login-from-otp').onclick = function (e) {
      e.preventDefault();
      showForm('login-form');
    };

    document.getElementById('resend-verification-code').onclick = function (e) {
      e.preventDefault();
      showForm('email-verification-form');
    };

    // ✅ FORGOT PASSWORD NAVIGATION
    document.getElementById('forgot-password-link').onclick = function (e) {
      e.preventDefault();
      showForm('forgot-email-form');
    };

    document.getElementById('back-to-login').onclick = function (e) {
      e.preventDefault();
      showForm('login-form');
    };

    document.getElementById('back-to-email').onclick = function (e) {
      e.preventDefault();
      showForm('forgot-email-form');
    };

    // Helper function to get CSRF token from the current form
    function getCSRFToken() {
      // Try to get from any visible form
      const csrfTokens = document.querySelectorAll('[name=csrfmiddlewaretoken]');
      for (let token of csrfTokens) {
        if (token.closest('form') && token.closest('form').style.display !== 'none') {
          return token.value;
        }
      }
      // Fallback to any available token
      return csrfTokens[0] ? csrfTokens[0].value : '';
    }

    // Helper function to show forms
    function showForm(formId) {
      const forms = ['login-form', 'register-form', 'email-verification-form', 'email-verification-otp-form', 'forgot-email-form', 'forgot-otp-form', 'forgot-reset-form'];
      forms.forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(formId).style.display = 'block';
      
      // Clear any previous messages
      clearMessages();
    }

    function clearMessages() {
      const messageContainers = document.querySelectorAll('.message-container');
      messageContainers.forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
      });
    }

    function showMessage(containerId, message, isError = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>`;
      container.style.display = 'block';
    }

    // Toggle password show/hide
    document.querySelectorAll('.toggle-password').forEach(function (eye) {
      eye.addEventListener('click', function () {
        const input = document.querySelector(this.getAttribute('toggle'));
        input.type = input.type === "password" ? "text" : "password";
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });
    });

    // ✅ FORGOT PASSWORD EMAIL FORM
    document.getElementById('forgotEmailForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('forgot-email').value.trim();
      const submitBtn = document.getElementById('send-otp-btn');
      
      if (!email) {
        showMessage('forgot-email-message', 'Please enter your email address.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      try {
        const formData = new FormData();
        formData.append('email', email);

        const res = await fetch(`${BASE_URL}/forgot-password/request/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-email-message', result.message, false);
          
          // Store email for next step
          window.resetEmail = email;
          
          // Show OTP form after 2 seconds
          setTimeout(() => {
            showForm('forgot-otp-form');
          }, 2000);
        } else {
          showMessage('forgot-email-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-email-message', 'Failed to send OTP. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send OTP';
      }
    });

    // ✅ FORGOT PASSWORD OTP VERIFICATION
    document.getElementById('forgotOtpForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const otpCode = document.getElementById('forgot-otp').value.trim();
      const submitBtn = document.getElementById('verify-otp-btn');
      
      if (!otpCode || otpCode.length !== 6) {
        showMessage('forgot-otp-message', 'Please enter a valid 6-digit OTP code.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const formData = new FormData();
        formData.append('email', window.resetEmail);
        formData.append('otp_code', otpCode);

        const res = await fetch(`${BASE_URL}/forgot-password/verify-otp/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-otp-message', result.message, false);
          
          // Show reset form after 1 second
          setTimeout(() => {
            showForm('forgot-reset-form');
          }, 1000);
        } else {
          showMessage('forgot-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-otp-message', 'Failed to verify OTP. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify OTP';
      }
    });

    // ✅ RESEND OTP
    document.getElementById('resend-otp').onclick = async function (e) {
      e.preventDefault();
      
      if (!window.resetEmail) {
        showForm('forgot-email-form');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('email', window.resetEmail);

        const res = await fetch(`${BASE_URL}/forgot-password/request/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();
        
        if (result.success) {
          showMessage('forgot-otp-message', 'New OTP has been sent to your email.', false);
          document.getElementById('forgot-otp').value = '';
        } else {
          showMessage('forgot-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-otp-message', 'Failed to resend OTP. Please try again.', true);
      }
    };

    // ✅ FORGOT PASSWORD RESET FORM
    document.getElementById('forgotResetForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-new-password').value;
      const submitBtn = document.getElementById('reset-password-btn');
      
      if (!newPassword || !confirmPassword) {
        showMessage('forgot-reset-message', 'Please fill in all fields.', true);
        return;
      }

      if (newPassword.length < 8 || newPassword.length > 16) {
        showMessage('forgot-reset-message', 'Password must be 8 to 16 characters long.', true);
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('forgot-reset-message', 'Passwords do not match.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Resetting...';

      try {
        const formData = new FormData();
        formData.append('new_password', newPassword);
        formData.append('confirm_password', confirmPassword);

        const res = await fetch(`${BASE_URL}/forgot-password/reset/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-reset-message', result.message, false);
          
          // Clear stored email
          delete window.resetEmail;
          
          // Redirect to login after 3 seconds
          setTimeout(() => {
            showForm('login-form');
            // Clear reset form
            document.getElementById('forgotResetForm').reset();
          }, 3000);
        } else {
          showMessage('forgot-reset-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-reset-message', 'Failed to reset password. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
      }
    });

     // Validate and submit register form
    document.getElementById('registerForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const firstname = document.getElementById('reg-firstname').value.trim();
      const lastname = document.getElementById('reg-lastname').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const mobile = document.getElementById('reg-mobile').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password1').value;
      const password2 = document.getElementById('reg-password2').value;

      if (username.length < 6 || username.length > 12) {
        alert("❌ Username must be 6 to 12 characters long.");
        return;
      }

      if (password.length < 8 || password.length > 16) {
        alert("❌ Password must be 8 to 16 characters long.");
        return;
      }

      if (password !== password2) {
        alert("❌ Passwords do not match!");
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}/signup/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ firstname, lastname, username, mobile, email, password })
        });

        const result = await res.json();

        if (res.status === 201) {
          if (result.needs_verification) {
            alert("✅ " + result.message);
            document.getElementById('registerForm').reset();
            // Pre-fill email for verification
            document.getElementById('verification-email').value = email;
            document.getElementById('verification-otp-email').value = email;
            showForm('email-verification-otp-form');
          } else {
            alert("✅ Registration successful!");
            document.getElementById('registerForm').reset();
            document.getElementById('show-login').click();
          }
        } else {
          alert("❌ " + (result.message || "Registration failed."));
        }
      } catch (err) {
        console.error("Network error:", err);
        alert("❌ Registration failed due to server/network error.");
      }
    });

    // ✅ EMAIL VERIFICATION REQUEST FORM
    document.getElementById('emailVerificationForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('verification-email').value.trim();
      const submitBtn = document.getElementById('send-verification-btn');
      
      if (!email) {
        showMessage('email-verification-message', 'Please enter your email address.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      try {
        const formData = new FormData();
        formData.append('email', email);

        const res = await fetch(`${BASE_URL}/email-verification/request/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ email })
        });

        const result = await res.json();

        if (result.success) {
          showMessage('email-verification-message', result.message, false);
          
          // Pre-fill email for OTP form
          document.getElementById('verification-otp-email').value = email;
          
          // Show OTP form after 2 seconds
          setTimeout(() => {
            showForm('email-verification-otp-form');
          }, 2000);
        } else {
          showMessage('email-verification-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('email-verification-message', 'Failed to send verification code. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Verification Code';
      }
    });

    // ✅ EMAIL VERIFICATION OTP FORM
    document.getElementById('emailVerificationOtpForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('verification-otp-email').value.trim();
      const otpCode = document.getElementById('verification-otp').value.trim();
      const submitBtn = document.getElementById('verify-email-btn');
      
      if (!email) {
        showMessage('email-verification-otp-message', 'Please enter your email address.', true);
        return;
      }
      
      if (!otpCode || otpCode.length !== 6) {
        showMessage('email-verification-otp-message', 'Please enter a valid 6-digit verification code.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const res = await fetch(`${BASE_URL}/email-verification/verify/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ email, otp: otpCode })
        });

        const result = await res.json();

        if (result.success) {
          showMessage('email-verification-otp-message', result.message, false);
          
          // Clear form and redirect to login after success
          document.getElementById('emailVerificationOtpForm').reset();
          
          setTimeout(() => {
            showForm('login-form');
          }, 2000);
        } else {
          showMessage('email-verification-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('email-verification-otp-message', 'Verification failed. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify Email';
      }
    });
  </script>
</body>
</html>
