{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="{% static 'images/logo-round.png' %}">
  <title>Login</title>
</head>

<body>
  {% include "navbar.html" %}

  <div class="form-center">
    <div class="auth-container" id="main-auth-container">
      <!-- Left Column - Form -->
      <div class="form-column">
        <!-- Login Form -->
        <div class="login-container" id="login-form">
          <div class="form-header">
            <p class="greeting">Welcome back!</p>
            <h2>Login</h2>
          </div>

          <!-- Error Message -->
          {% if message %}
            <div class="error-message">
              {{ message }}
            </div>
          {% endif %}

          <form action="{% url 'login' %}" method="POST" autocomplete="off">
              {% csrf_token %}
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" autocomplete="username" required minlength="6" maxlength="12">
              </div>
              <div class="form-group">
                <label for="password">Password</label>
                <div class="password-wrapper">
                  <input type="password" id="password" name="password" autocomplete="current-password" required minlength="8" maxlength="16">
                  <i class="fa-solid fa-eye-slash toggle-password" toggle="#password"></i>
                </div>
              </div>
              <div class="forgot-remember">
                <a href="#" id="forgot-password-link">Forgot password?</a>
              </div>
              <button type="submit">Login</button>
          </form>
          <p class="switch-form">Don't have an account? <a href="#" id="show-register">Register here</a></p>
        </div>

        <!-- Register Form -->
        <div class="login-container" id="register-form" style="display:none;">
          <div class="form-header">
            <p class="member-link">Start celebrating with Nikes!</p>
            <h2>Registration</h2>
          </div>

          <!-- Registration Error Message -->
          <div id="register-error-message" class="error-message" style="display:none;"></div>
          
          <form id="registerForm" autocomplete="off">
            <div class="register-flex">
              <div class="register-col">
                <label for="reg-firstname">First Name</label>
                <input type="text" id="reg-firstname" name="firstname" autocomplete="given-name" minlength="3" maxlength="20">
              </div>
              <div class="register-col">
                <label for="reg-lastname">Last Name</label>
                <input type="text" id="reg-lastname" name="lastname" autocomplete="family-name" minlength="3" maxlength="20s">
              </div>
            </div>
            
            <div class="register-flex">
              <div class="register-col">
                <label for="reg-username">Username</label>
                <input type="text" id="reg-username" name="username" autocomplete="username" required minlength="6" maxlength="12">
              </div>
              <div class="register-col">
                <label for="reg-mobile">Mobile Number</label>
                <input type="text" id="reg-mobile" name="mobile" autocomplete="tel" minlength="11" maxlength="11" placeholder="09XXXXXXXXX" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="reg-email">Email Address</label>
              <input type="email" id="reg-email" name="email" autocomplete="email"  minlength="6" maxlength="254" pattern=".{6,254}"  required>
            </div>
            
            <div class="register-flex">
              <div class="register-col">
                <label for="reg-password1">Password</label>
                <div class="password-wrapper">
                  <input type="password" id="reg-password1" name="password" autocomplete="new-password" required minlength="8" maxlength="16">
                  <i class="fa-solid fa-eye-slash toggle-password" toggle="#reg-password1"></i>
                </div>
                <div id="password-requirements" class="password-requirements" style="display: none;">
                  <h4>Password Requirements:</h4>
                  <ul>
                    <li id="req-length">At least 8 characters long</li>
                    <li id="req-uppercase">At least one uppercase letter (A-Z)</li>
                    <li id="req-lowercase">At least one lowercase letter (a-z)</li>
                    <li id="req-number">At least one number (0-9)</li>
                  </ul>
                </div>
              </div>
              <div class="register-col">
                <label for="reg-password2">Confirm Password</label>
                <div class="password-wrapper">
                  <input type="password" id="reg-password2" name="password2" autocomplete="new-password" required minlength="8" maxlength="16">
                  <i class="fa-solid fa-eye-slash toggle-password" toggle="#reg-password2"></i>
                </div>
              </div>
            </div>

            <div class="terms-checkbox">
              <label class="checkbox-label">
                <input type="checkbox" id="terms-checkbox">
                <span class="checkmark"></span>
                I agree to all the statements included in the <a href="#" id="terms-link">Terms and Policy</a> and <a href="#" id="privacy-link">Data Privacy</a>
              </label>
            </div>

            <button type="submit" id="register-btn">Register</button>
          </form>
          <p class="switch-form">Already have an account? <a href="#" id="show-login">Login here</a></p>
        </div>
      </div>

      <!-- Right Column - Image -->
      <div class="image-column">
        <div class="brand-section">
          <h1 class="brand-name">NIKE'S CATERING SERVICES</h1>
          <h3 class="brand-tagline">Celebrate with <span class="highlight">Nikes!</span></h3>
        </div>
        <div class="background-image" id="login-bg">
          <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1758442090/loginbg_fndv0o.jpg" alt="Background" />
        </div>
        <div class="background-image" id="register-bg" style="display:none;">
          <img src="https://res.cloudinary.com/dzjrdqkiw/image/upload/v1758442089/registerbg_rlyfuy.jpg" alt="Background" />
        </div>
      </div>
    </div>



    <!-- ✅ EMAIL VERIFICATION FORMS -->
    
    <!-- Email Verification Request Form -->
    <div class="login-container" id="email-verification-form" style="display:none;">
      <h2>Email Verification Required</h2>
      <p>Please verify your email address to complete registration.</p>
      <form id="emailVerificationForm" autocomplete="off">
        <input 
          type="email" 
          id="verification-email" 
          placeholder="Enter your email address" 
          required 
          autocomplete="off"
        />
        <button type="submit" id="send-verification-btn">Send Verification Code</button>
      </form>
      <div id="email-verification-message" class="message-container"></div>
      <p>Already have a code? <a href="#" id="show-verification-otp">Enter code</a></p>
      <p><a href="#" id="back-to-login-from-verification">Back to Login</a></p>
    </div>

    <!-- Email Verification OTP Form -->
    <div class="login-container" id="email-verification-otp-form" style="display:none;">
      <h2>Enter Verification Code</h2>
      <p>Please enter the 6-digit verification code sent to your email. Please also check your email spam folder for the OTP.</p>
      <form id="emailVerificationOtpForm" autocomplete="off">
        <input 
          type="email" 
          id="verification-otp-email" 
          placeholder="Enter your email address" 
          required 
          autocomplete="off"
        />
        <input 
          type="text" 
          id="verification-otp" 
          placeholder="Enter 6-digit verification code" 
          maxlength="6" 
          required 
          autocomplete="off"
        />
        <button type="submit" id="verify-email-btn">Verify Email</button>
      </form>
      <div id="email-verification-otp-message" class="message-container"></div>
      <p><a href="#" id="resend-verification-code">Resend verification code</a></p>
      <p><a href="#" id="back-to-login-from-otp">Back to Login</a></p>
    </div>

    <!-- ✅ FORGOT PASSWORD FORMS -->
    
    <!-- Email Request Form -->
    <div class="login-container" id="forgot-email-form" style="display:none;">
      <h2>FORGOT PASSWORD</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter your email to receive an OTP</p>
      
      <div id="forgot-email-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotEmailForm" autocomplete="off">
        {% csrf_token %}
        <label for="forgot-email">Email:</label>
        <input type="email" id="forgot-email" name="email" autocomplete="email" required>
        <button type="submit" id="send-otp-btn">Send OTP</button>
      </form>
      <p><a href="#" id="back-to-login">Back to Login</a></p>
    </div>

    <!-- OTP Verification Form -->
    <div class="login-container" id="forgot-otp-form" style="display:none;">
      <h2>VERIFY OTP</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter the 6-digit code sent to your email. Please also check your email spam folder for the OTP.</p>
      
      <div id="forgot-otp-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotOtpForm" autocomplete="off">
        {% csrf_token %}
        <label for="forgot-otp">OTP Code:</label>
        <input type="text" id="forgot-otp" name="otp_code" maxlength="6" pattern="[0-9]{6}" required placeholder="123456">
        <button type="submit" id="verify-otp-btn">Verify OTP</button>
      </form>
      <p><a href="#" id="resend-otp">Resend OTP</a> | <a href="#" id="back-to-email">Change Email</a></p>
    </div>

    <!-- Password Reset Form -->
    <div class="login-container" id="forgot-reset-form" style="display:none;">
      <h2>RESET PASSWORD</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Enter your new password</p>
      
      <div id="forgot-reset-message" class="message-container" style="display:none;"></div>
      
      <form id="forgotResetForm" autocomplete="off">
        {% csrf_token %}
        <label for="new-password">New Password:</label>
        <div class="password-wrapper">
          <input type="password" id="new-password" name="new_password" required minlength="8" maxlength="16">
          <i class="fa-solid fa-eye-slash toggle-password" toggle="#new-password"></i>
        </div>
        <div id="reset-password-requirements" class="password-requirements" style="display: none;">
          <h4>Password Requirements:</h4>
          <ul>
            <li id="reset-req-length">At least 8 characters long</li>
            <li id="reset-req-uppercase">At least one uppercase letter (A-Z)</li>
            <li id="reset-req-lowercase">At least one lowercase letter (a-z)</li>
            <li id="reset-req-number">At least one number (0-9)</li>
          </ul>
        </div>
        
        <label for="confirm-new-password">Confirm Password:</label>
        <div class="password-wrapper">
          <input type="password" id="confirm-new-password" name="confirm_password" required minlength="8" maxlength="16">
          <i class="fa-solid fa-eye-slash toggle-password" toggle="#confirm-new-password"></i>
        </div>
        
        <button type="submit" id="reset-password-btn">Reset Password</button>
      </form>
    </div>
  </div>

  <script>
     const BASE_URL = "{{ BASE_URL }}";
    
    // Check if we need to show email verification form
    {% if show_verification %}
      // Auto-show email verification form for unverified users
      window.addEventListener('DOMContentLoaded', function() {
        document.getElementById('verification-email').value = "{{ user_email }}";
        document.getElementById('verification-otp-email').value = "{{ user_email }}";
        showForm('email-verification-form');
      });
    {% endif %}
     // Toggle between login and register
     document.querySelectorAll('#show-register').forEach(function(link) {
       link.onclick = function (e) {
         e.preventDefault();
         // Hide all other form containers first
         document.querySelectorAll('.form-center > div[id]').forEach(container => {
           container.style.display = 'none';
         });
         // Show main auth container
         document.getElementById('main-auth-container').style.display = 'flex';
         // Hide all login containers first
         document.querySelectorAll('.login-container[id]').forEach(container => {
           container.style.display = 'none';
         });
         // Show register form
         document.getElementById('register-form').style.display = 'block';
         // Switch to register background image
         document.getElementById('login-bg').style.display = 'none';
         document.getElementById('register-bg').style.display = 'block';
         // Clear any previous messages
         clearMessages();
       };
     });
     
     document.querySelectorAll('#show-login').forEach(function(link) {
       link.onclick = function (e) {
         e.preventDefault();
         // Hide all other form containers first
         document.querySelectorAll('.form-center > div[id]').forEach(container => {
           container.style.display = 'none';
         });
         // Show main auth container
         document.getElementById('main-auth-container').style.display = 'flex';
         // Hide all login containers first
         document.querySelectorAll('.login-container[id]').forEach(container => {
           container.style.display = 'none';
         });
         // Show login form
         document.getElementById('login-form').style.display = 'block';
         // Switch to login background image
         document.getElementById('login-bg').style.display = 'block';
         document.getElementById('register-bg').style.display = 'none';
         // Clear any previous messages
         clearMessages();
       };
     });

    // ✅ EMAIL VERIFICATION NAVIGATION
    document.getElementById('show-verification-otp').onclick = function (e) {
      e.preventDefault();
      showForm('email-verification-otp-form');
    };

     document.getElementById('back-to-login-from-verification').onclick = function (e) {
       e.preventDefault();
       // Hide all other form containers first
       document.querySelectorAll('.form-center > div[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show main auth container
       document.getElementById('main-auth-container').style.display = 'flex';
       // Hide all login containers first
       document.querySelectorAll('.login-container[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show login form
       document.getElementById('login-form').style.display = 'block';
       // Switch to login background image
       document.getElementById('login-bg').style.display = 'block';
       document.getElementById('register-bg').style.display = 'none';
       // Clear any previous messages
       clearMessages();
     };

     document.getElementById('back-to-login-from-otp').onclick = function (e) {
       e.preventDefault();
       // Hide all other form containers first
       document.querySelectorAll('.form-center > div[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show main auth container
       document.getElementById('main-auth-container').style.display = 'flex';
       // Hide all login containers first
       document.querySelectorAll('.login-container[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show login form
       document.getElementById('login-form').style.display = 'block';
       // Switch to login background image
       document.getElementById('login-bg').style.display = 'block';
       document.getElementById('register-bg').style.display = 'none';
       // Clear any previous messages
       clearMessages();
     };

    document.getElementById('resend-verification-code').onclick = function (e) {
      e.preventDefault();
      showForm('email-verification-form');
    };

    // ✅ FORGOT PASSWORD NAVIGATION
    document.getElementById('forgot-password-link').onclick = function (e) {
      e.preventDefault();
      showForm('forgot-email-form');
    };

     document.getElementById('back-to-login').onclick = function (e) {
       e.preventDefault();
       // Hide all other form containers first
       document.querySelectorAll('.form-center > div[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show main auth container
       document.getElementById('main-auth-container').style.display = 'flex';
       // Hide all login containers first
       document.querySelectorAll('.login-container[id]').forEach(container => {
         container.style.display = 'none';
       });
       // Show login form
       document.getElementById('login-form').style.display = 'block';
       // Switch to login background image
       document.getElementById('login-bg').style.display = 'block';
       document.getElementById('register-bg').style.display = 'none';
       // Clear any previous messages
       clearMessages();
     };

    document.getElementById('back-to-email').onclick = function (e) {
      e.preventDefault();
      showForm('forgot-email-form');
    };

    // Helper function to get CSRF token from the current form
    function getCSRFToken() {
      // Try to get from any visible form
      const csrfTokens = document.querySelectorAll('[name=csrfmiddlewaretoken]');
      for (let token of csrfTokens) {
        if (token.closest('form') && token.closest('form').style.display !== 'none') {
          return token.value;
        }
      }
      // Fallback to any available token
      return csrfTokens[0] ? csrfTokens[0].value : '';
    }

     // Helper function to show forms
     function showForm(formId) {
       // Hide all form containers
       document.querySelectorAll('.form-center > div[id]').forEach(container => {
         container.style.display = 'none';
       });
       
       // Show the requested form
       const targetForm = document.getElementById(formId);
       if (targetForm) {
         targetForm.style.display = 'block';
       }
       
       // Clear any previous messages
       clearMessages();
     }

    function clearMessages() {
      const messageContainers = document.querySelectorAll('.message-container');
      messageContainers.forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
      });
      // Clear registration error message
      clearRegisterError();
    }

    function showMessage(containerId, message, isError = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>`;
      container.style.display = 'block';
    }

    // Toggle password show/hide
    document.querySelectorAll('.toggle-password').forEach(function (eye) {
      eye.addEventListener('click', function () {
        const input = document.querySelector(this.getAttribute('toggle'));
        input.type = input.type === "password" ? "text" : "password";
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });
    });

    // ✅ FORGOT PASSWORD EMAIL FORM
    document.getElementById('forgotEmailForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('forgot-email').value.trim();
      const submitBtn = document.getElementById('send-otp-btn');
      
      if (!email) {
        showMessage('forgot-email-message', 'Please enter your email address.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      try {
        const formData = new FormData();
        formData.append('email', email);

        const res = await fetch(`${BASE_URL}/forgot-password/request/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-email-message', result.message, false);
          
          // Store email for next step
          window.resetEmail = email;
          
          // Show OTP form after 2 seconds
          setTimeout(() => {
            showForm('forgot-otp-form');
          }, 2000);
        } else {
          showMessage('forgot-email-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-email-message', 'Failed to send OTP. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send OTP';
      }
    });

    // ✅ FORGOT PASSWORD OTP VERIFICATION
    document.getElementById('forgotOtpForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const otpCode = document.getElementById('forgot-otp').value.trim();
      const submitBtn = document.getElementById('verify-otp-btn');
      
      if (!otpCode || otpCode.length !== 6) {
        showMessage('forgot-otp-message', 'Please enter a valid 6-digit OTP code.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const formData = new FormData();
        formData.append('email', window.resetEmail);
        formData.append('otp_code', otpCode);

        const res = await fetch(`${BASE_URL}/forgot-password/verify-otp/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-otp-message', result.message, false);
          
          // Show reset form after 1 second
          setTimeout(() => {
            showForm('forgot-reset-form');
          }, 1000);
        } else {
          showMessage('forgot-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-otp-message', 'Failed to verify OTP. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify OTP';
      }
    });

    // ✅ RESEND OTP
    document.getElementById('resend-otp').onclick = async function (e) {
      e.preventDefault();
      
      if (!window.resetEmail) {
        showForm('forgot-email-form');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('email', window.resetEmail);

        const res = await fetch(`${BASE_URL}/forgot-password/request/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();
        
        if (result.success) {
          showMessage('forgot-otp-message', 'New OTP has been sent to your email. If you don\'t see the OTP in your inbox, please check your spam or junk folder.', false);
          document.getElementById('forgot-otp').value = '';
        } else {
          showMessage('forgot-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-otp-message', 'Failed to resend OTP. Please try again.', true);
      }
    };

    // ✅ FORGOT PASSWORD RESET FORM
    document.getElementById('forgotResetForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      clearAllErrors();
      
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-new-password').value;
      const submitBtn = document.getElementById('reset-password-btn');
      
      let hasErrors = false;

      if (!newPassword) {
        showFieldError('new-password', 'Password is required');
        hasErrors = true;
      } else {
        const passwordErrors = validatePassword(newPassword);
        if (passwordErrors.length > 0) {
          showFieldError('new-password', passwordErrors.join(', '));
          hasErrors = true;
        }
      }

      if (!confirmPassword) {
        showFieldError('confirm-new-password', 'Please confirm your password');
        hasErrors = true;
      } else if (newPassword !== confirmPassword) {
        showFieldError('confirm-new-password', 'Passwords do not match');
        hasErrors = true;
      }

      if (hasErrors) {
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Resetting...';

      try {
        const formData = new FormData();
        formData.append('new_password', newPassword);
        formData.append('confirm_password', confirmPassword);

        const res = await fetch(`${BASE_URL}/forgot-password/reset/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          showMessage('forgot-reset-message', result.message + ' Redirecting to login...', false);
          
          // Clear stored email
          delete window.resetEmail;
          
          // Redirect to login after 3 seconds
          setTimeout(() => {
            document.querySelectorAll('.form-center > div[id]').forEach(container => {
              container.style.display = 'none';
            });
            document.getElementById('main-auth-container').style.display = 'flex';
            document.querySelectorAll('.login-container[id]').forEach(container => {
              container.style.display = 'none';
            });
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('login-bg').style.display = 'block';
            document.getElementById('register-bg').style.display = 'none';
            document.getElementById('forgotResetForm').reset();
            clearMessages();
          }, 3000);

        } else {
          showMessage('forgot-reset-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('forgot-reset-message', 'Failed to reset password. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
      }
    });

    // Helper functions for validation
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      let errorDiv = field.nextElementSibling;
      if (!errorDiv || !errorDiv.classList.contains('field-error')) {
        errorDiv = document.createElement('div');
        errorDiv.classList.add('field-error');
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
      }
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      field.classList.add('error');
    }

    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorDiv = field.nextElementSibling;
      if (errorDiv && errorDiv.classList.contains('field-error')) {
        errorDiv.style.display = 'none';
      }
      field.classList.remove('error');
    }

    function clearAllErrors() {
      const errorDivs = document.querySelectorAll('.field-error');
      errorDivs.forEach(div => div.style.display = 'none');
      const errorFields = document.querySelectorAll('.error');
      errorFields.forEach(field => field.classList.remove('error'));
      // Clear registration error message
      clearRegisterError();
    }

    function showRegisterError(message) {
      const errorDiv = document.getElementById('register-error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function clearRegisterError() {
      const errorDiv = document.getElementById('register-error-message');
      errorDiv.style.display = 'none';
      errorDiv.textContent = '';
    }

    function validatePassword(password) {
      const requirements = [
        { regex: /.{8,}/, message: "At least 8 characters long" },
        { regex: /[A-Z]/, message: "At least one uppercase letter" },
        { regex: /[a-z]/, message: "At least one lowercase letter" },
        { regex: /[0-9]/, message: "At least one number" }
      ];
      
      const failed = requirements.filter(req => !req.regex.test(password));
      return failed.map(req => req.message);
    }

    function validateMobile(mobile) {
      const phoneRegex = /^09\d{9}$/;
      if (!phoneRegex.test(mobile)) {
        return "Mobile number must be 11 digits and start with 09";
      }
      return null;
    }

    // Add real-time password validation with visual feedback
    document.getElementById('reg-password1').addEventListener('input', function(e) {
      const password = e.target.value;
      const requirementsDiv = document.getElementById('password-requirements');
      
      if (password.length > 0) {
        requirementsDiv.style.display = 'block';
        
        // Check each requirement
        const lengthReq = document.getElementById('req-length');
        const uppercaseReq = document.getElementById('req-uppercase');
        const lowercaseReq = document.getElementById('req-lowercase');
        const numberReq = document.getElementById('req-number');
        
        // Length check
        if (password.length >= 8) {
          lengthReq.classList.add('valid');
        } else {
          lengthReq.classList.remove('valid');
        }
        
        // Uppercase check
        if (/[A-Z]/.test(password)) {
          uppercaseReq.classList.add('valid');
        } else {
          uppercaseReq.classList.remove('valid');
        }
        
        // Lowercase check
        if (/[a-z]/.test(password)) {
          lowercaseReq.classList.add('valid');
        } else {
          lowercaseReq.classList.remove('valid');
        }
        
        // Number check
        if (/[0-9]/.test(password)) {
          numberReq.classList.add('valid');
        } else {
          numberReq.classList.remove('valid');
        }
      } else {
        requirementsDiv.style.display = 'none';
      }
    });

    document.getElementById('reg-password1').addEventListener('focus', function(e) {
      const password = e.target.value;
      if (password.length > 0) {
        document.getElementById('password-requirements').style.display = 'block';
      }
    });

    document.getElementById('reg-password1').addEventListener('blur', function(e) {
      const password = e.target.value;
      const passwordErrors = validatePassword(password);
      
      if (password.length === 0) {
        document.getElementById('password-requirements').style.display = 'none';
      }
      
      if (passwordErrors.length > 0 && password.length > 0) {
        showFieldError('reg-password1', passwordErrors.join(', '));
      } else {
        clearFieldError('reg-password1');
      }
    });

    document.getElementById('reg-password2').addEventListener('input', function(e) {
      const password = document.getElementById('reg-password1').value;
      const confirmPassword = e.target.value;
      
      if (confirmPassword && password !== confirmPassword) {
        showFieldError('reg-password2', 'Passwords do not match');
      } else {
        clearFieldError('reg-password2');
      }
    });

    document.getElementById('reg-mobile').addEventListener('input', function(e) {
      const mobile = e.target.value;
      const mobileError = validateMobile(mobile);
      
      if (mobile && mobileError) {
        showFieldError('reg-mobile', mobileError);
      } else {
        clearFieldError('reg-mobile');
      }
    });

    // Clear terms error when checkbox is checked
    document.getElementById('terms-checkbox').addEventListener('change', function(e) {
      if (e.target.checked) {
        clearRegisterError();
      }
    });

    // Add real-time password validation for reset password form
    document.getElementById('new-password').addEventListener('input', function(e) {
      const password = e.target.value;
      const requirementsDiv = document.getElementById('reset-password-requirements');
      
      if (password.length > 0) {
        requirementsDiv.style.display = 'block';
        
        // Check each requirement
        const lengthReq = document.getElementById('reset-req-length');
        const uppercaseReq = document.getElementById('reset-req-uppercase');
        const lowercaseReq = document.getElementById('reset-req-lowercase');
        const numberReq = document.getElementById('reset-req-number');
        
        // Length check
        if (password.length >= 8) {
          lengthReq.classList.add('valid');
        } else {
          lengthReq.classList.remove('valid');
        }
        
        // Uppercase check
        if (/[A-Z]/.test(password)) {
          uppercaseReq.classList.add('valid');
        } else {
          uppercaseReq.classList.remove('valid');
        }
        
        // Lowercase check
        if (/[a-z]/.test(password)) {
          lowercaseReq.classList.add('valid');
        } else {
          lowercaseReq.classList.remove('valid');
        }
        
        // Number check
        if (/[0-9]/.test(password)) {
          numberReq.classList.add('valid');
        } else {
          numberReq.classList.remove('valid');
        }
      } else {
        requirementsDiv.style.display = 'none';
      }
    });

    document.getElementById('new-password').addEventListener('focus', function(e) {
      const password = e.target.value;
      if (password.length > 0) {
        document.getElementById('reset-password-requirements').style.display = 'block';
      }
    });

    document.getElementById('new-password').addEventListener('blur', function(e) {
      const password = e.target.value;
      const passwordErrors = validatePassword(password);
      
      if (password.length === 0) {
        document.getElementById('reset-password-requirements').style.display = 'none';
      }
      
      if (passwordErrors.length > 0 && password.length > 0) {
        showFieldError('new-password', passwordErrors.join(', '));
      } else {
        clearFieldError('new-password');
      }
    });

    document.getElementById('confirm-new-password').addEventListener('input', function(e) {
      const password = document.getElementById('new-password').value;
      const confirmPassword = e.target.value;
      
      if (confirmPassword && password !== confirmPassword) {
        showFieldError('confirm-new-password', 'Passwords do not match');
      } else {
        clearFieldError('confirm-new-password');
      }
    });

     // Validate and submit register form
    document.getElementById('registerForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      clearAllErrors();

      const firstname = document.getElementById('reg-firstname').value.trim();
      const lastname = document.getElementById('reg-lastname').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const mobile = document.getElementById('reg-mobile').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password1').value;
      const password2 = document.getElementById('reg-password2').value;
      const submitBtn = document.getElementById('register-btn');

      let hasErrors = false;

      // Validate required fields
      if (!firstname) {
        showFieldError('reg-firstname', 'First name is required');
        hasErrors = true;
      }
      if (!lastname) {
        showFieldError('reg-lastname', 'Last name is required');
        hasErrors = true;
      }
      if (!username) {
        showFieldError('reg-username', 'Username is required');
        hasErrors = true;
      } else if (username.length < 6 || username.length > 12) {
        showFieldError('reg-username', 'Username must be 6 to 12 characters long');
        hasErrors = true;
      }
      if (!email) {
        showFieldError('reg-email', 'Email is required');
        hasErrors = true;
      }
      if (!password) {
        showFieldError('reg-password1', 'Password is required');
        hasErrors = true;
      } else {
        const passwordErrors = validatePassword(password);
        if (passwordErrors.length > 0) {
          showFieldError('reg-password1', passwordErrors.join(', '));
          hasErrors = true;
        }
      }
      if (password !== password2) {
        showFieldError('reg-password2', 'Passwords do not match');
        hasErrors = true;
      }
      if (mobile && validateMobile(mobile)) {
        showFieldError('reg-mobile', validateMobile(mobile));
        hasErrors = true;
      }

      // Check terms and policy checkbox
      const termsCheckbox = document.getElementById('terms-checkbox');
      if (!termsCheckbox.checked) {
        showRegisterError('Please agree to the Terms and Policy and Data Privacy to continue.');
        hasErrors = true;
      }

      if (hasErrors) {
        return;
      }

      // Enable loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';

      try {
        const res = await fetch(`${BASE_URL}/signup/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            first_name: firstname, 
            last_name: lastname, 
            username, 
            mobile, 
            email, 
            password 
          })
        });

        const result = await res.json();

        if (res.status === 201) {
          if (result.needs_verification) {
            alert("✅ " + result.message);
            document.getElementById('registerForm').reset();
            clearAllErrors();
            // Pre-fill email for verification
            document.getElementById('verification-email').value = email;
            document.getElementById('verification-otp-email').value = email;
            showForm('email-verification-otp-form');
          } else {
            alert("✅ Registration successful!");
            document.getElementById('registerForm').reset();
            clearAllErrors();
            document.getElementById('show-login').click();
          }
        } else {
          // Handle server validation errors
          if (result.errors) {
            for (const [field, message] of Object.entries(result.errors)) {
              const fieldMap = {
                'first_name': 'reg-firstname',
                'last_name': 'reg-lastname',
                'username': 'reg-username',
                'email': 'reg-email',
                'password': 'reg-password1',
                'mobile': 'reg-mobile'
              };
              const fieldId = fieldMap[field];
              if (fieldId) {
                showFieldError(fieldId, message);
              }
            }
          } else {
            alert("❌ " + (result.message || "Registration failed."));
          }
        }
      } catch (err) {
        console.error("Network error:", err);
        alert("❌ Registration failed due to server/network error.");
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Register';
      }
    });

    // ✅ EMAIL VERIFICATION REQUEST FORM
    document.getElementById('emailVerificationForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('verification-email').value.trim();
      const submitBtn = document.getElementById('send-verification-btn');
      
      if (!email) {
        showMessage('email-verification-message', 'Please enter your email address.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      try {
        const formData = new FormData();
        formData.append('email', email);

        const res = await fetch(`${BASE_URL}/email-verification/request/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ email })
        });

        const result = await res.json();

        if (result.success) {
          showMessage('email-verification-message', result.message, false);
          
          // Pre-fill email for OTP form
          document.getElementById('verification-otp-email').value = email;
          
          // Show OTP form after 2 seconds
          setTimeout(() => {
            showForm('email-verification-otp-form');
          }, 2000);
        } else {
          showMessage('email-verification-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('email-verification-message', 'Failed to send verification code. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Verification Code';
      }
    });

    // ✅ EMAIL VERIFICATION OTP FORM
    document.getElementById('emailVerificationOtpForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const email = document.getElementById('verification-otp-email').value.trim();
      const otpCode = document.getElementById('verification-otp').value.trim();
      const submitBtn = document.getElementById('verify-email-btn');
      
      if (!email) {
        showMessage('email-verification-otp-message', 'Please enter your email address.', true);
        return;
      }
      
      if (!otpCode || otpCode.length !== 6) {
        showMessage('email-verification-otp-message', 'Please enter a valid 6-digit verification code.', true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const res = await fetch(`${BASE_URL}/email-verification/verify/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ email, otp: otpCode })
        });

        const result = await res.json();

        if (result.success) {
          showMessage('email-verification-otp-message', result.message + ' Redirecting to login...', false);

          // Redirect to login after 2 seconds
          setTimeout(() => {
            // Hide all forms
            document.querySelectorAll('.form-center > div[id]').forEach(container => {
              container.style.display = 'none';
            });
            // Show main auth container
            document.getElementById('main-auth-container').style.display = 'flex';
            // Hide all login/register forms
            document.querySelectorAll('#main-auth-container .login-container[id]').forEach(container => {
              container.style.display = 'none';
            });
            // Show login form
            document.getElementById('login-form').style.display = 'block';
            // Set background image
            document.getElementById('login-bg').style.display = 'block';
            document.getElementById('register-bg').style.display = 'none';
            clearMessages();
            
            // Clear form
            document.getElementById('emailVerificationOtpForm').reset();
          }, 2000);
        } else {
          showMessage('email-verification-otp-message', result.message, true);
        }
      } catch (err) {
        console.error("Network error:", err);
        showMessage('email-verification-otp-message', 'Verification failed. Please try again.', true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify Email';
      }
    });

    // Terms and Policy Modal
    document.getElementById('terms-link').onclick = function (e) {
      e.preventDefault();
      document.getElementById('terms-modal').style.display = 'block';
    };

    // Data Privacy Modal
    document.getElementById('privacy-link').onclick = function (e) {
      e.preventDefault();
      document.getElementById('privacy-modal').style.display = 'block';
    };

    // Close modals when clicking outside or on close button
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.modal-close').forEach(function(closeBtn) {
        closeBtn.onclick = function(e) {
          e.preventDefault();
          this.closest('.modal').style.display = 'none';
        };
      });

      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };
    });
  </script>

  <!-- Terms and Policy Modal -->
  <div id="terms-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2>TERMS AND POLICY</h2>
      <div class="modal-body">
        <p>Nike's Catering Services requires a minimum of ₱10,000 or 20% down payment fee for booking confirmation which must be made upon the signing of the contract. Remaining balance must be paid in full on or before the event date.</p>
        
        <p>All down payment fees made for reservations are forfeited upon cancellation. Reservation fees are non-refundable, non-transferable, and non-convertible.</p>
        
        <p>If the client needs to reschedule the reservation date due to unforeseen events or circumstances, the client must provide us with as much early notice as possible of the rebooking. Rebooking and/or damage fees may apply.</p>
        
        <p>Corkage fees and caterer's bond at the venue will be charged to the client. If the selected venue of the client provides tables and chairs, no reduction will be applied to the overall package.</p>
        
        <p>The client shall be solely responsible for securing all the necessary permits, gate passes, authorization, and clearances necessary for the caterer to effectively set up its equipment and paraphernalia at the venue.</p>
        
        <p>The caterer requires at least 4-5 hours for ingress depending on the required styling and design, and 3-4 hours for egress.</p>
        
        <p>Additional charges such as transportation or trucking fees may apply, if the selected venue is not within Marilao-Meycauayan.</p>
        
        <p>Food tasting is only available upon request or by schedule. The selection of dishes is subject to availability.</p>
        
        <p>Food not provided by the caterer may be allowed, but additional fees may apply.</p>
        
        <p>Catering service shall be limited to 4-5 hours starting from the program time. Overtime fees may apply.</p>
      </div>
    </div>
  </div>

  <!-- Data Privacy Modal -->
  <div id="privacy-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2>DATA PRIVACY</h2>
      <div class="modal-body">
        <h3>Nike's Catering Services – Data Privacy Policy</h3>
        
        <h3>1. Introduction</h3>
        <p>At Nike's Catering Services, we are committed to protecting the privacy of our clients and ensuring that any personal data collected is handled with care and in compliance with applicable data privacy laws. This policy explains what personal information we collect, how we use it, and your rights in relation to that information.</p>
        
        <h3>2. Types of Personal Data Collected</h3>
        <p>We collect and process the following personal data:</p>
        <ul>
          <li>Name of client</li>
          <li>Email address</li>
          <li>Phone number</li>
          <li>Venue</li>
          <li>Event details (name of celebrant, type of event, preferences)</li>
          <li>Payment information</li>
          <li>Photos or videos taken during the event (if applicable)</li>
        </ul>
        
        <h3>3. Purpose of Data Collection</h3>
        <p>Personal data is collected for the following purposes:</p>
        <ul>
          <li>Booking and confirming catering services</li>
          <li>Event planning and coordination</li>
          <li>Processing payments</li>
          <li>Marketing (with client consent)</li>
          <li>Internal record-keeping</li>
          <li>Customer service follow-ups</li>
        </ul>
        
        <h3>4. How Data is Collected</h3>
        <p>We collect personal data through the following means:</p>
        <ul>
          <li>Email or phone communication</li>
          <li>Booking via Web or Mobile platforms</li>
          <li>In-person consultations</li>
        </ul>
        
        <h3>5. How Data is Used</h3>
        <p>We use personal data in order to:</p>
        <ul>
          <li>Provide the agreed catering and event services</li>
          <li>Personalize and enhance the client experience</li>
          <li>Conduct internal analysis for service improvement</li>
          <li>Send updates regarding the client's booked event</li>
        </ul>
        
        <h3>6. Data Sharing and Disclosure</h3>
        <p>We may share personal data only with:</p>
        <ul>
          <li>Event Coordinators for planning and managing the event</li>
          <li>Payment processors to complete transactions</li>
          <li>Relevant authorities, if required by law</li>
        </ul>
        <p>We do not sell or disclose your personal information to third parties for marketing purposes.</p>
        
        <h3>7. Data Storage and Security</h3>
        <p>Personal data is stored in secure databases with appropriate technical measures, including encrypted communication, to prevent unauthorized access.</p>
        <p>Access to personal data is limited to:</p>
        <ul>
          <li>Business owner</li>
          <li>Event Coordinator (only during the preparation and execution of the event)</li>
        </ul>
        
        <h3>8. Retention of Data</h3>
        <p>We retain personal data for up to 2 years from the date of collection, unless a longer retention period is required by law. After this period, data will be securely deleted.</p>
        
        <h3>9. Rights of the Data Subject</h3>
        <p>Clients have the right to:</p>
        <ul>
          <li>Access their personal data</li>
          <li>Request corrections to inaccurate data</li>
          <li>Request deletion of their data</li>
          <li>Withdraw consent to data processing at any time</li>
          <li>Lodge complaints with the relevant data privacy authority</li>
        </ul>
        
        <h3>10. Contact Information</h3>
        <p>For any inquiries or concerns regarding this policy or the handling of your personal data, please contact us:</p>
        <p><strong>Email:</strong> nikescateringofficial@gmail.com<br>
        <strong>Phone:</strong> +63 966 200 3092 or +63 928 345 2913</p>
        
        <h3>11. Policy Updates</h3>
        <p>Nike's Catering Services reserves the right to update this Data Privacy Policy as needed. Clients will be notified of any significant changes through our website or direct communication.</p>
      </div>
    </div>
  </div>
</body>
</html>
